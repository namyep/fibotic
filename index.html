<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>fibotic v11</title>
  <style>
    :root{--accent:#667eea;--accent-2:#764ba2;--bg:#f5f7fa;--card:#fff;--font-size:16px}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;padding:0;font-family:system-ui,-apple-system,"Segoe UI",Tahoma;color:#1f2d3d;font-size:var(--font-size);background:var(--bg);direction:rtl}
    body {
 background-image: url('assets/background.webp');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      background-repeat: no-repeat;
    }
    .topbar{position:fixed;top:10px;left:10px;right:10px;height:56px;display:flex;align-items:center;justify-content:space-between;padding:6px 12px;border-radius:12px;background:linear-gradient(90deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));backdrop-filter:blur(6px);z-index:120}
    .smallBtn{background:rgba(255,255,255,0.12);border:none;padding:8px 10px;border-radius:10px;color:#fff;cursor:pointer}
    .app-wrapper{padding-top:33.33vh;min-height:100vh;display:flex;flex-direction:column}
    .menu-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:24px;max-width:600px;margin:0 auto;padding:16px;background:transparent;backdrop-filter:none;border-radius:24px 24px 0 0;box-shadow:none;flex:1;border:none;border-bottom:none}
    @media(max-width:700px){.menu-grid{grid-template-columns:repeat(2,1fr)}}
    .menu-card{background:transparent;border-radius:18px;padding:12px;box-shadow:none;transition:transform 0.2s;cursor:pointer;position:relative;z-index:2;pointer-events:auto;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;border:none;aspect-ratio:1/1}
    .menu-card img{width:100px;height:100px;object-fit:contain;filter:drop-shadow(0 4px 8px rgba(0,0,0,0.3))}
    .menu-card div:nth-child(2){font-size:14px !important;margin-top:8px !important;font-weight:700 !important; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8)}
    .menu-card .muted{display:none}
    .menu-card:hover{transform:scale(1.1)}
    .inner-page{display:none;min-height:100vh;flex-direction:column;padding:0;background:rgba(255,255,255,0.95);backdrop-filter:blur(10px);margin-top:0;border-radius:0;flex:1;position:fixed;top:0;left:0;right:0;bottom:0;z-index:500;overflow-y:auto}
    .inner-page.active{display:flex}
    .page-header{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:14px;border-radius:0;margin-bottom:12px;position:sticky;top:0;z-index:100;box-shadow:0 4px 12px rgba(0,0,0,0.1);display:flex;align-items:center;gap:12px}
    .page-header h3{margin:0;flex:1}
    .back-btn-header{background:rgba(255,255,255,0.2);border:none;color:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:4px;font-size:14px}
    .content-card{background:var(--card);padding:14px;border-radius:10px;box-shadow:0 10px 24px rgba(6,12,30,0.04);margin-bottom:12px}
    .input{padding:12px;border-radius:10px;border:1px solid #e6eef6;width:100%;font-size:1rem}
    .btn-primary{padding:12px 16px;border-radius:10px;border:none;background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;cursor:pointer}
    .modal-cancel{background:#95a5a6;color:#fff;padding:10px;border-radius:10px;border:none;cursor:pointer}
    .back-button-container{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);width:calc(100% - 48px);max-width:500px;padding:0;z-index:200}
    .btn-back{width:100%;padding:16px;border-radius:16px;border:1px solid rgba(255,255,255,0.3);background:rgba(0,0,0,0.6);backdrop-filter:blur(10px);color:#fff;cursor:pointer;box-shadow:0 8px 32px rgba(0,0,0,0.3);font-weight:bold;font-size:16px}
    .toast-message{position:fixed;top:18px;left:50%;transform:translateX(-50%);padding:10px 14px;border-radius:10px;color:#fff;z-index:9999;font-weight:700}
    .muted{color:#6b7785;font-size:0.95rem}
    /* small helpers for port UI */
    .duplex-port{height:14px;border-radius:4px;background:#ecf0f1}
    /* result enhancements */
    .tar-result-title { font-size: 1.8rem; font-weight:800; margin-bottom:8px; letter-spacing:0.8px; }
    .tar-result-sub { color: #2d3b48; margin-bottom:8px; display:flex;gap:8px;align-items:center;flex-wrap:wrap }
    .tar-visual { margin-top:12px; background:transparent; border-radius:8px; }
    .reports-list-item { cursor:pointer; padding:10px; border-radius:8px; background:#fff; margin-bottom:8px; box-shadow:0 6px 14px rgba(6,12,30,0.03); }
    .thumbnail { width:72px; height:54px; object-fit:cover; border-radius:6px; margin-left:8px; cursor:pointer; border:1px solid #ddd }
    .items-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:8px }
    .color-box { padding:8px;border-radius:6px;color:#fff;font-weight:700;text-align:center }
    .cable-columns { display:grid; grid-template-columns:repeat(3,1fr); gap:12px }
    @media(max-width:900px){ .cable-columns { grid-template-columns:1fr } }
    /* approved record styling: make buttons visually disabled for regular users */
    .approved-record { /* container can stay normal but child buttons will be muted */ }
    .approved-record .smallBtn[disabled], .approved-record .btn-primary[disabled], .approved-record button[disabled] {
      opacity: 0.6;
      pointer-events: none;
      filter: grayscale(30%);
      cursor: not-allowed;
    }
    .approved-record .smallBtn[disabled]::after { content: ""; } /* ensure pseudo stability */

    /* extra helper for disabled buttons if built via attributes */
    button[disabled] { opacity: 0.6; pointer-events:none; cursor:not-allowed; filter:grayscale(30%); }

    /* Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ÛŒ ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯ Ø¬Ø¯ÛŒØ¯ */
#loginPage {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
}
.login-card {
    background: #fff;
    border-radius: 20px;
    box-shadow: 0 14px 28px rgba(0,0,0,0.25);
    position: relative;
    width: 400px;
    max-width: 95%;
    padding: 30px;
    text-align: center;
}
.login-card h2 { margin-bottom: 25px; color: #333; }
.login-card input {
    background-color: #eee;
    border: none;
    padding: 12px 15px;
    margin: 8px 0;
    width: 100%;
    border-radius: 8px;
    outline: none;
}
.login-card button {
    border-radius: 20px;
    border: 1px solid #764ba2;
    background-color: #764ba2;
    color: #FFFFFF;
    font-size: 14px;
    font-weight: bold;
    padding: 12px 45px;
    cursor: pointer;
    margin-top: 15px;
    width: 100%;
}
.login-card .switch-text {
    margin-top: 15px;
    font-size: 14px;
    color: #666;
    cursor: pointer;
}

  </style>
</head>
<body>
<div id="loginPage" style="position:fixed; top:0; left:0; right:0; bottom:0; z-index:100000; display:flex; align-items:center; justify-content:center; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
  <div style="background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); padding: 40px; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); width: 350px; text-align: center;">
    <h2 id="loginTitle" style="margin-bottom: 25px; color: #333; font-weight: bold;">Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</h2>
    
    <div style="display: flex; flex-direction: column; gap: 15px;">
      <input id="loginUser" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; transition: 0.3s;">
      <input id="loginPass" type="password" placeholder="Ø±Ù…Ø² Ø¹Ø¨ï¿½ï¿½Ø±" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 12px; outline: none; transition: 0.3s;">
      
      <!-- ADD: toggle password button (placed immediately after the loginPass input) -->
      <button id="togglePassBtn" type="button" class="smallBtn" style="margin-top:6px; width:100%; padding:10px; font-weight:700;" onclick="togglePassword()">ğŸ‘ï¸ Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø±Ù…Ø²</button>
      
      <button id="mainLoginBtn" onclick="login()" style="width: 100%; padding: 12px; border-radius: 12px; border: none; background: #764ba2; color: #fff; font-weight: bold; cursor: pointer; transition: 0.3s; box-shadow: 0 4px 15px rgba(118, 75, 162, 0.3);">ÙˆØ±ÙˆØ¯ Ø¨Ù‡ Ø­Ø³Ø§Ø¨</button>
      
      <p style="font-size: 13px; color: #666; margin-top: 10px;">Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø­Ø³Ø§Ø¨ Ø¨Ù‡ Ù…Ø¯ÛŒØ± Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</p>
    </div>
  </div>
</div>

  <div class="topbar">
    <div><button id="settingsBtn" class="smallBtn">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</button></div>
    <div id="topDateTime">ğŸ“… Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>
    <div id="userActions" style="display:flex;gap:8px;align-items:center">
      <!-- Filled by JS: username / logout -->
    </div>
  </div>

  <div class="app-wrapper">
    <div id="homePage">
      <div class="menu-grid">
        <div class="menu-card" data-page="tarYabi12"><div><img src="/assets/icons/taryabi12.webp" alt="12core"></div><div style="font-weight:700;margin-top:6px">ØªØ§Ø± ÛŒØ§Ø¨ÛŒ 12 Ú©Ø±</div><div class="muted">Ø¬Ø³ØªØ¬ÙˆÛŒ ØªØ§Ø±</div></div>
        <div class="menu-card" data-page="tarYabi6"><div><img src="/assets/icons/taryabi6.webp" alt="6core"></div><div style="font-weight:700;margin-top:6px">ØªØ§Ø± ÛŒØ§Ø¨ÛŒ 6 Ú©Ø±</div><div class="muted">Ø¬Ø³ØªØ¬ÙˆÛŒ ØªØ§Ø±</div></div>
        <div class="menu-card" data-page="tartibRang"><div><img src="/assets/icons/tartibrang.webp" alt="colors"></div><div style="font-weight:700;margin-top:6px">ØªØ±ØªÛŒØ¨ Ø±Ù†Ú¯</div><div class="muted">Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§</div></div>
        <div class="menu-card" data-page="portYabi"><div><img src="/assets/icons/portyabi.webp" alt="port"></div><div style="font-weight:700;margin-top:6px">Ù¾ÙˆØ±Øªâ€ŒÛŒØ§Ø¨ÛŒ</div><div class="muted">Ù¾Ú† Ù¾Ù†Ù„</div></div>

        <div class="menu-card" data-page="training"><div><img src="/assets/icons/training.webp" alt="training"></div><div style="font-weight:700;margin-top:6px">Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ</div><div class="muted">Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ</div></div>
        <div class="menu-card" data-page="dailyLog"><div><img src="/assets/icons/dailylog.webp" alt="log"></div><div style="font-weight:700;margin-top:6px">Ø¯ÙØªØ±Ú†Ù‡</div><div class="muted">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø±ÙˆØ²Ø§Ù†Ù‡</div></div>
        <div class="menu-card" data-page="checklist"><div><img src="/assets/icons/checklist.webp" alt="checklist"></div><div style="font-weight:700;margin-top:6px">Ú†Ú© Ù„ÛŒØ³Øª</div><div class="muted">Ù…Ø¯ÛŒØ±ÛŒØª ÙˆØ¸Ø§ÛŒÙ</div></div>
        <div class="menu-card" data-page="attendance"><div><img src="/assets/icons/attendance.webp" alt="attendance"></div><div style="font-weight:700;margin-top:6px">Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</div><div class="muted">Ø«Ø¨Øª Ø²Ù…Ø§Ù† Ø­Ø¶ÙˆØ±</div></div>

        <div class="menu-card" data-page="dailyReport"><div><img src="/assets/icons/dailyreport.webp" alt="report"></div><div style="font-weight:700;margin-top:6px">Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø±</div><div class="muted">Ø«Ø¨Øª Ùˆ Ù…Ø´Ø§Ù‡Ø¯Ù‡Ù” Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</div></div>
        <div class="menu-card" data-page="about"><div><img src="/assets/icons/about.webp" alt="about"></div><div style="font-weight:700;margin-top:6px">Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</div><div class="muted">Ø§Ø·Ù„Ø§Ø¹Ø§Øª</div></div>

        <!-- admin menu card (hidden by default, will be shown after admin login) -->
        <div id="adminMenuCard" class="menu-card" data-page="admin" style="display:none"><div><img src="/assets/icons/admin.webp" alt="admin"></div><div style="font-weight:700;margin-top:6px">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div><div class="muted">Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø¹ØªØ¨Ø§Ø± Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</div></div>

        <!-- accounting menu card (admin only) -->
        <div id="accountingMenuCard" class="menu-card" data-page="accounting" style="display:none"><div><img src="/assets/icons/accounting.webp" alt="accounting"></div><div style="font-weight:700;margin-top:6px">Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</div><div class="muted">Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ / Ø¯Ø±Ø¢Ù…Ø¯</div></div>
      </div>
    </div>

    <!-- tarYabi12 -->
    <div id="page-tarYabi12" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>ØªØ§Ø± ÛŒØ§Ø¨ÛŒ 12 Ú©Ø±</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <div class="content-card">
          <label>Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø± (1-144):</label>
          <input id="tarInput12" class="input" type="number" min="1" max="144" placeholder="Ù…Ø«Ù„Ø§Ù‹: 73" onkeydown="handleEnter(event, findTar12)">
          <div style="height:10px"></div>
          <button class="btn-primary" id="btn-find-tar12" onclick="findTar12()">Ø¬Ø³ØªØ¬Ùˆ</button>
          <div id="tarInfo12" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- tarYabi6 -->
    <div id="page-tarYabi6" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>ØªØ§Ø± ÛŒØ§Ø¨ÛŒ 6 Ú©Ø±</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <div class="content-card">
          <label>Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø± (1-72):</label>
          <input id="tarInput6" class="input" type="number" min="1" max="72" placeholder="Ù…Ø«Ù„Ø§Ù‹: 38" onkeydown="handleEnter(event, findTar6)">
          <div style="height:10px"></div>
          <button class="btn-primary" id="btn-find-tar6" onclick="findTar6()">Ø¬Ø³ØªØ¬Ùˆ</button>
          <div id="tarInfo6" style="margin-top:12px"></div>
        </div>
      </div>
    </div>

    <!-- tartibRang -->
    <div id="page-tartibRang" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>ØªØ±ØªÛŒØ¨ Ø±Ù†Ú¯ Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <div id="cableContainer" class="content-card"></div>
      </div>
    </div>

    <!-- portYabi -->
    <div id="page-portYabi" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ù¾ÙˆØ±Øª ÛŒØ§Ø¨ÛŒ</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <div class="content-card">
          <label>Ø´Ù…Ø§Ø±Ù‡ Ù¾ÙˆØ±Øª (1-144):</label>
          <input id="portInput" class="input" type="number" min="1" max="144" placeholder="Ù…Ø«Ù„Ø§Ù‹: 85" onkeydown="handleEnter(event, highlightPort)">
          <div style="height:8px"></div>
          <button class="btn-primary" id="btn-highlight-port" onclick="highlightPort()">Ù†Ù…Ø§ÛŒØ´ Ù¾ÙˆØ±Øª</button>
          <div id="portInfo" style="margin-top:12px"></div>
        </div>
        <div id="panelContainer"></div>
      </div>
    </div>

    <!-- training -->
    <div id="page-training" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <!-- Admin: Activation Code Section -->
        <div class="content-card" id="trainingAdminSection" style="display:none">
          <h4 style="color:#764ba2;margin-top:0">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</h4>
          <p class="muted">Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¬Ø¯ÛŒØ¯ Ú©Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ø±Ø§Ø¦Ù‡ Ø¯Ù‡ÛŒØ¯:</p>
          <input id="activationCode" class="input" placeholder="Ú©Ø¯ ÙØ¹Ø§Ù„Ø³Ø§Ø²ÛŒ (Ù…Ø«Ù„Ø§Ù‹: FIBER2025)">
          <div style="height:8px"></div>
          <button class="btn-primary" id="btn-activate-training">ğŸ”“ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
          <div id="activationStatus" style="margin-top:10px"></div>
        </div>

        <!-- Training Levels Display -->
        <div id="trainingLevels"></div>
      </div>
    </div>

    <!-- Attendance -->
    <div id="page-attendance" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</h3>
        <!-- Add-person removed per request -->
      </div>
      <div class="page-content" style="padding:12px">
        <div class="content-card">
          <label>Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙØ±:</label>
          <select id="personSelect" class="input"><option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option></select>
          <div style="height:8px"></div>
          <label>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:</label>
          <input id="projectName" class="input" placeholder="Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯">
          <div style="height:8px"></div>
          <label>Ø´Ø±Ø­ Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:</label>
          <textarea id="workDescription" class="input" style="min-height:100px"></textarea>
  <div class="form-group" style="margin-top:15px; border:2px solid var(--accent); padding:10px; border-radius:12px; background: rgba(255,255,255,0.5);">
  <label style="color:var(--accent-2); font-weight:bold; display:block; margin-bottom:10px;">ğŸ“Š Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù† (Ú©Ø§Ø¨Ù„ Ùˆ ØªØ§Ø±)</label>
  <div id="fusion-matrix-container"></div> <div style="margin-top:10px; text-align:center;">
    <button type="button" onclick="addFusionMatrix()" style="background:var(--accent-2); color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">+ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§ØªØ±ÛŒØ³ Ø¬Ø¯ÛŒØ¯</button>
  </div>
</div>




          <div style="margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="shareWithAdmin"> Ø§Ø´ØªØ±Ø§Ú© Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ Ø¨Ø§ Ù…Ø¯ÛŒØ±</label>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <div style="flex:1"><label>Ø³Ø§Ø¹Øª ÙˆØ±ÙˆØ¯:</label><input id="entryTime" type="time" class="input"></div>
            <div style="flex:1"><label>Ø³Ø§Ø¹Øª Ø®Ø±ÙˆØ¬:</label><input id="exitTime" type="time" class="input"></div>
          </div>
          <div style="height:12px"></div>
          <div style="display:flex;gap:8px">
            <button id="saveAttendanceBtn" class="btn-primary">âœ… Ø«Ø¨Øª Ø­Ø¶ÙˆØ±</button>
            <button class="btn-primary" style="background:linear-gradient(90deg,#f39c12,#e67e22)" id="btn-calc-hours">ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ</button>
          </div>
        </div>
<!-- Ø®Ù„Ø§ØµÙ‡ Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ú©Ø§Ø±Ø¨Ø± -->
<div id="userSummaryCard" class="content-card" style="display:none;margin-bottom:12px">
  <h4 style="margin-top:0;margin-bottom:12px;color:#2c3e50">ğŸ“Š Ø®Ù„Ø§ØµÙ‡Ù” Ù…Ø·Ø§Ù„Ø¨Ø§Øª Ø´Ù…Ø§</h4>
  <div style="overflow-x:auto">
    <table style="width:100%;border-collapse:collapse;text-align:center;font-size:14px">
      <thead>
        <tr style="background:linear-gradient(90deg,#667eea,#764ba2);color:#fff">
          <th style="padding:12px;border:1px solid #ddd">Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ</th>
          <th style="padding:12px;border:1px solid #ddd">Ù…Ø¬Ù…ÙˆØ¹ Ø­Ù‚ÙˆÙ‚</th>
          <th style="padding:12px;border:1px solid #ddd">Ù…Ø·Ø§Ù„Ø¨Ù‡ Ø¨Ø§Ù‚ÛŒÙ…Ø§Ù†Ø¯Ù‡</th>
        </tr>
      </thead>
      <tbody>
        <tr style="background:#f8f9fa">
          <td id="summaryHours" style="padding:12px;border:1px solid #ddd;font-weight:800">â€”</td>
          <td id="summarySalary" style="padding:12px;border:1px solid #ddd;font-weight:800">â€”</td>
          <td id="summaryRemaining" style="padding:12px;border:1px solid #ddd;font-weight:800;color:#e74c3c">â€”</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
  <input id="searchAttendance" class="input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†Ø§Ù…ØŒ Ù¾Ø±ÙˆÚ˜Ù‡ ÛŒØ§ ØªÙˆØ¶ÛŒØ­Ø§Øª..." style="flex:1" oninput="searchAttendance()" onkeydown="handleSearchEnter(event)">
  <button class="btn-primary" onclick="clearSearchAttendance()" style="padding:12px 16px;min-width:50px">ğŸ”</button>
</div>
<h4 style="text-align:center;margin:12px 0">Ø³ÙˆØ§Ø¨Ù‚ Ø­Ø¶ÙˆØ±</h4>
<div id="attendanceList"></div>
      </div>
    </div>

    <!-- Reports -->
    <div id="page-dailyReport" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø± Ø±ÙˆØ²Ø§Ù†Ù‡</h3>
      </div>
      <div class="page-content">
        <div class="content-card" style="display:flex;gap:8px">
          <button class="btn-primary" id="btn-open-new-report">â• Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø¬Ø¯ÛŒØ¯</button>
        </div>
    <div style="display:flex;gap:8px;justify-content:center;margin-bottom:12px">
  <button class="btn-primary" id="btn-export-reports-excel" onclick="exportReportsToExcel()" style="background:linear-gradient(90deg,#27ae60,#229954)">ğŸ“Š Ø¯Ø±ÛŒØ§ÙØª Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„</button>
</div>
<div class="content-card" style="display:flex;align-items:center;gap:8px">
          <input id="searchReports" class="input" placeholder="Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø´Ù…Ø§Ø±Ù‡ Ø·Ø±Ø­ ÛŒØ§ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡..." style="flex:1" oninput="searchReports()" onkeydown="handleSearchEnter(event)">
          <button class="btn-primary" onclick="clearSearchReports()" style="padding:12px 16px;min-width:50px">ğŸ”</button>
        </div>

<h4 style="text-align:center;margin:12px 0">Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</h4>
<div id="reportsList"></div>
      </div>
    </div>

    <!-- Accounting page (admin only) -->
  <div class="content-card" id="fibotic-backup-section" style="display:none;">
  <h4>ğŸ’¾ Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ Ùˆ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ (ÙÙ‚Ø· Ù…Ø¯ÛŒØ±)</h4>
  <div id="fibotic-backup-info" style="font-size:13px;color:#666;margin-bottom:6px"></div>
  <button class="btn-primary" type="button" onclick="downloadAdminBackup()">ğŸ“© Ù¾Ø´ØªÛŒØ¨Ø§Ù†â€ŒÚ¯ÛŒØ±ÛŒ (Ø¯Ø§Ù†Ù„ÙˆØ¯ ÙØ§ÛŒÙ„)</button>
  <input id="fibotic-restore-file" type="file" accept="application/json" style="display:none" onchange="restoreAdminBackupFile(event)">
  <button class="smallBtn" type="button" onclick="document.getElementById('fibotic-restore-file').click()">ğŸ“‚ Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§Ø² ÙØ§ÛŒÙ„</button>
</div>
  
    <div id="page-accounting" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</h3>
      </div>
      <div class="page-content" style="padding:12px">
        <div class="content-card" style="display:flex;flex-direction:column;gap:12px;max-width:520px;margin:0 auto">
          <div style="font-weight:800">Ø¹Ù…Ù„ÛŒØ§Øª Ø­Ø³Ø§Ø¨Ø¯Ø§Ø±ÛŒ</div>
          <p class="muted">Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ù‚Ø§Ø¨Ù„ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø§Ø³Øª.</p>
          <div style="display:flex;gap:8px;flex-direction:column">
            <button id="btn-account-price" class="btn-primary">ğŸ’° Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</button>
            <button id="btn-account-income" class="btn-primary" style="background:linear-gradient(90deg,#27ae60,#229954)">ğŸ’¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯</button>
            <!-- ADD: Salaries button -->
            <button id="btn-account-salaries" class="btn-primary" style="background:linear-gradient(90deg,#8e44ad,#6a1b9a)">ğŸ‘¥ Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</button>
          </div>
        </div>
      </div>
    </div>

    <!-- daily log -->
    <div id="page-dailyLog" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ø¯ÙØªØ±Ú†Ù‡</h3>
      </div>
      <div class="page-content">
        <div class="content-card">
          <label>ØªØ§Ø±ÛŒØ®:</label><input id="dateInput" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: 14/01/1403">
          <div style="height:8px"></div>
          <label>Ù…ØªÙ†:</label><input id="textInput" class="input">
          <div style="height:8px"></div>
          <div style="display:flex;gap:8px"><button id="saveTextBtn" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button></div>
        </div>
        <div id="logsList"></div>
      </div>
    </div>

    <!-- checklist -->
    <div id="page-checklist" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ú†Ú© Ù„ÛŒØ³Øª</h3>
      </div>
      <div class="page-content">
        <div class="content-card">
          <label>Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯:</label><input id="checklistInput" class="input" placeholder="Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯...">
          <div style="height:8px"></div>
          <button id="addChecklistBtn" class="btn-primary">Ø§ÙØ²ÙˆØ¯Ù†</button>
        </div>
        <div id="checklistItems"></div>
      </div>
    </div>

    <!-- settings -->
    <div id="page-settings" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h3>
      </div>
      <div class="page-content">
        <div class="content-card">
          <h4>Ø¸Ø§Ù‡Ø±</h4>
          <label>Ø§Ù†Ø¯Ø§Ø²Ù‡ ÙÙˆÙ†Øª:
            <select id="fontSize" class="input">
              <option value="small">Ú©ÙˆÚ†Ú©</option>
              <option value="medium" selected>Ù…ØªÙˆØ³Ø·</option>
              <option value="large">Ø¨Ø²Ø±Ú¯</option>
            </select>
          </label>
        </div>

        <div class="content-card">
          <h4>Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ø§Øª (Ù…Ø­Ø§ÙØ¸Øªâ€ŒØ´Ø¯Ù‡)</h4>
          <p class="muted">Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ùˆ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø®Ø´ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø±Ø¯.</p>
          <div style="display:flex;gap:8px">
            <button class="btn-primary" id="btn-price">ğŸ’° Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</button>
          <button class="btn-primary" id="btn-income">ğŸ’¹ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø¯Ø±Ø¢Ù…Ø¯</button>
          </div>
        </div>

        <div class="content-card">
          <h4>Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡</h4>
          <p class="muted">Ø­Ø°Ù ØªÙ…Ø§Ù… Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª Ø§ÙˆÙ„</p>
          <button class="btn-primary" onclick="openFactoryResetModal()" style="background:linear-gradient(90deg,#e74c3c,#c0392b);width:100%">ğŸ”„ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡</button>
        </div>

        <div class="content-card">
          <h4>Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§</h4>>
          <div style="display:flex;gap:8px;align-items:center">
  <button class="btn-primary" id="btn-backup">ğŸ’¾ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ù¾Ø´ØªÛŒØ¨Ø§Ù†</button>
  <button class="btn-primary" id="btn-merge-restore">ğŸ“‚ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ (Ø§Ø¯ØºØ§Ù…ÛŒ)</button>
  <input id="mergeRestoreFile" type="file" accept="application/json" style="display:none">
</div>
<div style="margin-top:8px">
  <div id="mergeRestoreNote" class="muted" style="font-size:13px">Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØŒ Ø­ØªÙ…Ø§Ù‹ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ú¯ÛŒØ±ÛŒØ¯.</div>
</div>
<div style="margin-top:8px">
  <div id="mergeRestoreNote" class="muted" style="font-size:13px">Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒØŒ Ø­ØªÙ…Ø§Ù‹ Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¨Ú¯ÛŒØ±ÛŒØ¯.</div>
</div>
        </div>
      </div>
    </div>

    <!-- admin page: moved here so it behaves like other pages -->
    <div id="page-admin" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±</h3>
      </div>
      <div class="page-content">
        <div class="content-card">
          <h4 style="color:#764ba2;margin-top:0">âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ùˆ Ø§Ø¹ØªØ¨Ø§Ø±</h4>
          <!-- Ø¨Ø®Ø´ Ø¬Ø¯ÛŒØ¯: ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª -->
          <div style="background:linear-gradient(135deg,#e74c3c,#c0392b);padding:15px;border-radius:12px;margin-bottom:15px;color:#fff">
            <h4 style="margin:0 0 12px 0;color:#fff">ğŸ” ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª</h4>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px">
              <div>
                <label style="font-size:12px;opacity:0.9">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯:</label>
                <input id="newAdminUser" class="input" placeholder="Ù…Ø«Ù„Ø§Ù‹: admin" value="" style="margin-top:4px">
              </div>
              <div>
                <label style="font-size:12px;opacity:0.9">Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯:</label>
                <input id="newAdminPass" type="password" class="input" placeholder="Ø±Ù…Ø² Ù‚ÙˆÛŒ" value="" style="margin-top:4px">
              </div>
            </div>
            <button id="btn-change-admin-creds" class="btn-primary" style="width:100%;background:#fff;color:#e74c3c;font-weight:800">ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯</button>
            <div id="adminCredsStatus" style="margin-top:8px;font-size:13px"></div>
          </div>
          <!-- Admin: calc hours button -->
          <div style="display:flex;gap:8px;margin-bottom:10px">
  <button id="btn-admin-calc-hours" class="btn-primary">ğŸ“Š Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ</button>
  <button class="btn-primary" style="background:linear-gradient(90deg,#2d9cdb,#1e88e5);font-weight:700" onclick="openPage('approvedShares')">ğŸ‘ï¸ Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªÙ…Ø§Ù… Ø­Ø¶ÙˆØ±Ù‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯Ø´Ø¯Ù‡</button>
</div>
          <div style="background: #f8f9ff; padding: 15px; border-radius: 15px; margin-bottom: 10px;">
            <p style="font-size: 13px; color: #666; margin-bottom: 10px;">Ø³Ø§Ø®Øª Ø­Ø³Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯:</p>
            <input id="newUserName" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none;">
            <input id="newUserPass" placeholder="Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none;">
            <input id="newUserDays" type="number" placeholder="ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² ï¿½ï¿½Ø¹ØªØ¨Ø§Ø± (Ù…Ø«Ù„Ø§Ù‹ 30)" style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 10px; margin-bottom: 10px; outline: none;">
            <button id="adminCreateUserBtn" style="width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 10px; font-weight: bold; cursor: pointer;">+ Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ</button>
          </div>

          <div style="overflow-x: auto; margin-bottom: 12px;">
            <table style="width: 100%; border-collapse: collapse; font-size: 13px; text-align: center;">
              <thead>
                <tr style="background: #eee;">
                  <th style="padding: 10px; border: 1px solid #ddd;">Ú©Ø§Ø±Ø¨Ø±</th>
                  <th style="padding: 10px; border: 1px solid #ddd;">Ø±Ù…Ø²</th>
                  <th style="padding: 10px; border: 1px solid #ddd;">Ø§Ø¹ØªØ¨Ø§Ø±</th>
                  <th style="padding: 10px; border: 1px solid #ddd;">Ø­Ø°Ù</th>
                </tr>
              </thead>
              <tbody id="userTableBody">
                </tbody>
            </table>
          </div>
          <h4 style="margin-top:8px">Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø§Ø´ØªØ±Ø§Ú© Ø­Ø¶ÙˆØ±</h4>
<div id="pendingShares" style="margin-bottom:12px"></div>
<h4 style="margin-top:8px">Ø§Ø´ØªØ±Ø§Ú©â€ŒÙ‡Ø§ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</h4>
<div id="approvedShares"></div>

        </div>
      </div>
    </div>
<!-- Approved Shares Page -->
<div id="page-approvedShares" class="inner-page" aria-hidden="true">
  <div class="page-header">
    <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
    <h3>Ø­Ø¶ÙˆØ±Ù‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡</h3>
  </div>
  <div class="page-content" style="padding:12px">
    <div class="content-card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
        <div style="font-weight:800">ğŸ“‹ Ù„ÛŒØ³Øª Ø­Ø¶ÙˆØ±Ù‡Ø§ÛŒ ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡</div>
        <button id="exportApprovedSharesBtn" class="smallBtn" onclick="exportApprovedSharesCSV()">â¬‡ï¸ CSV</button>
      </div>
      <div id="approvedSharesPageList" style="margin-top:12px"></div>
    </div>
  </div>
</div>
    <!-- about -->
    <div id="page-about" class="inner-page" aria-hidden="true">
      <div class="page-header">
        <button class="back-btn-header" onclick="goHome()">ğŸ”™ Ø¨Ø§Ø²Ú¯Ø´Øª</button>
        <h3>Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø§</h3>
      </div>
      <div class="page-content"><div class="content-card"><p>ØªÙˆØ³Ø¹Ù‡â€ŒØ¯Ù‡Ù†Ø¯Ù‡: Ù¾ÛŒÙ…Ø§Ù† Ø­Ø¨ÛŒØ¨ÛŒ</p><p>ØªÙ…Ø§Ø³: 09144099771</p></div></div>
    </div>

  </div>

<script>
/* fibotic v11 â€” updates:
   - Persian thousands formatting and date auto-format (dd/mm/yyyy) with Persian digits.
   - In payroll modal: Paid column clickable to view per-user payouts (modal + CSV export).
   - attachDateAutoFormat updated to ensure dd/mm/yyyy (2/2/4) and convert digits to Persian on blur.
   - NOTE: Additional merge-restore (non-destructive) functionality appended after main script.
*/

(function () {
  'use strict';

  const DATA_KEY = 'fibotic_app_v11';
  let allData = [];

  /* Global error handlers for easier debugging */
  window.addEventListener('error', function (e) {
    console.error('Global error', e.error || e.message || e);
    const el = document.getElementById('topDateTime');
    if (el) el.textContent = 'âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ JS â€” Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯';
    showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø§ÙˆØ§Ø§Ø³Ú©Ø±ÛŒÙ¾Øª (Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯)', '#e74c3c', 4000);
  });
  window.addEventListener('unhandledrejection', function (e) {
    console.error('Unhandled rejection', e.reason || e);
    const el = document.getElementById('topDateTime');
    if (el) el.textContent = 'âŒ Promise rejection';
    showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Promise (Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯)', '#e74c3c', 4000);
  });

  /* Utilities */
  function showMessage(text, bg = '#34495e', timeout = 2200) {
    try {
      const ex = document.querySelector('.toast-message'); if (ex) ex.remove();
      const d = document.createElement('div'); d.className = 'toast-message'; d.style.background = bg; d.textContent = text; document.body.appendChild(d);
      setTimeout(() => { d.style.opacity = '0'; setTimeout(() => d.remove(), 300); }, timeout);
    } catch (e) { console.error('showMessage error', e); }
  }
  function escapeHtml(s) { return (s || '').replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' })[m]); }

  /* expose small utils for code outside the IIFE */
  window.escapeHtml = escapeHtml;
  window.showMessage = showMessage;

  /* helper: contrast color (black/white) for readability */
  function getContrast(hex) {
    try {
      if (!hex) return '#000';
      const h = hex.replace('#', '');
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      // perceptive luminance
      const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
      return luminance > 0.6 ? '#000' : '#fff';
    } catch (e) { return '#000'; }
  }

  /* ---------- New: Persian formatting helpers ---------- */
  function toPersianDigits(input) {
    try {
      return String(input).replace(/\d/g, function(d){ return 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'[d]; });
    } catch (e) { return input; }
  }
  function persianToEnglishDigits(s) {
    try {
      if (!s) return '';
      return String(s).replace(/[Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹]/g, function(ch) {
        return 'Û°Û±Û²Û³Û´ÛµÛ¶Û·Û¸Û¹'.indexOf(ch).toString();
      });
    } catch (e) { return s; }
  }

  // Format currency with Persian digits and thousands separator. showSuffix default true (ØªÙˆÙ…Ø§Ù†)
  function formatCurrency(value, showSuffix = true) {
    try {
      const num = Number(value) || 0;
      // round to integer
      const rounded = Math.round(num);
      // try toLocaleString for fa-IR (will use Persian digits and proper separator)
      let formatted;
      try {
        formatted = rounded.toLocaleString('fa-IR');
      } catch (e) {
        // fallback: manual grouping with Arabic/Persian thousands separator 'Ù¬'
        const s = Math.abs(rounded).toString();
        let rev = s.split('').reverse();
        let withSep = '';
        for (let i=0;i<rev.length;i++) {
          if (i>0 && i%3===0) withSep = 'Ù¬' + withSep;
          withSep = rev[i] + withSep;
        }
        formatted = (rounded < 0 ? '-' : '') + toPersianDigits(withSep);
      }
      return showSuffix ? `${formatted} ØªÙˆÙ…Ø§Ù†` : `${formatted}`;
    } catch (e) {
      try { return toPersianDigits(Number(value || 0).toString()) + (showSuffix ? ' ØªÙˆÙ…Ø§Ù†' : ''); } catch (er) { return value; }
    }
  }

  // Attach auto-format behavior to date input elements (dd/mm/yyyy) with auto-inserting slashes and auto-year/month
  function attachDateAutoFormat(inputEl) {
    if (!inputEl) return;
    const currentPersianYear = (new Intl.DateTimeFormat('fa-IR', { year: 'numeric' })).format(new Date());
    const currentPersianMonth = (new Intl.DateTimeFormat('fa-IR', { month: '2-digit' })).format(new Date());
    inputEl.addEventListener('input', (e) => {
      let v = inputEl.value || '';
      // normalize Persian digits to english before processing
      v = persianToEnglishDigits(v);
      // replace dots and dashes to slash
      v = v.replace(/[.\-]/g, '/');
      // keep only digits and slashes
      v = v.replace(/[^\d\/]/g, '');
      // collapse multiple slashes
      v = v.replace(/\/+/g, '/');
      // if user typed continuous digits without slashes, insert slashes after 2 and 4 chars
      const onlyDigits = v.replace(/\//g, '');
      if (!v.includes('/') && onlyDigits.length > 2) {
        const day = onlyDigits.slice(0,2);
        const rest = onlyDigits.slice(2);
        v = day + (rest ? '/' + rest : '');
      }
      // split parts
      const parts = v.split('/');
      if (parts[0] && parts[0].length > 2) parts[0] = parts[0].slice(0,2);
      if (parts[1] && parts[1].length > 2) parts[1] = parts[1].slice(0,2);
      if (parts[2] && parts[2].length > 4) parts[2] = parts[2].slice(0,4);
      // rebuild
      const out = [];
      if (parts[0]) out.push(parts[0]);
      if (parts[1] !== undefined) out.push(parts[1]);
      if (parts[2] !== undefined) out.push(parts[2]);
      // set with Persian digits as user types
      inputEl.value = toPersianDigits(out.join('/'));
    });
    inputEl.addEventListener('blur', () => {
      let v = inputEl.value || '';
      v = persianToEnglishDigits(v);
      v = v.replace(/[^\d\/]/g, '');
      v = v.replace(/[.\-]/g, '/');
      v = v.replace(/\/+/g, '/');
      const parts = v.split('/');
      let day = parts[0] || '';
      let month = parts[1] || '';
      let year = parts[2] || '';
      // ensure two-digit day and month
      if (day.length === 1) day = '0' + day;
      if (!month) month = currentPersianMonth;
      if (month.length === 1) month = '0' + month;
      if (!year) year = currentPersianYear;
      if (year.length === 2) {
        // ambiguous: if user supplied 2-digit year, prefix with 13 (e.g., '03' -> '1403')? keep safe and use current century
        // We'll prefix with first two digits of currentPersianYear
        const prefix = String(currentPersianYear).slice(0,2);
        year = prefix + year;
      }
      // final sanitize
      day = day.slice(0,2);
      month = month.slice(0,2);
      year = year.slice(0,4);
      const final = `${day.padStart(2,'0')}/${month.padStart(2,'0')}/${year.padStart(4,'0')}`;
      inputEl.value = toPersianDigits(final);
    });
  }

  /* color definitions */
  const colors = [
    { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' }, { name: 'Ù‚Ø±Ù…Ø²', code: '#FF0000' }, { name: 'Ø³Ø¨Ø²', code: '#00FF00' },
    { name: 'Ø¢Ø¨ÛŒ', code: '#0000FF' }, { name: 'Ø²Ø±Ø¯', code: '#FFFF00' }, { name: 'Ù…Ø´Ú©ÛŒ', code: '#000000' },
    { name: 'Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ', code: '#8B4513' }, { name: 'Ø¨Ù†ÙØ´', code: '#800080' }, { name: 'Ù†Ø§Ø±Ù†Ø¬ÛŒ', code: '#FFA500' },
    { name: 'ØµÙˆØ±ØªÛŒ', code: '#FFC0CB' }, { name: 'Ø®Ø§Ú©Ø³ØªØ±ÛŒ', code: '#808080' }, { name: 'ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ', code: '#00FFFF' }
  ];
  const colors6 = [
    { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' }, { name: 'Ù‚Ø±Ù…Ø²', code: '#FF0000' }, { name: 'Ø³Ø¨Ø²', code: '#00FF00' },
    { name: 'Ø¢Ø¨ÛŒ', code: '#0000FF' }, { name: 'Ø²Ø±Ø¯', code: '#FFFF00' }, { name: 'Ù†Ø§Ø±Ù†Ø¬ÛŒ', code: '#FFA500' }
  ];
  function getColorNameByHex(hex) {
    const found = colors.concat(colors6).find(c => c.code.toLowerCase() === (hex || '').toLowerCase());
    return found ? found.name : hex;
  }

  /* helper: read FileList -> array of dataURLs */
  function readFilesAsDataURLs(fileList) {
    return new Promise((resolve) => {
      if (!fileList || fileList.length === 0) return resolve([]);
      const readers = [];
      for (let i = 0; i < fileList.length; i++) {
        const f = fileList[i];
        readers.push(new Promise((res) => {
          const fr = new FileReader();
          fr.onload = () => res(fr.result);
          fr.onerror = () => res(null);
          fr.readAsDataURL(f);
        }));
      }
      Promise.all(readers).then(results => resolve(results.filter(Boolean)));
    });
  }

  /* Data handler */
  const dataHandler = {
  onDataChanged(data) {
    allData = data || [];
    renderLogs();
    renderChecklist();
    renderAttendance();
    renderReports();
    loadPersonList();
    renderPendingShares();
    refreshUserList();
    updateUserActions();
    updateUserSummary();
  }
};

  function initDataFromStorage() {
    try { allData = JSON.parse(localStorage.getItem(DATA_KEY) || '[]'); } catch (e) { allData = []; }
    dataHandler.onDataChanged(allData);
  }

  /* safeCreate: use dataSdk.create if present, otherwise fallback */
  async function safeCreate(record) {
    try {
      if (window.dataSdk && typeof window.dataSdk.create === 'function') {
        const res = await window.dataSdk.create(record);
        if (res && res.isOk) {
          if (typeof window.dataSdk.__getAllSync === 'function') {
            try { allData = window.dataSdk.__getAllSync(); dataHandler.onDataChanged(allData); } catch (e) { }
          }
          return res;
        } else {
          return fallbackCreate(record);
        }
      } else {
        return fallbackCreate(record);
      }
    } catch (err) {
      console.warn('safeCreate error -> fallback', err);
      return fallbackCreate(record);
    }
  }
  function fallbackCreate(record) {
    try {
      const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]');
      if (!record.__backendId) record.__backendId = 'local-' + Date.now() + '-' + Math.random().toString(36).slice(2);
      arr.push(record);
      localStorage.setItem(DATA_KEY, JSON.stringify(arr));
      allData = arr;
      if (dataHandler && typeof dataHandler.onDataChanged === 'function') dataHandler.onDataChanged(allData);
      return { isOk: true, data: record };
    } catch (e) { console.error('fallbackCreate error', e); return { isOk: false, error: e }; }
  }

  /* safeUpdate */
  async function safeUpdate(record) {
    try {
      if (window.dataSdk && typeof window.dataSdk.update === 'function') {
        const res = await window.dataSdk.update(record);
        if (res && res.isOk) {
          if (typeof window.dataSdk.__getAllSync === 'function') {
            try { allData = window.dataSdk.__getAllSync(); dataHandler.onDataChanged(allData); } catch (e) { }
          }
          return res;
        } else throw res.error || new Error('update failed');
      } else {
        const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]');
        const idx = arr.findIndex(x => x.__backendId === record.__backendId);
        if (idx !== -1) arr[idx] = record;
        localStorage.setItem(DATA_KEY, JSON.stringify(arr));
        allData = arr;
        if (dataHandler && typeof dataHandler.onDataChanged === 'function') dataHandler.onDataChanged(allData);
        return { isOk: true };
      }
    } catch (e) {
      console.error('safeUpdate error', e);
      return { isOk: false, error: e };
    }
  }

  /* topbar */
  function updateTopbar() {
    try {
      const el = document.getElementById('topDateTime'); if (!el) return;
      const now = new Date(); const dateStr = now.toLocaleDateString('fa-IR', { year: 'numeric', month: 'long', day: 'numeric' }); const timeStr = now.toLocaleTimeString('fa-IR', { hour: '2-digit', minute: '2-digit' });
      el.innerHTML = `ğŸ“… ${dateStr} &nbsp; ğŸ• ${timeStr}`;
    } catch (e) { console.error('updateTopbar error', e); }
  }
  setInterval(updateTopbar, 1000);

  /* user actions in topbar (show username / logout) */
  function updateUserActions() {
    try {
      const container = document.getElementById('userActions');
      if (!container) return;
      container.innerHTML = '';
      const logged = localStorage.getItem('fibotic_logged_in');
      const role = localStorage.getItem('fibotic_role');
      if (logged) {
        const nameSpan = document.createElement('div');
        nameSpan.style.color = '#fff';
        nameSpan.style.fontWeight = '700';
        nameSpan.textContent = (role === 'admin') ? `ğŸ‘‘ ${logged}` : `${logged}`;
        const outBtn = document.createElement('button');
        outBtn.className = 'smallBtn';
        outBtn.textContent = 'âï¸ Ø®Ø±ÙˆØ¬';
        outBtn.onclick = logout;
        container.appendChild(nameSpan);
        container.appendChild(outBtn);
        // show admin menu if admin
        const adminMenu = document.getElementById('adminMenuCard');
        if (adminMenu) adminMenu.style.display = (role === 'admin') ? 'flex' : 'none';
        const accMenu = document.getElementById('accountingMenuCard');
        if (accMenu) accMenu.style.display = (role === 'admin') ? 'flex' : 'none';
      } else {
        // no user logged in
        const loginHint = document.createElement('div');
        loginHint.style.color = '#fff';
        loginHint.style.opacity = '0.9';
        loginHint.textContent = 'ğŸ”’ Ø®Ø§Ø±Ø¬';
        container.appendChild(loginHint);
        const adminMenu = document.getElementById('adminMenuCard');
        if (adminMenu) adminMenu.style.display = 'none';
        const accMenu = document.getElementById('accountingMenuCard');
        if (accMenu) accMenu.style.display = 'none';
      }
    } catch (e) { console.error('updateUserActions error', e); }
  }

  function logout() {
    localStorage.removeItem('fibotic_logged_in');
    localStorage.removeItem('fibotic_role');
    // hide admin menu
    const adminMenu = document.getElementById('adminMenuCard');
    if (adminMenu) adminMenu.style.display = 'none';
    const accMenu = document.getElementById('accountingMenuCard');
    if (accMenu) accMenu.style.display = 'none';
    // show login overlay
    const loginPage = document.getElementById('loginPage');
    if (loginPage) loginPage.style.display = 'flex';
    showMessage('âœ… Ø§Ø² Ø­Ø³Ø§Ø¨ Ø®Ø§Ø±Ø¬ Ø´Ø¯ÛŒØ¯', '#e67e22');
    updateUserActions();
  }

  /* navigation with admin protection */function openPage(id) {
    try {
      if (id === 'admin' || id === 'accounting' || id === 'approvedShares') {
        const role = localStorage.getItem('fibotic_role');
        if (role !== 'admin') {
          showMessage('âš ï¸ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙØ­Ù‡ ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ± Ø§Ø³Øª', '#e74c3c');
          return;
        }
      }

         document.getElementById('homePage').style.display = 'none';
      document.querySelectorAll('.inner-page').forEach(p => { p.classList.remove('active'); p.style.display = 'none'; p.setAttribute('aria-hidden', 'true'); });
      const page = document.getElementById('page-' + id);
      if (page) {
        page.classList.add('active'); page.style.display = 'flex'; page.setAttribute('aria-hidden', 'false');
        if (id === 'attendance') { loadPersonList(); updateUserSummary(); }
        if (id === 'tartibRang') displayCableColors();
        if (id === 'portYabi') setupPorts();
        if (id === 'dailyLog') renderLogs();
        if (id === 'admin') { refreshUserList(); renderAdminShares(); }
        if (id === 'approvedShares') renderApprovedShares();
        page.scrollTop = 0;
      } else goHome();
    } catch (e) { console.error('openPage error', e); }
  }
  function goHome() {
    try {
      document.querySelectorAll('.inner-page').forEach(p => { p.classList.remove('active'); p.style.display = 'none'; p.setAttribute('aria-hidden', 'true'); });
      document.getElementById('homePage').style.display = 'block';
      // Ø±ÙØ±Ø´ ØµÙØ­Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² 300ms
      setTimeout(() => {
        location.reload();
      }, 300);
    } catch (e) { console.error('goHome error', e); }
  }
  window.openPage = openPage; window.goHome = goHome;

  /* ---------- Factory Reset ---------- */
  function openFactoryResetModal() {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:11000;overflow-y:auto;padding:20px';
    
    const content = document.createElement('div');
    content.style.cssText = 'background:#fff;padding:20px;border-radius:12px;max-width:600px;width:100%;max-height:90%;overflow:auto;margin:auto';
    
    content.innerHTML = `
      <h3 style="margin-top:0;color:#e74c3c">âš ï¸ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡</h3>
      <p style="color:#666;margin:12px 0">Ù„Ø·ÙØ§Ù‹ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ú©Ø¯Ø§Ù… Ù‚Ø³Ù…Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯:</p>
      
      <div style="background:#f8f9fa;padding:12px;border-radius:8px;margin:12px 0">
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-attendance" checked>
          <span>Ø³ÙˆØ§Ø¨Ù‚ Ø­Ø¶ÙˆØ± Ùˆ ØºÛŒØ§Ø¨</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-reports" checked>
          <span>Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-checklist" checked>
          <span>Ú†Ú© Ù„ÛŒØ³Øª</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-logs" checked>
          <span>Ø¯ÙØªØ±Ú†Ù‡ ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-prices" checked>
          <span>Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</span>
        </label>
        <label style="display:flex;align-items:center;gap:8px;margin-bottom:10px">
          <input type="checkbox" id="reset-payroll" checked>
          <span>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø­Ù‚ÙˆÙ‚â€ŒØ¯Ù‡ÛŒ</span>
        </label>
      </div>
      
      <div style="background:#fff3cd;padding:12px;border-radius:8px;margin:12px 0;border-left:4px solid #ffc107">
        <strong style="color:#856404">âš ï¸ ØªÙˆØ¬Ù‡ Ù…Ù‡Ù…:</strong>
        <p style="color:#856404;margin:8px 0 0 0;font-size:13px">Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø¯Ø§Ù…Ù‡ØŒ Ø­ØªÙ…Ø§Ù‹ Ø§Ø² Ø§Ø·Ù„Ø§Ø¹Ø§Øªâ€ŒØªØ§Ù† Ø¨Ú©â€ŒØ¢Ù¾ Ø¨Ú¯ÛŒØ±ÛŒØ¯!</p>
      </div>
      
      <div style="display:flex;gap:12px;justify-content:flex-end;margin-top:16px">
        <button id="reset-cancel" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
        <button id="reset-backup-first" class="btn-primary" style="background:#27ae60">ğŸ’¾ Ø¨Ú©â€ŒØ¢Ù¾ Ùˆ Ø³Ù¾Ø³ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù†</button>
        <button id="reset-confirm" class="btn-primary" style="background:#e74c3c">Ø­Ø°Ù Ùˆ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù†</button>
      </div>
    `;
    
    modal.appendChild(content);
    document.body.appendChild(modal);
    
    document.getElementById('reset-cancel').onclick = () => modal.remove();
    
    document.getElementById('reset-backup-first').onclick = () => {
      // Ø§Ø¨ØªØ¯Ø§ Ø¨Ú©â€ŒØ¢Ù¾
      downloadBackup();
      setTimeout(() => {
        performFactoryReset();
        modal.remove();
      }, 500);
    };
    
    document.getElementById('reset-confirm').onclick = () => {
      performFactoryReset();
      modal.remove();
    };
  }

  function performFactoryReset() {
    try {
      const resetAttendance = document.getElementById('reset-attendance').checked;
      const resetReports = document.getElementById('reset-reports').checked;
      const resetChecklist = document.getElementById('reset-checklist').checked;
      const resetLogs = document.getElementById('reset-logs').checked;
      const resetPrices = document.getElementById('reset-prices').checked;
      const resetPayroll = document.getElementById('reset-payroll').checked;

      if (resetAttendance || resetReports || resetChecklist || resetLogs) {
        const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]');
        
        if (resetAttendance) {
          const filtered = arr.filter(r => r.type !== 'attendance');
          localStorage.setItem(DATA_KEY, JSON.stringify(filtered));
        }
        
        if (resetReports) {
          const filtered = arr.filter(r => r.type !== 'dailyReport');
          localStorage.setItem(DATA_KEY, JSON.stringify(filtered));
        }
        
        if (resetChecklist) {
          const filtered = arr.filter(r => r.type !== 'checklist');
          localStorage.setItem(DATA_KEY, JSON.stringify(filtered));
        }
        
        if (resetLogs) {
          const filtered = arr.filter(r => r.type !== 'text' && r.type !== 'drawing');
          localStorage.setItem(DATA_KEY, JSON.stringify(filtered));
        }
      }

      if (resetPrices) {
        localStorage.removeItem('fibotic_itemPrices_v11');
      }

      if (resetPayroll) {
        localStorage.removeItem('fibotic_payroll_v1');
      }

      // Ø¨Ø§Ø²Ù†Ø´Ø§Ù†ÛŒ ØµÙØ­Ù‡
      initDataFromStorage();
      showMessage('âœ… Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù† Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', '#27ae60');
      goHome();
    } catch (e) {
      console.error('Factory reset error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†Ø¯Ù†', '#e74c3c');
    }
  }

  window.openFactoryResetModal = openFactoryResetModal;

  /* loadPersonList: now reads admin-created users (fibotic_users_v2) + admin */
  function loadPersonList() {
    try {
      const sel = document.getElementById('personSelect'); if (!sel) return;
      const users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
      const entries = [];
      // include admin explicitly
      entries.push({ username: 'admin', display: 'Ù…Ø¯ÛŒØ± (admin)' });
      Object.keys(users || {}).forEach(u => entries.push({ username: u, display: u }));
      const opts = ['<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>'].concat(entries.map(p => `<option value="${escapeHtml(p.username)}">${escapeHtml(p.display)}</option>`)).join('');
      sel.innerHTML = opts;
      // if someone is logged, preselect them
      const logged = localStorage.getItem('fibotic_logged_in');
      if (logged) {
        sel.value = logged;
      }
    } catch (e) { console.error('loadPersonList error', e); }
  }
  window.loadPersonList = loadPersonList;

  /* ---------- Attendance ---------- */
  // --- Ú©Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ù…Ø§ØªØ±ÛŒØ³ ÙÛŒÙˆÚ˜Ù† ---
window.addFusionMatrix = function() {
  const container = document.getElementById('fusion-matrix-container');
  const matrixId = Date.now(); // Ø¨Ø±Ø§ÛŒ Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù‡Ø± Ù…Ø§ØªØ±ÛŒØ³
  
  const div = document.createElement('div');
  div.className = 'fusion-matrix';
  div.style = "background:#fff; border:1px solid #ddd; border-radius:8px; padding:8px; margin-bottom:15px; position:relative;";
  
  div.innerHTML = `
    <button onclick="this.parentElement.remove()" style="position:absolute; left:-10px; top:-10px; background:#ff4d4d; color:white; border:none; border-radius:50%; width:24px; height:24px; cursor:pointer;">Ã—</button>
    <table style="width:100%; border-collapse:collapse; table-layout:fixed;">
      <tr>
        <td style="border:1px solid #eee; padding:5px; background:#f9f9f9; width:30%; font-size:12px; color:#888;">Ù†Ø§Ù… Ú©Ø§Ø¨Ù„:</td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable" style="width:100%; border:none; padding:8px; text-align:center; font-weight:bold;" placeholder="Ø§Ø³Ù… Ú©Ø§Ø¨Ù„ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯"></td>
      </tr>
      <tr>
        <td style="border:1px solid #eee; padding:5px; background:#f9f9f9; font-size:12px; color:#888;">Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±:</td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core" style="width:100%; border:none; padding:8px; text-align:center;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯"></td>
      </tr>
    </table>
  `;
  container.appendChild(div);
};
// ==================== FOR REPORTS ====================
// Add fusion matrix for REPORTS (not attendance)
window.addReportFusionMatrix = function() {
  const container = document.getElementById('report-fusion-matrix-container');
  if (!container) return;
  
  const div = document.createElement('div');
  div.className = 'fusion-matrix-report';
  div.style = "background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:15px; position:relative; box-shadow:0 2px 5px rgba(0,0,0,0.05);";
  
  div.innerHTML = `
    <button onclick="this.parentElement.remove()" style="position:absolute; left:-8px; top:-8px; background:#ff4d4d; color:white; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; z-index:10; font-weight:bold;">Ã—</button>
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; border-radius:8px; overflow:hidden;">
      <tr>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-1-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„"></td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-2-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„"></td>
      </tr>
      <tr>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-1-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±"></td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-2-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±"></td>
      </tr>
    </table>
  `;
  
  container.appendChild(div);
};

// Get fusion matrix data for REPORTS
function getReportFusionMatrixData() {
  const matrices = document.querySelectorAll('.fusion-matrix-report');
  let text = "";
  if (matrices.length > 0) {
    text = "\n\nğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]:";
    matrices.forEach((m, i) => {
      const c1 = m.querySelector('.m-cable-1-r').value || "-";
      const c2 = m.querySelector('.m-cable-2-r').value || "-";
      const r1 = m.querySelector('.m-core-1-r').value || "-";
      const r2 = m.querySelector('.m-core-2-r').value || "-";
      text += `\nÙ…Ø§ØªØ±ÛŒØ³ ${i+1}: Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ [${c1}, ${c2}] | ØªØ§Ø±Ù‡Ø§ [${r1}, ${r2}]`;
    });
  }
  return text;
}

window.getReportFusionMatrixData = getReportFusionMatrixData;

function getFusionMatrixData() {
  const matrices = document.querySelectorAll('.fusion-matrix');
  let textResult = "";
  
  if (matrices.length > 0) {
    textResult = "\n\nğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†:]";
    matrices.forEach((m, index) => {
      const cable = m.querySelector('.m-cable').value || "Ù†Ø§Ù…Ø´Ø®Øµ";
      const core = m.querySelector('.m-core').value || "Ù†Ø§Ù…Ø´Ø®Øµ";
      textResult += `\n${index + 1}) Ú©Ø§Ø¨Ù„: ${cable} | ØªØ§Ø±: ${core}`;
      textResult += `\n-------------------------`;
    });
  }
  return textResult;
}
window.addFusionMatrix = function() {
  const container = document.getElementById('fusion-matrix-container');
  const div = document.createElement('div');
  div.className = 'fusion-matrix';
  div.style = "background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:15px; position:relative; box-shadow:0 2px 5px rgba(0,0,0,0.05);";
  div.innerHTML = `
    <button onclick="this.parentElement.remove()" style="position:absolute; left:-8px; top:-8px; background:#ff4d4d; color:white; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; z-index:10;">Ã—</button>
    <table style="width:100%; border-collapse:collapse; table-layout:fixed; border-radius:8px; overflow:hidden;">
      <tr>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-1" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„"></td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-2" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„"></td>
      </tr>
      <tr>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-1" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±"></td>
        <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-2" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±"></td>
      </tr>
    </table>
  `;
  container.appendChild(div);
};

function getFusionMatrixData() {
  const matrices = document.querySelectorAll('.fusion-matrix');
  let text = "";
  if (matrices.length > 0) {
    text = "\n\nğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]:";
    matrices.forEach((m, i) => {
      const c1 = m.querySelector('.m-cable-1').value || "-";
      const c2 = m.querySelector('.m-cable-2').value || "-";
      const r1 = m.querySelector('.m-core-1').value || "-";
      const r2 = m.querySelector('.m-core-2').value || "-";
      text += `\nÙ…Ø§ØªØ±ÛŒØ³ ${i+1}: Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ [${c1}, ${c2}] | ØªØ§Ø±Ù‡Ø§ [${r1}, ${r2}]`;
    });
  }
  return text;
}
  async function recordAttendance() {
    const role = localStorage.getItem('fibotic_role') || '';
    const logged = localStorage.getItem('fibotic_logged_in') || '';
    let personName = (document.getElementById('personSelect')?.value || '').trim() || logged;
    const projectName = document.getElementById('projectName')?.value?.trim() || '';
    
    // ØªØ±Ú©ÛŒØ¨ ØªÙˆØ¶ÛŒØ­Ø§Øª Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…Ø§ØªØ±ÛŒØ³
    const baseDesc = document.getElementById('workDescription')?.value || '';
    const fusionInfo = typeof getFusionMatrixData === 'function' ? getFusionMatrixData() : "";
    const finalWorkDesc = baseDesc + fusionInfo;

    const entryTime = document.getElementById('entryTime')?.value;
    const exitTime = document.getElementById('exitTime')?.value;
    const share = !!document.getElementById('shareWithAdmin')?.checked;

    if (!personName) { showMessage('âš ï¸ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø± Ù…Ø´Ø®Øµ Ù†ÛŒØ³Øª', '#e74c3c'); return; }
    if (!entryTime || !exitTime) { showMessage('âš ï¸ Ø³Ø§Ø¹Øª ÙˆØ±ÙˆØ¯ Ùˆ Ø®Ø±ÙˆØ¬ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª', '#e74c3c'); return; }

    const hours = calculateTimeDiff(entryTime, exitTime);
    const date = new Date().toLocaleDateString('fa-IR');
    const btn = document.getElementById('saveAttendanceBtn'); if (btn) btn.disabled = true;

    try {
      const owner = (role === 'user') ? (localStorage.getItem('fibotic_logged_in') || personName) : (role === 'admin' ? 'admin' : personName);
      const rec = { 
        type: 'attendance', person_name: personName, project_name: projectName,
        entry_time: entryTime, exit_time: exitTime, work_description: finalWorkDesc,
        work_hours: hours, date, owner, shared: !!share, timestamp: Date.now() 
      };
      await safeCreate(rec);
      showMessage('âœ… Ø«Ø¨Øª Ø´Ø¯', '#27ae60');
      
      // Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²Ø§Ù†Ù‡ (Ø´Ø§Ù…Ù„ Ù…Ø§ØªØ±ÛŒØ³ ÙÛŒÙˆÚ˜Ù†)
try {
  if (typeof promptSaveReportAfterAttendance === 'function') {
    promptSaveReportAfterAttendance({
      projectName: projectName || '',
      date: date,
      workDesc: finalWorkDesc
    });
  }
} catch (e) {
  console.error('promptSaveReportAfterAttendance call error', e);
}

// Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ ÙØ±Ù…
document.getElementById('workDescription').value = '';
document.getElementById('entryTime').value = '';
document.getElementById('exitTime').value = '';
const matrixContainer = document.getElementById('fusion-matrix-container');
if (matrixContainer) matrixContainer.innerHTML = '';

    } catch (e) {
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª', '#e74c3c');
    } finally {
      if (btn) btn.disabled = false;
    }
  }


  window.recordAttendance = recordAttendance;

function promptSaveReportAfterAttendance(prefill) {
    const modal = document.createElement('div'); 
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    
    const content = document.createElement('div'); 
    content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:420px;width:92%;text-align:center';
    
    content.innerHTML = `<h3 style="margin:0 0 12px 0">ğŸ“ Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ø±ÙˆØ²</h3><p>Ø¢ÛŒØ§ Ù…Ø§ÛŒÙ„ Ù‡Ø³ØªÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø± Ø§Ù…Ø±ÙˆØ² Ø±Ø§ Ù†ÛŒØ² Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ØŸ</p><div style="display:flex;gap:12px;justify-content:center;margin-top:12px"><button id="att-no" class="modal-cancel">Ø®ÛŒØ±</button><button id="att-yes" class="btn-primary">Ø¨Ù„ÛŒ</button></div>`;
    
    modal.appendChild(content); 
    document.body.appendChild(modal);
    
    document.getElementById('att-no').onclick = () => modal.remove();
    
    document.getElementById('att-yes').onclick = () => {
      modal.remove();
      
      // âœ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù†
      const fusionMatrices = extractFusionMatricesFromDescription(prefill.workDesc || '');
      
      goHome();
      openPage('dailyReport');
      
      // Ø§Ø±Ø³Ø§Ù„ Ø¨Ø§ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø´Ø¯Ù‡
      setTimeout(() => openNewReport({ 
        project: prefill.projectName || '', 
        date: prefill.date, 
        description: prefill.workDesc,
        fusionMatrices: fusionMatrices  // âœ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
      }), 250);
    };
}

  function calculateTimeDiff(entry, exit) {
    const [eh, em] = (entry || '00:00').split(':').map(Number);
    const [xh, xm] = (exit || '00:00').split(':').map(Number);
    let diff = (xh * 60 + xm) - (eh * 60 + em);
    if (diff < 0) diff += 24 * 60;
    const h = Math.floor(diff / 60), m = diff % 60;
    return `${h}Ø³ ${m}Ø¯`;
  }

  /* renderAttendance */
function renderAttendance() {
  try {
    const c = document.getElementById('attendanceList');
    if (!c) return;
    
    const records = (allData || [])
      .filter(i => i.type === 'attendance')
      .sort((a, b) => b.timestamp - a.timestamp);

    const role = localStorage.getItem('fibotic_role') || '';
    const logged = localStorage.getItem('fibotic_logged_in') || '';

    if (role === 'admin') {
      // Admin: show all records
      const allRecent = records;
      if (allRecent.length) {
        let html = '<div class="content-card"><div style="font-weight:800;margin-bottom:8px">ØªÙ…Ø§Ù… Ø³ÙˆØ§Ø¨Ù‚</div>' +
          allRecent.map(r => `
            <div style="margin-bottom:8px;padding:8px;background:#f8f9fb;border-radius:8px">
              <div style="font-weight:700">${escapeHtml(r.person_name || '')} â€” Ø§Ø±Ø³Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡: ${escapeHtml(r.owner || '')}</div>
              <div>ğŸ“… ${r.date || ''} â€” ğŸŸ¢ ${r.entry_time || ''} / ğŸ”´ ${r.exit_time || ''} â€” â±ï¸ ${r.work_hours || ''}</div>
              ${r.work_description ? `
                <div style="margin-top:8px">
                  <div style="font-weight:700;color:#667eea;font-size:13px;margin-bottom:6px">ğŸ“‹ ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§:</div>
                  ${renderFusionMatrixFromDescription(r.work_description)}
                  ${extractPlainDescription(r.work_description).trim() ? `
                    <div style="margin-top:8px;color:#556;font-size:13px;white-space:pre-wrap">${escapeHtml(extractPlainDescription(r.work_description))}</div>
                  ` : ''}
                </div>
              ` : ''}
            </div>
          `).join('') + '</div>';
        c.innerHTML = html;
      } else {
        c.innerHTML = '<div class="content-card">â° Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
      }
    } else {
      // Regular user: show only their own records
      const owner = logged || '';
      const userRecords = records.filter(r => (r.owner === owner) || (r.person_name === owner));
      
      if (userRecords.length === 0) {
        c.innerHTML = '<div class="content-card">â° Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
        return;
      }

      // Build HTML with disabled buttons for approved records
      const htmlParts = userRecords.map(r => {
        const isApproved = !!r.sharedApproved;
        const outerClass = isApproved ? 'approved-record' : '';
        const editDisabledAttr = isApproved ? 'disabled' : '';
        const deleteDisabledAttr = isApproved ? 'disabled' : '';
        return `<div class="content-card ${outerClass}">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(r.person_name || r.owner || '')} ${r.project_name ? `â€” ${escapeHtml(r.project_name)}` : ''}</div>
            <div style="display:flex;gap:8px">
              <button class="smallBtn" ${editDisabledAttr} onclick="editAttendance('${r.__backendId}')">âœï¸</button>
              <button class="smallBtn" ${deleteDisabledAttr} onclick="deleteAttendance('${r.__backendId}')">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div style="margin-top:8px;background:#f8f9fb;padding:8px;border-radius:8px">
            <div>ğŸ“… ${r.date || ''}</div>
            <div style="display:flex;gap:12px;margin-top:6px"><div>ğŸŸ¢ ${r.entry_time || ''}</div><div>ğŸ”´ ${r.exit_time || ''}</div><div>â±ï¸ ${r.work_hours || ''}</div></div>
            ${r.work_description ? `
              <div style="margin-top:8px;border-top:1px solid #ddd;padding-top:8px">
                <div style="font-weight:700;color:#667eea;font-size:13px;margin-bottom:6px">ğŸ“‹ ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§:</div>
                ${renderFusionMatrixFromDescription(r.work_description)}
                ${extractPlainDescription(r.work_description).trim() ? `
                  <div style="margin-top:8px;color:#556;font-size:13px;white-space:pre-wrap">${escapeHtml(extractPlainDescription(r.work_description))}</div>
                ` : ''}
              </div>
            ` : ''}
            ${r.shared ? `<div style="margin-top:8px;color:#996">ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ù…Ø¯ÛŒØ± ${r.sharedApproved ? '(ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡)' : '(Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯)'}</div>` : ''}
          </div>
        </div>`;
      });
      c.innerHTML = htmlParts.join('');
    }
  } catch (e) {
    console.error('renderAttendance error', e);
  }
}

  /* render pending/approved shares for admin page */
  function renderPendingShares() {
  try {
    const pendingEl = document.getElementById('pendingShares');
    if (!pendingEl) return;
    const records = (allData || []).filter(i => i.type === 'attendance').sort((a, b) => b.timestamp - a.timestamp);
    const pending = records.filter(r => r.shared && !r.sharedApproved);

    if (pending.length === 0) pendingEl.innerHTML = '<div class="content-card">â³ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ø¨Ø±Ø§ÛŒ ØªØ£ÛŒÛŒØ¯ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    else {
      pendingEl.innerHTML = pending.map(r => `<div class="content-card" style="display:flex;justify-content:space-between;align-items:center"><div><div style="font-weight:800">${escapeHtml(r.person_name || '')} â€” Ø§Ø±Ø³Ø§Ù„â€ŒÚ©Ù†Ù†Ø¯Ù‡: ${escapeHtml(r.owner || '')}</div><div style="font-size:0.95rem;margin-top:6px">ğŸ“… ${r.date || ''} â€” ${r.work_hours || ''} â€” ${escapeHtml(r.work_description || '')}</div></div><div style="display:flex;flex-direction:column;gap:8px"><button class="btn-primary" onclick="approveShare('${r.__backendId}')">ØªØ£ÛŒÛŒØ¯</button><button class="modal-cancel" onclick="rejectShare('${r.__backendId}')">Ø±Ø¯</button></div></div>`).join('');
    }
  } catch (e) { console.error('renderPendingShares error', e); }
}
window.renderPendingShares = renderPendingShares;
window.renderAdminShares = renderPendingShares;
  /* approve / reject share */
  async function approveShare(id) {
  try {
    const rec = allData.find(r => r.__backendId === id); if (!rec) return;
    rec.sharedApproved = true;
    rec.approvedBy = localStorage.getItem('fibotic_logged_in') || 'admin';
    rec.approvedAt = Date.now();
    await safeUpdate(rec);
    showMessage('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª ØªØ£ÛŒÛŒØ¯ Ø´Ø¯', '#27ae60');
    renderPendingShares();
  } catch (e) { console.error('approveShare error', e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
}
  window.approveShare = approveShare;

  async function rejectShare(id) {
    try {
      const rec = allData.find(r => r.__backendId === id); if (!rec) return;
      rec.shared = false;
      rec.sharedRejected = true;
      await safeUpdate(rec);
      showMessage('âœ… Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø±Ø¯ Ø´Ø¯', '#e67e22');
    } catch (e) { console.error('rejectShare error', e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
  }
  window.rejectShare = rejectShare;

  /* editAttendance */
  async function editAttendance(id) {
    const rec = allData.find(r => r.__backendId === id); if (!rec) return;
    const role = localStorage.getItem('fibotic_role') || '';
    // block non-admin edits if record approved
    if (rec.sharedApproved && role !== 'admin') {
      showMessage('âš ï¸ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ ÙˆÛŒØ±Ø§ÛŒØ´ Ù†ÛŒØ³Øª', '#e74c3c');
      return;
    }

    const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:520px;width:92%';
    content.innerHTML = `<h3 style="margin:0 0 12px 0">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ø­Ø¶ÙˆØ±</h3><input id="editPersonName" class="input" value="${escapeHtml(rec.person_name || '')}"><div style="height:8px"></div><div style="display:flex;gap:8px"><input id="editEntry" class="input" type="time" value="${rec.entry_time || ''}"><input id="editExit" class="input" type="time" value="${rec.exit_time || ''}"></div><div style="height:8px"></div><textarea id="editWork" class="input">${escapeHtml(rec.work_description || '')}</textarea><div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px"><button id="cancelEdit" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button><button id="saveEdit" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡</button></div>`;
    modal.appendChild(content); document.body.appendChild(modal);
    document.getElementById('cancelEdit').onclick = () => modal.remove();
    document.getElementById('saveEdit').onclick = async () => {
      const newName = document.getElementById('editPersonName').value.trim();
      const newEntry = document.getElementById('editEntry').value;
      const newExit = document.getElementById('editExit').value;
      const newWork = document.getElementById('editWork').value.trim();
      if (!newName || !newEntry || !newExit) { showMessage('âš ï¸ Ù„Ø·ÙØ§Ù‹ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø±Ø§ Ú©Ø§Ù…Ù„ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
      const newHours = calculateTimeDiff(newEntry, newExit);
      const newMinutes = (function(e, x){ const [eh,em]=e.split(':').map(Number); const [xh,xm]=x.split(':').map(Number); let d=(xh*60+xm)-(eh*60+em); if (d<0) d+=24*60; return d;})(newEntry, newExit);
      const updated = { ...rec, person_name: newName, entry_time: newEntry, exit_time: newExit, work_description: newWork, work_hours: newHours, work_minutes: newMinutes };
      try {
        await safeUpdate(updated);
        showMessage('âœ… Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', '#27ae60'); modal.remove();
      } catch (e) { console.error(e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
    };
  }
  window.editAttendance = editAttendance;

  /* deleteAttendance */
  async function deleteAttendance(id) {
    try {
      const rec = allData.find(r => r.__backendId === id);
      const role = localStorage.getItem('fibotic_role') || '';
      if (!rec) return;
      // prevent non-admin deleting approved records
      if (rec.sharedApproved && role !== 'admin') {
        showMessage('âš ï¸ Ø§ÛŒÙ† Ø±Ú©ÙˆØ±Ø¯ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡ Ùˆ Ù‚Ø§Ø¨Ù„ Ø­Ø°Ù Ù†ÛŒØ³Øª', '#e74c3c');
        return;
      }

      if (window.dataSdk && typeof window.dataSdk.delete === 'function') { if (rec) await window.dataSdk.delete(rec); }
      else { const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]'); const idx = arr.findIndex(x => x.__backendId === id); if (idx !== -1) { arr.splice(idx, 1); localStorage.setItem(DATA_KEY, JSON.stringify(arr)); dataHandler.onDataChanged(arr); } }
      showMessage('âœ… Ø­Ø°Ù Ø´Ø¯', '#27ae60');
    } catch (e) { console.error(e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
  }
  window.deleteAttendance = deleteAttendance;

  /* ---------- Reports (fixed toggleAsbuilt) ---------- */
  function renderReports() {
    try {
      const c = document.getElementById('reportsList'); 
      if (!c) return;
      
      const reports = (allData || []).filter(r => r && r.type === 'dailyReport').sort((a, b) => b.timestamp - a.timestamp);
      
      if (reports.length === 0) { 
        c.innerHTML = '<div class="content-card">ğŸ“Š Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'; 
        return; 
      }
      
      c.innerHTML = reports.map(r => {
        const codeDisplay = (r.projectCode && r.projectCode.trim()) ? `<strong style="color:#667eea;direction:ltr">${escapeHtml(r.projectCode)}</strong>` : '';
        const separator = codeDisplay ? ' â€” ' : '';
        const title = escapeHtml(r.text || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)');
        const isAsbuilt = r.isAsbuilt ? 'checked' : '';
        
        // ğŸ†• Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ù…Ø§ØªØ±ÛŒØ³ Ù‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù†
        const hasFusionMatrix = r.description && r.description.includes('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]');
        const fusionMatrixBadge = hasFusionMatrix ? `<span style="background:#667eea;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:700;margin-right:6px">ğŸ“Œ ÙÛŒÙˆÚ˜Ù†</span>` : '';
        
        return `<div class="reports-list-item" style="display:flex;justify-content:space-between;align-items:center;cursor:default;flex-wrap:wrap;gap:8px">
          <span style="flex:1;cursor:pointer;padding:4px;display:flex;align-items:center;gap:6px" onclick="openReportDetails('${r.__backendId}')">
            ${fusionMatrixBadge}
            ${codeDisplay}${separator}${title}
          </span>
          <label style="display:flex;align-items:center;gap:6px;font-size:0.85rem;cursor:pointer;padding:4px" onclick="event.stopPropagation()">
            <input type="checkbox" ${isAsbuilt} onchange="toggleAsbuilt('${r.__backendId}', this)">
            Ø§Ø²Ø¨ÛŒÙ„Øª
          </label>
        </div>`;
      }).join('');
    } catch (e) { 
      console.error('renderReports error', e); 
    }
}

  // toggle asbuilt status for a report (prevents JS error and updates data)
  async function toggleAsbuilt(id, checkboxEl) {
    try {
      const rec = allData.find(r => r.__backendId === id);
      if (!rec) return;
      rec.isAsbuilt = !!(checkboxEl && checkboxEl.checked);
      await safeUpdate(rec);
      showMessage(rec.isAsbuilt ? 'âœ… Ú¯Ø²Ø§Ø±Ø´ Ø§Ø²Ø¨ÛŒÙ„Øª Ø´Ø¯' : 'âœ… Ø§Ø²Ø¨ÛŒÙ„Øª ØºÛŒØ±ÙØ¹Ø§Ù„ Ø´Ø¯', 'var(--accent)');
    } catch (e) {
      console.error('toggleAsbuilt error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± ØªØºÛŒÛŒØ± ÙˆØ¶Ø¹ÛŒØª Ø§Ø²Ø¨ÛŒÙ„Øª', '#e74c3c');
      // revert checkbox state in case of error
      if (checkboxEl) checkboxEl.checked = !checkboxEl.checked;
    }
  }
  window.toggleAsbuilt = toggleAsbuilt;

  async function deleteReport(id) {
    try {
      if (window.dataSdk && typeof window.dataSdk.delete === 'function') { const rec = allData.find(r => r.__backendId === id); if (rec) await window.dataSdk.delete(rec); }
      else { const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]'); const idx = arr.findIndex(x => x.__backendId === id); if (idx !== -1) { arr.splice(idx, 1); localStorage.setItem(DATA_KEY, JSON.stringify(arr)); dataHandler.onDataChanged(arr); } }
      showMessage('âœ… Ø­Ø°Ù Ø´Ø¯', '#27ae60');
    } catch (e) { console.error(e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
  }
  // âœ… ØªØ§Ø¨Ø¹ Ø¬Ø¯ÛŒØ¯: Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù† Ø§Ø² ØªÙˆØ¶ÛŒØ­Ø§Øª
function extractFusionMatricesFromDescription(description) {
  try {
    if (!description || !description.includes('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]')) {
      return []; // Ù‡ÛŒÚ† Ù…Ø§ØªØ±ÛŒØ³ÛŒ Ù†ÛŒØ³Øª
    }
    
    const lines = description.split('\n');
    const matrixLines = lines.filter(l => l.includes('Ù…Ø§ØªØ±ÛŒØ³'));
    
    const matrices = [];
    
    matrixLines.forEach((line) => {
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬: "Ù…Ø§ØªØ±ÛŒØ³ 1: Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ [C1, C2] | ØªØ§Ø±Ù‡Ø§ [T1, T2]"
      const match = line.match(/Ù…Ø§ØªØ±ÛŒØ³\s*\d+.*?\[([^\],]*),\s*([^\]]*)\].*?\[([^\],]*),\s*([^\]]*)\]/);
      
      if (match) {
        matrices.push({
          cable1: (match[1] || '').trim(),
          cable2: (match[2] || '').trim(),
          core1: (match[3] || '').trim(),
          core2: (match[4] || '').trim()
        });
      }
    });
    
    return matrices;
  } catch (e) {
    console.error('extractFusionMatricesFromDescription error', e);
    return [];
  }
}

window.extractFusionMatricesFromDescription = extractFusionMatricesFromDescription;
  window.deleteReport = deleteReport;

  // open new report modal; optional prefill { project, date, description }
 function openNewReport(prefill = {}) {
    const modal = document.createElement('div'); 
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    const content = document.createElement('div'); 
    content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:780px;width:96%;max-height:90%;overflow:auto';
    
    const currentDate = prefill.date || new Date().toLocaleDateString('fa-IR');
    const items = ['ÙÛŒÙˆÚ˜Ù† ÙÛŒØ¨Ø±Ù†ÙˆØ±ÛŒ', 'Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…ÙØµÙ„', 'Ù†ØµØ¨ FAT', 'Ù†ØµØ¨ Ù…ÙØµÙ„', 'Ù†ØµØ¨ Ù¾Ú† Ù¾Ù†Ù„', 'Ù†ØµØ¨ Ø¢Ø¯Ø§Ù¾ØªÙˆØ±', 'Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ù‡ÙˆØ§ÛŒÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ú©Ø§Ù†Ø§Ù„ÛŒ', 'Ú†Ø§Ù„Ù‡ Ú©Ù†ÛŒ Ù…Ø­Ù„ Ù…ÙØµÙ„'];
    let fields = items.map(it => `<label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span>${it}</span><input class="input" id="modal-${it.replace(/ /g, '-')}" type="number" value="" min="0" style="width:140px"></label>`).join('');
    
    // âœ… Ø§Ú¯Ø± prefill.fusionMatrices Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³ØªØŒ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø§Ø²Ú¯Ùˆ Ú©Ù†ÛŒØ¯
    let initialMatricesHtml = '';
    if (prefill.fusionMatrices && Array.isArray(prefill.fusionMatrices) && prefill.fusionMatrices.length > 0) {
      initialMatricesHtml = `<div style="background:#e8f4f8;padding:10px;border-radius:8px;margin-top:8px;color:#2d9cdb;font-weight:700">âœ… ${prefill.fusionMatrices.length} Ù…Ø§ØªØ±ÛŒØ³ Ø§Ø² Ø­Ø¶ÙˆØ±â€ŒØºÛŒØ§Ø¨ Ø§Ù†ØªÙ‚Ø§Ù„ ÛŒØ§ÙØª!</div>`;
    }
    
    content.innerHTML = `<h3 style="margin-top:0">â• Ø«Ø¨Øª Ú¯Ø²Ø§Ø±Ø´ Ú©Ø§Ø± Ø¬Ø¯ÛŒØ¯</h3>
      <div><label>Ø´Ù…Ø§Ø±Ù‡ Ø·Ø±Ø­:<div style="display:flex;align-items:center;gap:8px;direction:ltr">
  <span style="font-weight:700;color:#667eea;padding:8px 12px;background:#f0f2ff;border-radius:8px;white-space:nowrap">/FS</span>
  <input id="modal-project-code" class="input" placeholder="122255" value="" style="flex:1;direction:ltr;text-align:left" oninput="formatProjectCode()">
</div></label></div>
      <div style="height:8px"></div>
      <div><label>Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡:<input id="modal-project-name" class="input" value="${escapeHtml(prefill.project || '')}"></label></div>
      <div style="margin-top:8px"><label>ØªØ§Ø±ÛŒØ®:<input id="modal-report-date" class="input" value="${currentDate}"></label></div>
      <div style="margin-top:8px"><label>Ø´Ø±Ø­ Ú©Ø§Ø± Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯Ù‡:<textarea id="modal-description" class="input" style="min-height:80px">${escapeHtml(prefill.description || '')}</textarea></label></div>
      <h4 style="margin-top:12px">Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</h4><div>${fields}</div>
      
      <!-- Ù…Ø§ØªØ±ÛŒØ³ Ù‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù† Ø¨Ø±Ø§ÛŒ Ú¯Ø²Ø§Ø±Ø´ -->
      <div class="form-group" style="margin-top:15px; border:2px solid var(--accent); padding:10px; border-radius:12px; background: rgba(255,255,255,0.5);">
        <label style="color:var(--accent-2); font-weight:bold; display:block; margin-bottom:10px;">ğŸ“Œ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù† (Ú©Ø§Ø¨Ù„ Ùˆ ØªØ§Ø±)</label>
        ${initialMatricesHtml}
        <div id="report-fusion-matrix-container"></div> 
        <div style="margin-top:10px; text-align:center;">
          <button type="button" onclick="addReportFusionMatrix()" style="background:var(--accent-2); color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer; font-weight:bold; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">+ Ø§ÙØ²ÙˆØ¯Ù† Ù…Ø§ØªØ±ÛŒØ³ Ø¬Ø¯ÛŒØ¯</button>
        </div>
      </div>
      
      <div style="margin-top:8px"><label>ØªØµØ§ÙˆÛŒØ± (Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ú†Ù†Ø¯ ØªØµÙˆÛŒØ± Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯):<input id="modal-images" type="file" accept="image/*" multiple class="input" style="padding:8px"></label></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="cancelReport" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button><button id="saveReport" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡ Ú¯Ø²Ø§Ø±Ø´</button></div>`;
    
    modal.appendChild(content); 
    document.body.appendChild(modal);

    // âœ… Ø§Ú¯Ø± Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙˆØ¯ØŒ Ø¢Ù†Ù‡Ø§ Ø±Ø§ Ø¨Ù‡ Ú©Ø§Ù†ØªÛŒÙ†Ø± Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯
    if (prefill.fusionMatrices && Array.isArray(prefill.fusionMatrices) && prefill.fusionMatrices.length > 0) {
      const container = document.getElementById('report-fusion-matrix-container');
      prefill.fusionMatrices.forEach(matrix => {
        const div = document.createElement('div');
        div.className = 'fusion-matrix-report';
        div.style = "background:#fff; border:1px solid #ddd; border-radius:10px; padding:10px; margin-bottom:15px; position:relative; box-shadow:0 2px 5px rgba(0,0,0,0.05);";
        
        div.innerHTML = `
          <button onclick="this.parentElement.remove()" style="position:absolute; left:-8px; top:-8px; background:#ff4d4d; color:white; border:none; border-radius:50%; width:22px; height:22px; cursor:pointer; z-index:10; font-weight:bold;">Ã—</button>
          <table style="width:100%; border-collapse:collapse; table-layout:fixed; border-radius:8px; overflow:hidden;">
            <tr>
              <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-1-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„" value="${escapeHtml(matrix.cable1)}"></td>
              <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-cable-2-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ù†Ø§Ù… Ú©Ø§Ø¨Ù„" value="${escapeHtml(matrix.cable2)}"></td>
            </tr>
            <tr>
              <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-1-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±" value="${escapeHtml(matrix.core1)}"></td>
              <td style="border:1px solid #eee; padding:0;"><input type="text" class="m-core-2-r" style="width:100%; border:none; padding:12px 5px; text-align:center; font-size:13px;" placeholder="Ø´Ù…Ø§Ø±Ù‡ ØªØ§Ø±" value="${escapeHtml(matrix.core2)}"></td>
            </tr>
          </table>
        `;
        
        container.appendChild(div);
      });
    }

    // attach date auto-format to modal-report-date
    attachDateAutoFormat(document.getElementById('modal-report-date'));

    document.getElementById('cancelReport').onclick = () => modal.remove();

    document.getElementById('saveReport').onclick = async () => {
      const projectCode = document.getElementById('modal-project-code')?.value?.trim() || '';
      const project = document.getElementById('modal-project-name').value.trim();
      const date = document.getElementById('modal-report-date').value.trim();
      const description = document.getElementById('modal-description').value.trim();
      
      if (!project) { showMessage('âš ï¸ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }

      const itemData = {};
      items.forEach(it => { itemData[it] = parseInt(document.getElementById(`modal-${it.replace(/ /g, '-')}`).value) || 0; });

      // ğŸ†• Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡ Ù‡Ø§ÛŒ Ù…Ø§ØªØ±ÛŒØ³ Ù‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù†
      const fusionInfo = typeof getReportFusionMatrixData === 'function' ? getReportFusionMatrixData() : "";

      // read images
      const files = document.getElementById('modal-images').files;
      const images = await readFilesAsDataURLs(files);

      // Ø¨Ø±Ø±Ø³ÛŒ Ø´Ù…Ø§Ø±Ù‡ Ø·Ø±Ø­
      checkAndMergeProjectCode(projectCode, async (shouldMerge, existingReport, fullCode) => {
        if (shouldMerge && existingReport) {
          // Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Ø·Ø±Ø­ Ù…ÙˆØ¬ÙˆØ¯
          try {
            const existingItems = JSON.parse(existingReport.drawing || '{}');
            const mergedItems = { ...existingItems };
            
            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯
            for (const [key, value] of Object.entries(itemData)) {
              mergedItems[key] = (mergedItems[key] || 0) + value;
            }

            // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† ØªØµØ§ÙˆÛŒØ± Ø¬Ø¯ÛŒØ¯
            let mergedImages = Array.isArray(existingReport.images) ? [...existingReport.images] : [];
            mergedImages = mergedImages.concat(images);

            // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø·Ø±Ø­
            const updated = {
              ...existingReport,
              text: existingReport.text,
              date: date,
              description: (existingReport.description || '') + (description ? '\n---\n' + description : '') + fusionInfo,
              drawing: JSON.stringify(mergedItems),
              images: mergedImages,
              timestamp: Date.now(),
              isAsbuilt: false
            };

            await safeUpdate(updated);
            showMessage('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ø´Ø¯ Ùˆ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù†Ø¯', '#27ae60');
            modal.remove();
          } catch (e) {
            console.error('merge error', e);
            showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§Ø¯ØºØ§Ù…', '#e74c3c');
          }
        } else {
          // Ø°Ø®ÛŒØ±Ù‡ Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯
          await safeCreate({ 
            type: 'dailyReport', 
            text: project, 
            projectCode: fullCode || null,
            date, 
            description: description + fusionInfo, 
            drawing: JSON.stringify(itemData), 
            images: images, 
            timestamp: Date.now() 
          });
          showMessage('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', '#27ae60');
          modal.remove();
        }
      });
    };

    // support Enter to save
    content.querySelectorAll('input, textarea').forEach(inp => inp.addEventListener('keydown', e => { if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') { e.preventDefault(); document.getElementById('saveReport').click(); inp.blur(); } }));

    // ensure modal-report-date uses dd/mm/yyyy Persian format on blur
    setTimeout(() => {
      const mr = document.getElementById('modal-report-date');
      if (mr) attachDateAutoFormat(mr);
    }, 50);
  }
  window.openNewReport = openNewReport;
  window.openNewReport = openNewReport;

  // open report detail modal by report id
  function openReportDetails(id) {
    const r = (allData || []).find(x => x.__backendId === id);
    if (!r) return;
    const modal = document.createElement('div'); 
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;overflow-y:auto;padding:20px 0';
    
    const content = document.createElement('div'); 
    content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:820px;width:96%;max-height:90%;overflow:auto;margin:auto';
    
    let itemsHtml = '';
    try {
      const items = JSON.parse(r.drawing || '{}');
      itemsHtml = Object.entries(items).map(([k, v]) => `<div style="padding:8px;background:#f8f9fb;border-radius:6px;margin-bottom:6px">â€¢ ${escapeHtml(k)}: <strong>${v}</strong></div>`).join('');
    } catch (e) { itemsHtml = ''; }
    
    // ==================== NEW: Render Fusion Matrix as 2x2 Table ====================
    let fusionMatrixHtml = '';
    if (r.description && r.description.includes('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]')) {
      fusionMatrixHtml = `
        <div style="margin-top:10px;border-top:1px solid #ddd;padding-top:10px">
          <strong style="color:#667eea;display:block;margin-bottom:10px">ğŸ“Œ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§ÛŒ ÙÛŒÙˆÚ˜Ù† (Ø¬Ø¯ÙˆÙ„ 2Ã—2):</strong>
          ${renderFusionMatrixAs2x2Table(r.description)}
        </div>
      `;
    }
    
    let imagesHtml = '';
    if (Array.isArray(r.images) && r.images.length) {
      imagesHtml = `<div style="display:flex;flex-wrap:wrap;gap:8px;margin-top:8px">` + 
        r.images.map((img, idx) => 
          `<div style="position:relative;display:inline-block">
            <img class="thumbnail" src="${img}" onclick="openImageViewer('${id}', ${idx})" style="cursor:pointer">
            <span style="position:absolute;bottom:2px;right:2px;background:#667eea;color:#fff;font-size:10px;padding:2px 6px;border-radius:4px;font-weight:bold">${idx + 1}</span>
          </div>`
        ).join('') + 
      `</div>`;
    }
    
    content.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><div><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px"><h3 style="margin:0">${escapeHtml(r.text || '(Ø¨Ø¯ÙˆÙ† Ø¹Ù†ÙˆØ§Ù†)')}</h3>${r.projectCode ? `<span style="color:#667eea;font-weight:800;background:#f0f2ff;padding:4px 8px;border-radius:6px;font-size:12px">${escapeHtml(r.projectCode)}</span>` : ''}</div><div style="opacity:.8">${escapeHtml(r.date || '')}</div></div><div style="display:flex;gap:8px"><button class="btn-primary" id="editReportBtn" style="background:linear-gradient(90deg,#2d9cdb,#1e88e5)">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´</button><button class="modal-cancel" id="deleteReportBtn" style="background:#e74c3c">ğŸ—‘ï¸ Ø­Ø°Ù</button> <button class="btn-primary" id="closeReportBtn">Ø¨Ø³ØªÙ†</button></div></div>
      <div style="margin-top:12px"><strong>Ø´Ø±Ø­ Ú©Ø§Ø±:</strong><div style="margin-top:6px;white-space:pre-wrap">${escapeHtml(r.description ? r.description.split('ğŸ“Œ')[0].trim() : '')}</div></div>
      <div style="margin-top:10px"><strong>Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</strong><div class="items-grid">${itemsHtml}</div></div>
      ${fusionMatrixHtml}
      <div style="margin-top:10px"><strong>ØªØµØ§ÙˆÛŒØ±:</strong>${imagesHtml}</div>`;
    
    modal.appendChild(content); 
    document.body.appendChild(modal);

    document.getElementById('closeReportBtn').onclick = () => modal.remove();
    
    document.getElementById('editReportBtn').onclick = () => {
      modal.remove();
      editReport(id);
    };
    
    document.getElementById('deleteReportBtn').onclick = async () => {
      if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú¯Ø²Ø§Ø±Ø´ Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
      await deleteReport(id);
      modal.remove();
    };
    
    window.openImageViewer = function(reportId, idx) {
      try {
        const rep = (allData || []).find(x => x.__backendId === reportId);
        if (!rep || !Array.isArray(rep.images) || !rep.images[idx]) {
          showMessage('âŒ Ø¹Ú©Ø³ ÛŒØ§ÙØª Ù†Ø´Ø¯', '#e74c3c');
          return;
        }
        
        const overlay = document.createElement('div');
        overlay.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:11000';
        overlay.onclick = () => overlay.remove();
        
        const imgEl = document.createElement('img');
        imgEl.src = rep.images[idx];
        imgEl.style.maxWidth = '92%';
        imgEl.style.maxHeight = '92%';
        imgEl.style.borderRadius = '8px';
        imgEl.onerror = () => showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¹Ú©Ø³', '#e74c3c');
        
        overlay.appendChild(imgEl);
        document.body.appendChild(overlay);
      } catch (e) {
        console.error('openImageViewer error:', e);
        showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³', '#e74c3c');
      }
    };
}
// ==================== NEW FUNCTION: Render Fusion Matrix as 2x2 Table ====================
function renderFusionMatrixAs2x2Table(description) {
  try {
    if (!description || !description.includes('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]')) {
      return '<div style="color:#999;font-size:13px">Ù‡ÛŒÚ† Ù…Ø§ØªØ±ÛŒØ³ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }
    
    // Extract matrix lines
    const lines = description.split('\n');
    const matrixLines = lines.filter(l => l.includes('Ù…Ø§ØªØ±ÛŒØ³'));
    
    if (matrixLines.length === 0) {
      return '<div style="color:#999;font-size:13px">Ù‡ÛŒÚ† Ù…Ø§ØªØ±ÛŒØ³ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
    }
    
    let tablesHtml = '';
    
    matrixLines.forEach((line, idx) => {
      // Parse: "Ù…Ø§ØªØ±ÛŒØ³ 1: Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ [C1, C2] | ØªØ§Ø±Ù‡Ø§ [T1, T2]"
      const match = line.match(/Ù…Ø§ØªØ±ÛŒØ³ (\d+).*?\[([^\],]*),\s*([^\]]*)\].*?\[([^\],]*),\s*([^\]]*)\]/);
      
      if (match) {
        const matNum = match[1];
        const c1 = (match[2] || '-').trim();
        const c2 = (match[3] || '-').trim();
        const t1 = (match[4] || '-').trim();
        const t2 = (match[5] || '-').trim();
        
        // Create 2x2 table
        tablesHtml += `
          <div style="margin-bottom:16px;border:2px solid #667eea;border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(102,126,234,0.2)">
            <div style="background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;padding:10px;font-weight:700;text-align:center">
              Ù…Ø§ØªØ±ÛŒØ³ ${matNum}
            </div>
            <table style="width:100%;border-collapse:collapse;font-size:14px">
              <tbody>
<table style="width:100%;border-collapse:collapse;font-size:14px">
  <tbody>
   <table style="width:100%;border-collapse:collapse;font-size:14px">
  <tbody>
    <tr>
      <td style="border:1px solid #667eea;padding:12px;text-align:center;background:#f0f2ff;font-weight:700">
        ${escapeHtml(c1)}
      </td>
      <td style="border:1px solid #667eea;padding:12px;text-align:center;background:#fff">
        ${escapeHtml(c2)}
      </td>
    </tr>
    <tr>
      <td style="border:1px solid #667eea;padding:12px;text-align:center;background:#f0f2ff;font-weight:700">
        ${escapeHtml(t1)}
      </td>
      <td style="border:1px solid #667eea;padding:12px;text-align:center;background:#fff">
        ${escapeHtml(t2)}
      </td>
    </tr>
  </tbody>
</table>
          </div>
        `;
      }
    });
    
    return tablesHtml || '<div style="color:#999;font-size:13px">Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…Ø§ØªØ±ÛŒØ³</div>';
    
  } catch (e) {
    console.error('renderFusionMatrixAs2x2Table error', e);
    return '<div style="color:#e74c3c;font-size:13px">âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù…Ø§ØªØ±ÛŒØ³</div>';
  }
}

window.renderFusionMatrixAs2x2Table = renderFusionMatrixAs2x2Table;
window.openReportDetails = openReportDetails;
;

/* ---------- Edit Report ---------- */
async function editReport(id) {
  try {
    const r = (allData || []).find(x => x.__backendId === id);
    if (!r) return;

    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000;overflow-y:auto;padding:20px 0';
    
    const content = document.createElement('div');
    content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:780px;width:96%;max-height:90%;overflow:auto;margin:auto';

    const items = ['ÙÛŒÙˆÚ˜Ù† ÙÛŒØ¨Ø±Ù†ÙˆØ±ÛŒ', 'Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…ÙØµÙ„', 'Ù†ØµØ¨ FAT', 'Ù†ØµØ¨ Ù…ÙØµÙ„', 'Ù†ØµØ¨ Ù¾Ú† Ù¾Ù†Ù„', 'Ù†ØµØ¨ Ø¢Ø¯Ø§Ù¾ØªÙˆØ±', 'Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ù‡ÙˆØ§ÛŒÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ú©Ø§Ù†Ø§Ù„ÛŒ', 'Ú†Ø§Ù„Ù‡ Ú©Ù†ÛŒ Ù…Ø­Ù„ Ù…ÙØµÙ„'];
    
    let itemData = {};
    try {
      itemData = JSON.parse(r.drawing || '{}');
    } catch (e) { }

    let fields = items.map(it => {
      const val = itemData[it] || 0;
      return `<label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span>${it}</span><input class="input" id="edit-${it.replace(/ /g, '-')}" type="number" value="${val}" min="0" style="width:140px"></label>`;
    }).join('');

    content.innerHTML = `<h3 style="margin-top:0">âœï¸ ÙˆÛŒØ±Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´</h3>
      <div><label>Ø´Ù…Ø§Ø±Ù‡ Ø·Ø±Ø­:<input id="edit-project-code" class="input" value="${escapeHtml(r.projectCode || '')}" placeholder="Ù…Ø«Ù„Ø§Ù‹: 122255" style="direction:ltr;text-align:right"></label></div>
      <div style="height:8px"></div>
      <div><label>Ù†ï¿½ï¿½Ù… Ù¾Ø±ÙˆÚ˜Ù‡:<input id="edit-project-name" class="input" value="${escapeHtml(r.text || '')}"></label></div>
      <div style="height:8px"></div>
      <div><label>ØªØ§Ø±ÛŒØ®:<input id="edit-report-date" class="input" value="${escapeHtml(r.date || '')}"></label></div>
      <div style="height:8px"></div>
      <div><label>Ø´Ø±Ø­ Ú©Ø§Ø±:<textarea id="edit-description" class="input" style="min-height:80px">${escapeHtml(r.description || '')}</textarea></label></div>
      <h4 style="margin-top:12px">Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</h4><div>${fields}</div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
        <button id="cancelEdit" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
        <button id="saveEdit" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
      </div>`;

    modal.appendChild(content);
    document.body.appendChild(modal);

    // attach date auto-format
    attachDateAutoFormat(document.getElementById('edit-report-date'));

    document.getElementById('cancelEdit').onclick = () => modal.remove();

    document.getElementById('saveEdit').onclick = async () => {
      const projectCode = document.getElementById('edit-project-code')?.value?.trim() || '';
      const projectName = document.getElementById('edit-project-name')?.value?.trim();
      const date = document.getElementById('edit-report-date')?.value?.trim();
      const description = document.getElementById('edit-description')?.value?.trim();

      if (!projectName) {
        showMessage('âš ï¸ Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c');
        return;
      }

      const newItemData = {};
      items.forEach(it => {
        newItemData[it] = parseInt(document.getElementById(`edit-${it.replace(/ /g, '-')}`).value) || 0;
      });

      try {
        const updated = {
          ...r,
          projectCode: projectCode || null,
          text: projectName,
          date: date,
          description: description,
          drawing: JSON.stringify(newItemData),
          timestamp: Date.now()
        };

        await safeUpdate(updated);
        showMessage('âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', '#27ae60');
        modal.remove();
      } catch (e) {
        console.error('editReport error', e);
        showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´', '#e74c3c');
      }
    };

  } catch (e) {
    console.error('editReport error', e);
    showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† ÙˆÛŒØ±Ø§ÛŒØ´', '#e74c3c');
  }
}
window.editReport = editReport;
  /* ---------- Price & Income ---------- */
  function showPriceForm() {
    const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:640px;width:92%;max-height:90%;overflow:auto';
    const saved = JSON.parse(localStorage.getItem('fibotic_itemPrices_v11') || '{}');
    const items = ['ÙÛŒÙˆÚ˜Ù† ÙÛŒØ¨Ø±Ù†ÙˆØ±ÛŒ', 'Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…ÙØµÙ„', 'Ù†ØµØ¨ FAT', 'Ù†ØµØ¨ Ù…ÙØµÙ„', 'Ù†ØµØ¨ Ù¾Ú† Ù¾Ù†Ù„', 'Ù†ØµØ¨ Ø¢Ø¯Ø§Ù¾ØªÙˆØ±', 'Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ù‡ÙˆØ§ÛŒÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ú©Ø§Ù†Ø§Ù„ÛŒ', 'Ú†Ø§Ù„Ù‡ Ú©Ù†ÛŒ Ù…Ø­Ù„ Ù…ÙØµÙ„'];
    const fields = items.map(it => `<label style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px"><span>${it}</span><input class="input" id="price-${it.replace(/ /g, '-')}" type="number" value="${saved[it] || ''}" style="width:160px"></label>`).join('');
    content.innerHTML = `<h3 style="margin-top:0">ğŸ’° Ù‚ÛŒÙ…Øªâ€ŒÚ¯Ø°Ø§Ø±ÛŒ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ (ØªÙˆÙ…Ø§Ù†)</h3><div>${fields}</div><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="cancelPrice" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button><button id="savePrice" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§</button></div>`;
    modal.appendChild(content); document.body.appendChild(modal);
    document.getElementById('cancelPrice').onclick = () => modal.remove();
    document.getElementById('savePrice').onclick = () => {
      const obj = {};
      items.forEach(it => obj[it] = document.getElementById(`price-${it.replace(/ /g, '-')}`).value);
      localStorage.setItem('fibotic_itemPrices_v11', JSON.stringify(obj));
      showMessage('âœ… Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù†Ø¯', 'var(--accent)');
      modal.remove();
    };
    content.querySelectorAll('input').forEach(inp => inp.addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('savePrice').click(); inp.blur(); } }));
  }
  window.showPriceForm = showPriceForm;

  // compute revenue same as openIncomeModal but return numbers
  function computeTotalRevenue() {
    const reports = (allData || []).filter(r => r.type === 'dailyReport');
    const saved = JSON.parse(localStorage.getItem('fibotic_itemPrices_v11') || '{}');
    const priceMap = saved || {};
    let total = 0;
    const rows = reports.filter(r => !r.isAsbuilt).map(r => {
      let items = {};
      try { items = JSON.parse(r.drawing || '{}'); } catch(e) { items = {}; }
      let sub = 0;
      for (const [k, v] of Object.entries(items || {})) { if (v > 0 && priceMap[k]) sub += v * (parseFloat(priceMap[k]) || 0); }
      total += sub;
      return { project: r.text || '', date: r.date || '', total: sub };
    });
    return { total, rows };
  }

  // UI: show income modal (admin)
  function openIncomeModal() {
    const revenue = computeTotalRevenue();
    if (!revenue.rows || revenue.rows.length === 0) { showMessage('âš ï¸ Ù‡ÛŒÚ† Ú¯Ø²Ø§Ø±Ø´ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ ÛŒØ§ Ù‡Ù…Ù‡ Ø§Ø²Ø¨ÛŒÙ„Øª Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯', '#e74c3c'); return; }
    const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:720px;width:92%;max-height:80%;overflow:auto';
    const listHtml = revenue.rows.map(r => `<div style="padding:8px;background:#f8f9fb;border-radius:8px;margin-bottom:8px"><strong>${escapeHtml(r.project)}</strong> (${escapeHtml(r.date)}) â€” <span style="font-weight:700">${formatCurrency(r.total)}</span></div>`).join('');
    content.innerHTML = `<h3 style="margin-top:0">ğŸ’¹ Ø¯Ø±Ø¢Ù…Ø¯ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§</h3><div style="margin-bottom:12px">${listHtml}</div><div style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px;border-radius:8px;text-align:center"><strong>Ù…Ø¬Ù…ÙˆØ¹: ${formatCurrency(revenue.total)}</strong></div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeIncome" class="btn-primary">Ø¨Ø³ØªÙ†</button></div>`;
    modal.appendChild(content); document.body.appendChild(modal);
    document.getElementById('closeIncome').onclick = () => modal.remove();
  }
  window.openIncomeModal = openIncomeModal;

  function requireAdminPassword(action) {
    const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
    const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:420px;width:92%';
    content.innerHTML = `<h3 style="margin:0 0 12px 0">ğŸ” Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª</h3><input id="adminPass" class="input" placeholder="Ø±Ù…Ø² Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯"><div style="height:12px"></div><div style="display:flex;justify-content:flex-end;gap:8px"><button id="cancelPass" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button><button id="submitPass" class="btn-primary">ØªØ§ÛŒÛŒØ¯</button></div>`;
    modal.appendChild(content); document.body.appendChild(modal);
    document.getElementById('cancelPass').onclick = () => modal.remove();
    document.getElementById('submitPass').onclick = () => {
      const v = document.getElementById('adminPass').value;
      const ADMIN = 'FIBER2025';
      if (v === ADMIN) { modal.remove(); if (typeof action === 'function') action(); }
      else showMessage('âŒ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª', '#e74c3c');
    };
    document.getElementById('adminPass').addEventListener('keydown', e => { if (e.key === 'Enter') { e.preventDefault(); document.getElementById('submitPass').click(); } });
  }
  window.requireAdminPassword = requireAdminPassword;

  /* ---------- Payroll / Salaries (NEW) ----------
     - Data stored in localStorage key: fibotic_payroll_v1
       Structure: { employees: {username: { hourly: number } }, payouts: [{ employee, amount, date, notes, timestamp }] }
     - Uses approved attendance records (sharedApproved === true) to compute payable hours
     - Allows admin to add/edit employee hourly rates and record payouts (deduct from balance)
     - Paid column in table is clickable: opens viewPayoutsForUser modal showing detailed payouts and CSV export
  */

  function loadPayrollData() {
    try {
      return JSON.parse(localStorage.getItem('fibotic_payroll_v1') || '{"employees":{},"payouts":[]}');
    } catch (e) { return { employees: {}, payouts: [] }; }
  }
  function savePayrollData(data) {
    try {
      localStorage.setItem('fibotic_payroll_v1', JSON.stringify(data || { employees: {}, payouts: [] }));
    } catch (e) { console.error('savePayrollData error', e); }
  }

  // helper: compute approved minutes per user (used for payroll)
  function computeApprovedMinutesPerUser() {
    const records = (allData || []).filter(i => i.type === 'attendance' && !!i.sharedApproved);
    const totals = {};
    records.forEach(r => {
      const owner = (r.owner && r.owner.trim()) ? r.owner : (r.person_name && r.person_name.trim()) ? r.person_name : 'Ù†Ø§Ù…Ø´Ø®Øµ';
      const mins = (typeof r.work_minutes === 'number') ? r.work_minutes : (function(e, x){ try { const [eh,em]=e.split(':').map(Number); const [xh,xm]=x.split(':').map(Number); let d=(xh*60+xm)-(eh*60+em); if (d<0) d+=24*60; return d; } catch(e){return 0;} })(r.entry_time || '00:00', r.exit_time || '00:00');
      totals[owner] = (totals[owner] || 0) + mins;
    });
    return totals;
  }

  // UI: show salaries / payroll modal (admin)
  function showSalariesModal() {
    try {
      const payroll = loadPayrollData();
      const approvedMinutes = computeApprovedMinutesPerUser();
      const revenueInfo = computeTotalRevenue();
      const totalRevenue = revenueInfo.total || 0;
      const totalPayouts = (payroll.payouts || []).reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
      const remainingBalance = totalRevenue - totalPayouts;

      const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:flex-start;justify-content:center;overflow:auto;padding:40px 12px;z-index:11000';
      const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:980px;width:98%;max-height:90%;overflow:auto;';

      // Build employees table
      const employeeUsernames = Array.from(new Set([...Object.keys(payroll.employees || {}), ...Object.keys(approvedMinutes || {})]));
      const rowsHtml = employeeUsernames.map(u => {
        const hourly = payroll.employees && payroll.employees[u] ? parseFloat(payroll.employees[u].hourly || 0) : 0;
        const mins = approvedMinutes[u] || 0;
        const hours = (mins / 60);
        const gross = Math.round(hours * hourly);
        const paid = (payroll.payouts || []).filter(p => p.employee === u).reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
        const outstanding = Math.max(0, gross - paid);
        return `<tr data-emp="${escapeHtml(u)}">
          <td style="padding:8px;border:1px solid #ddd">${escapeHtml(u)}</td>
          <td style="padding:8px;border:1px solid #ddd"><input class="input" style="width:120px" data-rate="${escapeHtml(u)}" value="${hourly || ''}" placeholder="Ø³Ø§Ø¹Øª (ØªÙˆÙ…Ø§Ù†)"></td>
          <td style="padding:8px;border:1px solid #ddd">${Math.floor(hours)}Ø³ ${Math.round((hours%1)*60)}Ø¯</td>
          <td style="padding:8px;border:1px solid #ddd">${formatCurrency(gross)}</td>
          <td style="padding:8px;border:1px solid #ddd"><button class="smallBtn" data-paid-emp="${escapeHtml(u)}">${formatCurrency(paid)}</button></td>
          <td style="padding:8px;border:1px solid #ddd">${formatCurrency(outstanding)}</td>
        </tr>`;
      }).join('');

      content.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">ğŸ‘¥ Ø­Ù‚ÙˆÙ‚ Ú©Ø§Ø±Ù…Ù†Ø¯Ø§Ù†</h3>
          <div style="text-align:left">
            <div style="font-weight:800">Ø¯Ø±Ø¢Ù…Ø¯ Ú©Ù„: ${formatCurrency(totalRevenue)}</div>
            <div style="margin-top:6px">Ù¾ÛŒØ´â€ŒÙ¾Ø±Ø¯Ø§Ø®Øªâ€ŒÙ‡Ø§: ${formatCurrency(totalPayouts)} â€” <strong>Ù…Ø§Ù†Ø¯Ù‡: ${formatCurrency(remainingBalance)}</strong></div>
          </div>
        </div>
        <div style="margin-top:12px">
          <div style="overflow:auto;border-radius:8px;border:1px solid #eee;padding:8px">
            <table style="width:100%;border-collapse:collapse">
              <thead><tr style="background:#f8f9fb"><th style="padding:8px;border:1px solid #ddd">Ú©Ø§Ø±Ø¨Ø±</th><th style="padding:8px;border:1px solid #ddd">Ù†Ø±Ø® Ø³Ø§Ø¹ØªÛŒ</th><th style="padding:8px;border:1px solid #ddd">Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±</th><th style="padding:8px;border:1px solid #ddd">Ø®Ø§Ù„Øµ</th><th style="padding:8px;border:1px solid #ddd">Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯Ù‡</th><th style="padding:8px;border:1px solid #ddd">Ø¨Ø§Ù‚ÛŒâ€ŒÙ…Ø§Ù†Ø¯Ù‡</th></tr></thead>
              <tbody>${rowsHtml || '<tr><td colspan="6" style="padding:12px;text-align:center">Ú©Ø§Ø±Ù…Ù†Ø¯ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</td></tr>'}</tbody>
            </table>
          </div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
          <div style="flex:1;min-width:260px">
            <h4 style="margin:0 0 8px 0">â• Ø§ÙØ²ÙˆØ¯Ù† / ÙˆÛŒØ±Ø§ÛŒØ´ Ú©Ø§Ø±Ù…Ù†Ø¯</h4>
            <input id="payrollNewName" class="input" placeholder="Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ (Ù…Ø«Ù„Ø§Ù‹: ali)"><div style="height:8px"></div>
            <input id="payrollNewRate" class="input" placeholder="Ù†Ø±Ø® Ø³Ø§Ø¹ØªÛŒ (ØªÙˆÙ…Ø§Ù†)"><div style="height:8px"></div>
            <div style="display:flex;gap:8px"><button id="btn-add-employee" class="btn-primary">Ø§ÙØ²ÙˆØ¯Ù† / Ø°Ø®ÛŒØ±Ù‡</button><button id="btn-refresh-payroll" class="smallBtn">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø¬Ø¯ÙˆÙ„</button></div>
          </div>

          <div style="flex:1;min-width:260px">
            <h4 style="margin:0 0 8px 0">ğŸ’¸ Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ² (Ù¾Ø±Ø¯Ø§Ø®Øª Ø­Ù‚ÙˆÙ‚)</h4>
            <select id="payrollPayoutEmp" class="input">${employeeUsernames.length ? ['<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± --</option>'].concat(employeeUsernames.map(u => `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`)).join('') : '<option value="">-- Ø§Ø¨ØªØ¯Ø§ Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ --</option>'}</select>
            <div style="height:8px"></div>
            <input id="payrollPayoutAmount" class="input" placeholder="Ù…Ø¨Ù„Øº (ØªÙˆÙ…Ø§Ù†)" type="number">
            <div style="height:8px"></div>
            <input id="payrollPayoutDate" class="input" placeholder="ØªØ§Ø±ÛŒØ® (Ù…Ø«Ù„Ø§Ù‹: 14/01/1403)">
            <div style="height:8px"></div>
            <input id="payrollPayoutNotes" class="input" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
            <div style="height:8px"></div>
            <div style="display:flex;gap:8px"><button id="btn-record-payout" class="btn-primary">Ø«Ø¨Øª ÙˆØ§Ø±ÛŒØ²</button><button id="btn-view-payouts" class="smallBtn">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§</button><button id="btn-export-payouts" class="smallBtn">Ø®Ø±ÙˆØ¬ÛŒ CSV</button></div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;margin-top:14px;gap:8px">
          <button id="closePayroll" class="modal-cancel">Ø¨Ø³ØªÙ†</button>
          <button id="savePayrollRates" class="btn-primary">Ø°Ø®ÛŒØ±Ù‡ Ù†Ø±Ø®â€ŒÙ‡Ø§</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      // Attach date auto-format to payrollPayoutDate
      attachDateAutoFormat(document.getElementById('payrollPayoutDate'));

      // Bind actions
      document.getElementById('closePayroll').onclick = () => modal.remove();

      // Save hourly rates from inputs in table
      document.getElementById('savePayrollRates').onclick = () => {
        const inputs = content.querySelectorAll('input[data-rate]');
        const data = loadPayrollData();
        inputs.forEach(inp => {
          const user = inp.getAttribute('data-rate');
          const val = parseFloat(inp.value) || 0;
          if (!data.employees) data.employees = {};
          if (val > 0) data.employees[user] = { hourly: val };
          else { if (data.employees && data.employees[user]) { delete data.employees[user]; } }
        });
        savePayrollData(data);
        showMessage('âœ… Ù†Ø±Ø®â€ŒÙ‡Ø§ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', 'var(--accent)');
        // refresh UI
        setTimeout(() => { modal.remove(); showSalariesModal(); }, 300);
      };

      // Add / edit employee
      document.getElementById('btn-add-employee').onclick = () => {
        const name = (document.getElementById('payrollNewName').value || '').trim();
        const rate = parseFloat(document.getElementById('payrollNewRate').value || '0');
        if (!name || !rate || rate <= 0) { showMessage('âš ï¸ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ù†Ø±Ø® Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
        const data = loadPayrollData();
        if (!data.employees) data.employees = {};
        data.employees[name] = { hourly: rate };
        savePayrollData(data);
        showMessage('âœ… Ú©Ø§Ø±Ù…Ù†Ø¯ Ø§Ø¶Ø§ÙÙ‡/Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', '#27ae60');
        // refresh modal content
        setTimeout(() => { modal.remove(); showSalariesModal(); }, 300);
      };

      // Refresh table button
      document.getElementById('btn-refresh-payroll').onclick = () => {
        modal.remove();
        setTimeout(showSalariesModal, 100);
      };

      // Record payout
      document.getElementById('btn-record-payout').onclick = () => {
        const emp = (document.getElementById('payrollPayoutEmp').value || '').trim();
        const amount = parseFloat(document.getElementById('payrollPayoutAmount').value || '0');
        const date = (document.getElementById('payrollPayoutDate').value || new Date().toLocaleDateString('fa-IR'));
        const notes = document.getElementById('payrollPayoutNotes').value || '';
        if (!emp || !amount || amount <= 0) { showMessage('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ø¨Ø± Ùˆ Ù…Ø¨Ù„Øº Ù…Ø¹ØªØ¨Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
        const data = loadPayrollData();
        if (!data.payouts) data.payouts = [];
        data.payouts.push({ employee: emp, amount: Math.round(amount), date, notes, timestamp: Date.now() });
        savePayrollData(data);
        showMessage('âœ… ÙˆØ§Ø±ÛŒØ² Ø«Ø¨Øª Ø´Ø¯', '#27ae60');
        // refresh UI
        setTimeout(() => { modal.remove(); showSalariesModal(); }, 300);
      };

      // View payouts list (all)
      document.getElementById('btn-view-payouts').onclick = () => {
        const data = loadPayrollData();
        const payouts = (data.payouts || []).slice().sort((a,b)=>b.timestamp - a.timestamp);
        const listHtml = payouts.length ? payouts.map(p => `<div style="padding:8px;border-bottom:1px solid #eee"><div style="font-weight:800">${escapeHtml(p.employee)} â€” ${formatCurrency(p.amount)}</div><div style="font-size:0.9rem;color:#666">${toPersianDigits(p.date || '')} â€” ${escapeHtml(p.notes || '')}</div></div>`).join('') : '<div style="padding:12px;text-align:center">Ù‡ÛŒÚ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
        const payoutsModal = document.createElement('div'); payoutsModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:12000';
        const pcontent = document.createElement('div'); pcontent.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:640px;width:92%;max-height:80%;overflow:auto';
        const totalP = payouts.reduce((s,p)=>s + (parseFloat(p.amount)||0),0);
        pcontent.innerHTML = `<h3 style="margin-top:0">ğŸ“¥ Ù„ÛŒØ³Øª ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ â€” Ø¬Ù…Ø¹: ${formatCurrency(totalP)}</h3><div style="margin-top:8px">${listHtml}</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closePayouts" class="btn-primary">Ø¨Ø³ØªÙ†</button></div>`;
        payoutsModal.appendChild(pcontent); document.body.appendChild(payoutsModal);
        document.getElementById('closePayouts').onclick = () => payoutsModal.remove();
      };

      // Export payouts CSV (all)
      document.getElementById('btn-export-payouts').onclick = () => {
        const data = loadPayrollData();
        const payouts = (data.payouts || []).slice().sort((a,b)=>b.timestamp - a.timestamp);
        if (!payouts.length) { showMessage('âš ï¸ ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø®Ø±ÙˆØ¬ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c'); return; }
        const header = ['employee','amount','date','notes','timestamp'];
        const rows = payouts.map(p => [p.employee, p.amount, p.date, (p.notes || ''), p.timestamp]);
        const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `payouts-${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url);
        showMessage('âœ… Ø®Ø±ÙˆØ¬ÛŒ CSV Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'var(--accent)');
      };

      // allow inline editing of rate inputs: update payroll.employees on change
      const rateInputs = content.querySelectorAll('input[data-rate]');
      rateInputs.forEach(inp => {
        inp.addEventListener('change', () => {
          const user = inp.getAttribute('data-rate');
          const val = parseFloat(inp.value) || 0;
          const data = loadPayrollData();
          if (!data.employees) data.employees = {};
          if (val > 0) data.employees[user] = { hourly: val };
          else delete data.employees[user];
          savePayrollData(data);
          showMessage('âœ… Ù†Ø±Ø® Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', '#27ae60');
        });
      });

      // bind paid buttons to open per-user payouts
      const paidButtons = content.querySelectorAll('button[data-paid-emp]');
      paidButtons.forEach(btn => {
        btn.addEventListener('click', (ev) => {
          const emp = btn.getAttribute('data-paid-emp');
          if (emp) viewPayoutsForUser(emp);
        });
      });

      window.showSalariesModal = showSalariesModal;
    } catch (e) {
      console.error('showSalariesModal error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ù¾Ù†Ù„ Ø­Ù‚ÙˆÙ‚', '#e74c3c');
    }
  }
  window.showSalariesModal = showSalariesModal;

  // View payouts for a specific user (modal) with CSV export for that user
  function viewPayoutsForUser(username) {
    try {
      const data = loadPayrollData();
      const payouts = (data.payouts || []).filter(p => p.employee === username).slice().sort((a,b)=>b.timestamp - a.timestamp);
      const total = payouts.reduce((s,p)=>s + (parseFloat(p.amount)||0),0);
      const modal = document.createElement('div'); modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:13000';
      const content = document.createElement('div'); content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:640px;width:92%;max-height:80%;overflow:auto';
      const listHtml = payouts.length ? payouts.map(p => `<div style="padding:8px;border-bottom:1px solid #eee"><div style="font-weight:800">${formatCurrency(p.amount)}</div><div style="font-size:0.9rem;color:#666">${toPersianDigits(p.date || '')} â€” ${escapeHtml(p.notes || '')}</div></div>`).join('') : '<div style="padding:12px;text-align:center">Ù‡ÛŒÚ† ÙˆØ§Ø±ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø± Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>';
      content.innerHTML = `<h3 style="margin-top:0">ğŸ“¥ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§ÛŒ ${escapeHtml(username)} â€” Ø¬Ù…Ø¹: ${formatCurrency(total)}</h3><div style="margin-top:8px">${listHtml}</div>
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button id="exportUserPayouts" class="smallBtn">Ø®Ø±ÙˆØ¬ÛŒ CSV</button><button id="closeUserPayouts" class="btn-primary">Ø¨Ø³ØªÙ†</button></div>`;
      modal.appendChild(content); document.body.appendChild(modal);
      document.getElementById('closeUserPayouts').onclick = () => modal.remove();
      document.getElementById('exportUserPayouts').onclick = () => {
        if (!payouts.length) { showMessage('âš ï¸ Ú†ÛŒØ²ÛŒ Ø¨Ø±Ø§ÛŒ ØµØ§Ø¯Ø± Ú©Ø±Ø¯Ù† Ù†ÛŒØ³Øª', '#e74c3c'); return; }
        const header = ['employee','amount','date','notes','timestamp'];
        const rows = payouts.map(p => [p.employee, p.amount, p.date, (p.notes || ''), p.timestamp]);
        const csv = [header, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `payouts-${username}-${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url);
        showMessage('âœ… Ø®Ø±ÙˆØ¬ÛŒ CSV Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'var(--accent)');
      };
    } catch (e) {
      console.error('viewPayoutsForUser error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ ÙˆØ§Ø±ÛŒØ²Ù‡Ø§', '#e74c3c');
    }
  }
  window.viewPayoutsForUser = viewPayoutsForUser;

  /* ---------- Logs / Checklist ---------- */
  function renderLogs() {
    try {
      const c = document.getElementById('logsList'); if (!c) return;
      const logs = (allData || []).filter(i => i.type === 'text' || i.type === 'drawing').sort((a, b) => b.timestamp - a.timestamp);
      if (logs.length === 0) { c.innerHTML = '<div class="content-card">ğŸ“ Ù‡ÛŒÚ† ÛŒØ§Ø¯Ø¯Ø§Ø´ØªÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª</div>'; return; }
      c.innerHTML = logs.map(l => `<div class="content-card"><div style="font-weight:700">${escapeHtml(l.date || '')}</div>${l.type === 'text' ? `<div style="margin-top:8px">${escapeHtml(l.text || '')}</div>` : (l.drawing ? `<img src="${l.drawing}" style="max-width:100%;margin-top:8px;border-radius:8px">` : '')}</div>`).join('');
    } catch (e) { console.error('renderLogs error', e); }
  }

  async function saveText() {
    const date = document.getElementById('dateInput')?.value;
    const text = document.getElementById('textInput')?.value;
    if (!date || !text) { showMessage('âš ï¸ ØªØ§Ø±ÛŒØ® Ùˆ Ù…ØªÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
    await safeCreate({ type: 'text', date, text, timestamp: Date.now() });
    document.getElementById('dateInput').value = ''; document.getElementById('textInput').value = '';
    showMessage('âœ… ÛŒØ§Ø¯Ø¯Ø§Ø´Øª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯', '#27ae60');
  }
  window.saveText = saveText;

  /* checklist */
  async function addChecklistItem() { const txt = (document.getElementById('checklistInput')?.value || '').trim(); if (!txt) { showMessage('âš ï¸ Ù…ØªÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; } document.getElementById('addChecklistBtn').disabled = true; await safeCreate({ type: 'checklist', text: txt, completed: false, timestamp: Date.now() }); document.getElementById('addChecklistBtn').disabled = false; document.getElementById('checklistInput').value = ''; showMessage('âœ… Ø¢ÛŒØªÙ… Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯', '#27ae60'); }
  function renderChecklist() {
    try {
      const c = document.getElementById('checklistItems'); if (!c) return; const items = (allData || []).filter(i => i.type === 'checklist');
      if (items.length === 0) { c.innerHTML = '<div class="content-card">âœ… Ù‡ÛŒÚ† Ø¢ÛŒØªÙ…ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>'; return; }
      c.innerHTML = items.map(it => `<div class="content-card" style="display:flex;align-items:center;justify-content:space-between"><div>${escapeHtml(it.text)}</div><div style="display:flex;gap:8px"><input type="checkbox" ${it.completed ? 'checked' : ''} onchange="toggleChecklistItem('${it.__backendId}')"><button class="smallBtn" onclick="deleteChecklistItem('${it.__backendId}')">ğŸ—‘ï¸</button></div></div>`).join('');
    } catch (e) { console.error('renderChecklist error', e); }
  }
  async function toggleChecklistItem(id) {
    const rec = allData.find(r => r.__backendId === id); if (!rec) return; const updated = { ...rec, completed: !rec.completed };
    try {
      await safeUpdate(updated);
    } catch (e) { console.error(e); }
  }
  async function deleteChecklistItem(id) {
    try {
      if (window.dataSdk && typeof window.dataSdk.delete === 'function') { const rec = allData.find(r => r.__backendId === id); if (rec) await window.dataSdk.delete(rec); }
      else { const arr = JSON.parse(localStorage.getItem(DATA_KEY) || '[]'); const idx = arr.findIndex(x => x.__backendId === id); if (idx !== -1) { arr.splice(idx, 1); localStorage.setItem(DATA_KEY, JSON.stringify(arr)); dataHandler.onDataChanged(arr); } }
      showMessage('âœ… Ø­Ø°Ù Ø´Ø¯', '#27ae60');
    } catch (e) { console.error(e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
  }
  window.addChecklistItem = addChecklistItem;
  window.deleteChecklistItem = deleteChecklistItem;

/* ---------- User Summary Card ---------- */
function updateUserSummary() {
  try {
    const role = localStorage.getItem('fibotic_role') || '';
    const logged = localStorage.getItem('fibotic_logged_in') || '';
    const summaryCard = document.getElementById('userSummaryCard');
    
    // ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    if (role === 'admin' || !logged) {
      if (summaryCard) summaryCard.style.display = 'none';
      return;
    }

    // Ø¬Ø³ØªØ¬Ùˆ ØªÙ…Ø§Ù… Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø§ÛŒÙ† Ú©Ø§Ø±Ø¨Ø±
    const records = (allData || []).filter(i => 
      i.type === 'attendance' && (i.owner === logged || i.person_name === logged)
    );
    
    if (records.length === 0) {
      if (summaryCard) summaryCard.style.display = 'none';
      return;
    }

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù…Ø¬Ù…ÙˆØ¹ Ø¯Ù‚Ø§ÛŒÙ‚ Ú©Ø§Ø±ÛŒ
    let totalMinutes = 0;
    records.forEach(r => {
      if (typeof r.work_minutes === 'number') {
        totalMinutes += r.work_minutes;
      } else {
        try {
          const [eh, em] = (r.entry_time || '00:00').split(':').map(Number);
          const [xh, xm] = (r.exit_time || '00:00').split(':').map(Number);
          let diff = (xh * 60 + xm) - (eh * 60 + em);
          if (diff < 0) diff += 24 * 60;
          totalMinutes += diff;
        } catch (er) { }
      }
    });

    const totalHours = Math.floor(totalMinutes / 60);
    const remainingMinutes = totalMinutes % 60;
    const hoursText = `${totalHours}Ø³ ${remainingMinutes}Ø¯`;

    // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø­Ù‚ÙˆÙ‚ (Ø§Ø² payroll)
    let totalSalary = 0;
    let remainingBalance = 0;
    
    try {
      const payroll = loadPayrollData();
      const approvedMinutes = computeApprovedMinutesPerUser();
      const userApprovedMinutes = approvedMinutes[logged] || 0;
      const userHourlyRate = (payroll && payroll.employees && payroll.employees[logged])
        ? parseFloat(payroll.employees[logged].hourly || 0)
        : 0;
      
      const userApprovedHours = userApprovedMinutes / 60;
      totalSalary = Math.round(userApprovedHours * userHourlyRate);

      // Ù…Ø­Ø§Ø³Ø¨Ù‡ Ù¾Ø±Ø¯Ø§Ø®ØªÛŒâ€ŒÙ‡Ø§
      const paidAmount = (payroll && payroll.payouts || [])
        .filter(p => p.employee === logged)
        .reduce((s, p) => s + (parseFloat(p.amount) || 0), 0);
      
      remainingBalance = Math.max(0, totalSalary - paidAmount);
    } catch (er) { }

    // Ù†Ù…Ø§ÛŒØ´ Ø¯Ø± Ø¬Ø¯ÙˆÙ„
    if (summaryCard) {
      summaryCard.style.display = 'block';
      const hoursEl = document.getElementById('summaryHours');
      const salaryEl = document.getElementById('summarySalary');
      const remainingEl = document.getElementById('summaryRemaining');
      
      if (hoursEl) hoursEl.textContent = hoursText;
      if (salaryEl) salaryEl.textContent = formatCurrency(totalSalary);
      if (remainingEl) remainingEl.textContent = formatCurrency(remainingBalance);
    }
  } catch (e) {
    console.error('updateUserSummary error', e);
  }
}
window.updateUserSummary = updateUserSummary;
window.updateUserSummary = updateUserSummary;

/* ---------- Export Reports to Excel ---------- */
function exportReportsToExcel() {
  try {
    // ÙÙ‚Ø· Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø²Ø¨ÛŒÙ„Øª Ù†Ø´Ø¯Ù‡ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†
    const reports = (allData || [])
      .filter(r => r && r.type === 'dailyReport' && !r.isAsbuilt)
      .sort((a, b) => (new Date(b.date || 0)).getTime() - (new Date(a.date || 0)).getTime());

    if (!reports || reports.length === 0) {
      showMessage('âš ï¸ Ú¯Ø²Ø§Ø±Ø´ Ø§Ø²Ø¨ÛŒÙ„Øª Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c');
      return;
    }

    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚ÛŒÙ…Øªâ€ŒÙ‡Ø§
    const prices = JSON.parse(localStorage.getItem('fibotic_itemPrices_v11') || '{}');

    // Ù„ÛŒØ³Øª ØªÙ…Ø§Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
    const allItems = ['ÙÛŒÙˆÚ˜Ù† ÙÛŒØ¨Ø±Ù†ÙˆØ±ÛŒ', 'Ø¨Ø§Ø²Ú¯Ø´Ø§ÛŒÛŒ Ù…ÙØµÙ„', 'Ù†ØµØ¨ FAT', 'Ù†ØµØ¨ Ù…ÙØµÙ„', 'Ù†ØµØ¨ Ù¾Ú† Ù¾Ù†Ù„', 'Ù†ØµØ¨ Ø¢Ø¯Ø§Ù¾ØªÙˆØ±', 'Ú©Ù…Ø±Ø¨Ù†Ø¯ÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ù‡ÙˆØ§ÛŒÛŒ', 'Ú©Ø§Ø¨Ù„ Ú©Ø´ÛŒ Ú©Ø§Ù†Ø§Ù„ÛŒ', 'Ú†Ø§Ù„Ù‡ Ú©Ù†ÛŒ Ù…Ø­Ù„ Ù…ÙØµÙ„'];

    // Ø³Ø§Ø®Øª Ø³Ø±Ø³ØªÙˆÙ†â€ŒÙ‡Ø§
    let headers = ['Ø±Ø¯ÛŒÙ', 'Ù†Ø§Ù… Ù¾Ø±ÙˆÚ˜Ù‡', 'ØªØ§Ø±ÛŒØ®', 'Ø´Ø±Ø­ Ú©Ø§Ø±'];
    headers = headers.concat(allItems);
    headers.push('Ø¬Ù…Ø¹ (Øªï¿½ï¿½Ù…Ø§Ù†)');

    // Ø³Ø§Ø®Øª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø±Ø¯ÛŒÙâ€ŒÙ‡Ø§
    let rows = [];
    let grandTotal = 0;

    reports.forEach((r, idx) => {
      let items = {};
      try {
        if (r.drawing) {
          items = JSON.parse(r.drawing);
        }
      } catch (e) { 
        console.warn('parse items error', e);
        items = {};
      }

      let rowTotal = 0;
      let rowData = [
        String(idx + 1),
        String(r.text || 'â€”'),
        String(r.date || 'â€”'),
        String(r.description || 'â€”')
      ];

      // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù…Ù‚Ø¯Ø§Ø± Ù‡Ø± Ø¢ÛŒØªÙ…
      allItems.forEach(itemName => {
        const qty = parseInt(items[itemName] || 0);
        rowData.push(String(qty));
        
        if (qty > 0 && prices[itemName]) {
          const price = parseFloat(prices[itemName]) || 0;
          rowTotal += qty * price;
        }
      });

      rowData.push(String(Math.round(rowTotal)));
      rows.push(rowData);
      grandTotal += rowTotal;
    });

    // Ø³Ø§Ø®Øª Ø±Ø¯ÛŒÙ Ø¬Ù…Ø¹
    let totalRow = ['', '', '', 'Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„'];
    allItems.forEach(() => totalRow.push(''));
    totalRow.push(String(Math.round(grandTotal)));
    rows.push(totalRow);

    // Ø³Ø§Ø®Øª CSV
    const allRows = [headers, ...rows];
    let csv = '';
    
    allRows.forEach(row => {
      const escapedRow = row.map(cell => {
        const str = String(cell || '');
        if (str.includes(',') || str.includes('"') || str.includes('\n')) {
          return `"${str.replace(/"/g, '""')}"`;
        }
        return str;
      });
      csv += escapedRow.join(',') + '\n';
    });

    // Ø¯Ø§Ù†Ù„ÙˆØ¯
    const BOM = '\uFEFF';
    const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8' });
    
    if (navigator.msSaveBlob) {
      // Ø¨Ø±Ø§ÛŒ Internet Explorer
      navigator.msSaveBlob(blob, `reports-${new Date().toISOString().split('T')[0]}.csv`);
    } else {
      // Ø¨Ø±Ø§ÛŒ Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ø¯ÛŒÚ¯Ø±
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.href = url;
      link.download = `reports-${new Date().toISOString().split('T')[0]}.csv`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      setTimeout(() => URL.revokeObjectURL(url), 100);
    }

    showMessage('âœ… Ø®Ø±ÙˆØ¬ÛŒ Ø§Ú©Ø³Ù„ Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'var(--accent)');

  } catch (e) {
    console.error('exportReportsToExcel error:', e);
    showMessage('âŒ Ø®Ø·Ø§: ' + (e.message || 'Ø®Ø·Ø§ÛŒ Ù†Ø§Ù…Ø´Ø®Øµ'), '#e74c3c');
  }
}
window.exportReportsToExcel = exportReportsToExcel;
window.exportReportsToExcel = exportReportsToExcel;
window.exportReportsToExcel = exportReportsToExcel;

/* ---------- Search Reports ---------- */
function searchReports() {
  try {
    const searchInput = document.getElementById('searchReports');
    if (!searchInput) return;

    const searchTerm = searchInput.value.trim().toLowerCase();
    const reportItems = document.querySelectorAll('.reports-list-item');

    if (!searchTerm) {
      // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
      reportItems.forEach(item => {
        item.style.display = 'flex';
        item.style.borderLeft = 'none';
        item.style.paddingLeft = '10px';
      });
      return;
    }

    let foundCount = 0;
    const foundItems = [];

    reportItems.forEach((item, index) => {
      const text = item.textContent.toLowerCase();
      
      if (text.includes(searchTerm)) {
        foundItems.push({ item, index });
        foundCount++;
      }
    });

    // Ø§Ø¨ØªØ¯Ø§ Ù‡Ù…Ù‡ Ø±Ø§ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†
    reportItems.forEach(item => {
      item.style.display = 'none';
    });

    // ÙÙ‚Ø· ÛŒØ§ÙØªÚ¯Ø§Ù† Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
    foundItems.forEach(({ item }) => {
      item.style.display = 'flex';
      item.style.borderLeft = '4px solid #667eea';
      item.style.paddingLeft = '10px';
      item.style.backgroundColor = '#f0f2ff';
      item.style.transition = 'all 0.3s ease';
    });

    // Ø§Ú¯Ø± ÛŒØ§ÙØªÚ¯Ø§Ù† Ù‡Ø³ØªÙ†Ø¯ØŒ Ø§ÙˆÙ„ÛŒ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ø¨ÛŒØ§ÙˆØ±
    if (foundItems.length > 0) {
      foundItems[0].item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Ù¾ÛŒØ§Ù… ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬
    if (foundCount === 0) {
      showMessage('âš ï¸ Ú¯Ø²Ø§Ø±Ø´ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', '#e74c3c');
    }

  } catch (e) {
    console.error('searchReports error', e);
  }
}
window.searchReports = searchReports;

function clearSearchReports() {
  try {
    const searchInput = document.getElementById('searchReports');
    if (searchInput) {
      searchInput.value = '';
      searchReports();
      showMessage('âœ… Ø¬Ø³ØªØ¬Ùˆ Ù¾Ø§Ú© Ø´Ø¯', 'var(--accent)');
    }
  } catch (e) {
    console.error('clearSearchReports error', e);
  }
}
window.clearSearchReports = clearSearchReports;

/* ---------- Check Project Code ---------- */
function checkAndMergeProjectCode(projectCode, onProceed) {
  try {
    if (!projectCode || projectCode.trim() === '') {
      showMessage('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø´Ù…Ø§Ø±Ù‡ Ø·Ø±Ø­ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c');
      return;
    }

    // Ø­Ø°Ù /FS Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¢Ù† Ø±Ø§ Ø´Ø§Ù…Ù„ Ú©Ø±Ø¯
    const cleanCode = projectCode.replace(/\/FS\s*$/, '').trim();
    const fullCode = cleanCode + '/FS';

    // Ø¬Ø³ØªØ¬Ùˆ Ø¨Ø±Ø§ÛŒ Ø·Ø±Ø­ Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§ Ø§ÛŒÙ† Ø´Ù…Ø§Ø±Ù‡
    const existingReport = (allData || []).find(r => 
      r.type === 'dailyReport' && 
      r.projectCode && 
      (r.projectCode === fullCode || r.projectCode === cleanCode)
    );

    if (!existingReport) {
      // Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯ Ø§Ø³Øª
      if (typeof onProceed === 'function') {
        onProceed(false, null, fullCode); // false = Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯
      }
      return;
    }

    // Ø·Ø±Ø­ Ù…ÙˆØ¬ÙˆØ¯ Ø§Ø³Øª - Ù†Ù…Ø§ÛŒØ´ ØªØ£ÛŒÛŒØ¯
    const confirmModal = document.createElement('div');
    confirmModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:15000';
    
    const content = document.createElement('div');
    content.style.cssText = 'background:#fff;padding:20px;border-radius:12px;max-width:450px;width:92%;text-align:center';
    content.innerHTML = `
      <h3 style="margin-top:0;color:#e74c3c">âš ï¸ Ø·Ø±Ø­ ØªÚ©Ø±Ø§Ø±ÛŒ</h3>
      <p style="font-size:14px;color:#666">Ø·Ø±Ø­ Ø¨Ø§ Ø´Ù…Ø§Ø±Ù‡ <strong style="color:#667eea">${escapeHtml(fullCode)}</strong> Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øª Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
      <p style="font-size:14px;color:#666;margin-top:12px">Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø¨Ù‡ Ø§ÛŒÙ† Ø·Ø±Ø­ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†ÛŒØ¯ Ùˆ Ø¢Ù† Ø±Ø§ Ø¨Ø§Ø²Ù†Ú¯Ø±ÛŒ Ú©Ù†ÛŒØ¯ØŸ</p>
      <div style="display:flex;gap:12px;justify-content:center;margin-top:16px">
        <button id="confirmNo" class="modal-cancel">Ø®ÛŒØ± - Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯</button>
        <button id="confirmYes" class="btn-primary" style="background:#e74c3c">Ø¨Ù„ÛŒ - Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†</button>
      </div>
    `;
    
    confirmModal.appendChild(content);
    document.body.appendChild(confirmModal);

    document.getElementById('confirmNo').onclick = () => {
      confirmModal.remove();
      if (typeof onProceed === 'function') {
        onProceed(false, null, fullCode); // Ø·Ø±Ø­ Ø¬Ø¯ÛŒØ¯
      }
    };

    document.getElementById('confirmYes').onclick = () => {
      confirmModal.remove();
      if (typeof onProceed === 'function') {
        onProceed(true, existingReport, fullCode); // Ø§Ø¯ØºØ§Ù… Ø¨Ø§ Ø·Ø±Ø­ Ù…ÙˆØ¬ÙˆØ¯
      }
    };

  } catch (e) {
    console.error('checkAndMergeProjectCode error', e);
  }
}
window.checkAndMergeProjectCode = checkAndMergeProjectCode;
window.checkAndMergeProjectCode = checkAndMergeProjectCode;

/* ---------- Format Project Code ---------- */
function formatProjectCode() {
  try {
    const input = document.getElementById('modal-project-code');
    if (!input) return;

    let value = input.value.trim();

    // Ø­Ø°Ù /FS Ø§Ú¯Ø± Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ§Ø±Ø¯ Ø´Ø¯Ù‡
    value = value.replace(/\/FS\s*$/, '').trim();

    // ÙÙ‚Ø· Ø§Ø¹Ø¯Ø§Ø¯ Ùˆ Ø®Ø· ØªÛŒØ±Ù‡ Ùˆ Ù†Ù‚Ø·Ù‡ Ø±Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ø¨Ø¯Ù‡
    value = value.replace(/[^\d\-\.]/g, '');

    // Ø­Ø¯Ø§Ú©Ø«Ø± 20 Ú©Ø§Ø±Ø§Ú©ØªØ±
    value = value.slice(0, 20);

    input.value = value;
  } catch (e) {
    console.error('formatProjectCode error', e);
  }
}
window.formatProjectCode = formatProjectCode;
  /* ---------- Approved Shares Page ---------- */
function renderApprovedShares() {
  try {
    const records = (allData || []).filter(r => r && r.type === 'attendance' && !!r.sharedApproved).sort((a,b)=> (b.approvedAt||b.timestamp||0) - (a.approvedAt||a.timestamp||0));
    const container = document.getElementById('approvedSharesPageList');
    if (!container) return;
    if (!records || records.length === 0) {
      container.innerHTML = '<div class="content-card">âœ… Ù‡ÛŒÚ† Ø­Ø¶ÙˆØ± ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
      return;
    }

    const rows = records.map(r => {
      const approver = r.approvedBy || 'â€”';
      const at = r.approvedAt ? (new Date(r.approvedAt)).toLocaleString('fa-IR') : 'â€”';
      const owner = escapeHtml(r.owner || r.person_name || 'â€”');
      const person = escapeHtml(r.person_name || 'â€”');
      const date = escapeHtml(r.date || 'â€”');
      const entry = escapeHtml(r.entry_time || 'â€”');
      const exit = escapeHtml(r.exit_time || 'â€”');
      const hours = escapeHtml(r.work_hours || 'â€”');
      const desc = r.work_description ? `<div style="margin-top:8px;color:#556">ğŸ“ ${escapeHtml(r.work_description)}</div>` : '';
      return `<div class="content-card" style="margin-bottom:8px">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap">
          <div style="font-weight:800">${person} â€” ${owner}</div>
          <div style="font-size:0.9rem;color:#666">ØªØ£ÛŒÛŒØ¯Ú©Ù†Ù†Ø¯Ù‡: ${escapeHtml(approver)}</div>
        </div>
        <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap">
          <div>ğŸ“… ${date}</div>
          <div>ğŸŸ¢ ${entry}</div>
          <div>ğŸ”´ ${exit}</div>
          <div>â±ï¸ ${hours}</div>
        </div>
        ${desc}
        <div style="font-size:0.85rem;color:#999;margin-top:6px">ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡: ${escapeHtml(at)}</div>
      </div>`;
    }).join('');
    container.innerHTML = rows;
  } catch (e) { console.error('renderApprovedShares error', e); }
}
window.renderApprovedShares = renderApprovedShares;

function exportApprovedSharesCSV() {
  try {
    const records = (allData || []).filter(r => r && r.type === 'attendance' && !!r.sharedApproved).sort((a,b)=> (b.approvedAt||b.timestamp||0) - (a.approvedAt||a.timestamp||0));
    if (!records || records.length === 0) { showMessage('âš ï¸ Ø­Ø¶ÙˆØ± ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c'); return; }
    const header = ['person_name','owner','date','entry_time','exit_time','work_hours','approvedBy','approvedAt'];
    const rows = records.map(r => [
      r.person_name || '',
      r.owner || '',
      r.date || '',
      r.entry_time || '',
      r.exit_time || '',
      r.work_hours || '',
      r.approvedBy || '',
      r.approvedAt ? new Date(r.approvedAt).toISOString() : ''
    ]);
    const csv = [header, ...rows].map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); 
    a.href = url; 
    a.download = `approved-shares-${new Date().toISOString().split('T')[0]}.csv`; 
    a.click(); 
    URL.revokeObjectURL(url);
    showMessage('âœ… Ø®Ø±ÙˆØ¬ÛŒ CSV Ø¢Ù…Ø§Ø¯Ù‡ Ø´Ø¯', 'var(--accent)');
  } catch (e) { console.error('exportApprovedSharesCSV error', e); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); }
}
window.exportApprovedSharesCSV = exportApprovedSharesCSV;

  /* ---------- Calculate work hours ---------- */
  function calculateWorkHours() {
    try {
      const records = (allData || []).filter(i => i.type === 'attendance');
      const role = localStorage.getItem('fibotic_role') || '';
      const logged = localStorage.getItem('fibotic_logged_in') || '';

      // helper: compute minutes for a record
      function minutesForRecord(r) {
        if (typeof r.work_minutes === 'number') return r.work_minutes;
        const entry = r.entry_time || '00:00';
        const exit = r.exit_time || '00:00';
        const [eh, em] = entry.split(':').map(Number);
        const [xh, xm] = exit.split(':').map(Number);
        let diff = (xh * 60 + xm) - (eh * 60 + em);
        if (diff < 0) diff += 24 * 60;
        return diff;
      }

      if (role === 'admin') {
        // Admin: show table of per-user totals BUT only include sharedApproved === true records
        const filtered = records.filter(r => !!r.sharedApproved);
        if (filtered.length === 0) {
          showMessage('âš ï¸ Ø±Ú©ÙˆØ±Ø¯ ØªØ£ÛŒÛŒØ¯Ø´Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c');
          return;
        }
        const totals = {}; let grand = 0;
        filtered.forEach(r => {
          const owner = (r.owner && r.owner.trim()) ? r.owner : (r.person_name && r.person_name.trim()) ? r.person_name : 'Ù†Ø§Ù…Ø´Ø®Øµ';
          const mins = minutesForRecord(r);
          totals[owner] = (totals[owner] || 0) + mins;
          grand += mins;
        });

        // build table HTML
        let rows = '';
        Object.keys(totals).sort().forEach(u => {
          const mins = totals[u];
          rows += `<tr><td style="padding:8px;border:1px solid #ddd">${escapeHtml(u)}</td><td style="padding:8px;border:1px solid #ddd">${Math.floor(mins/60)}Ø³ ${mins%60}Ø¯</td></tr>`;
        });
        const modal = document.createElement('div');
        modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
        const content = document.createElement('div');
        content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:720px;width:92%;max-height:80%;overflow:auto';
        content.innerHTML = `<h3 style="margin-top:0">ğŸ“‹ Ø³Ø§Ø¹Ø§Øª Ú©Ø§Ø±ÛŒ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡ â€” Ù…Ø¬Ù…ÙˆØ¹ Ø¨Ù‡ Ø§Ø²Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±</h3>
          <table style="width:100%;border-collapse:collapse;margin-top:8px">
            <thead><tr style="background:#f0f0f0"><th style="padding:8px;border:1px solid #ddd">Ú©Ø§Ø±Ø¨Ø±</th><th style="padding:8px;border:1px solid #ddd">Ù…Ø¬Ù…ÙˆØ¹</th></tr></thead>
            <tbody>${rows}</tbody>
          </table>
          <div style="background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#fff;padding:12px;border-radius:8px;text-align:center;margin-top:12px"><strong>Ù…Ø¬Ù…ÙˆØ¹ Ú©Ù„ÛŒ: ${Math.floor(grand/60)}Ø³ ${grand%60}Ø¯</strong></div>
          <div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeWorkHoursAdmin" class="btn-primary">Ø¨Ø³ØªÙ†</button></div>`;
        modal.appendChild(content);
        document.body.appendChild(modal);
        document.getElementById('closeWorkHoursAdmin').onclick = () => modal.remove();
        return;
      }

      // Non-admin user: show only their own total (owner===logged OR person_name===logged)
      if (!logged) { showMessage('âš ï¸ Ù„Ø·ÙØ§ Ø§Ø¨ØªØ¯Ø§ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', '#e74c3c'); return; }
      const userFiltered = records.filter(r => (r.owner && r.owner === logged) || (r.person_name && r.person_name === logged));
      if (userFiltered.length === 0) { showMessage('âš ï¸ Ø±Ú©ÙˆØ±Ø¯ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c'); return; }
      let total = 0;
      userFiltered.forEach(r => { total += minutesForRecord(r); });
      const h = Math.floor(total/60), m = total%60;
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:420px;width:92%;max-height:80%;overflow:auto;text-align:center';
      content.innerHTML = `<h3 style="margin-top:0">â±ï¸ Ù…Ø¬Ù…ÙˆØ¹ Ø³Ø§Ø¹Øª Ú©Ø§Ø±ÛŒ Ø´Ù…Ø§</h3><div style="padding:12px;background:#f8f9fb;border-radius:8px;margin-top:8px;font-weight:700">${h}Ø³ ${m}ï¿½ï¿½</div><div style="display:flex;justify-content:flex-end;margin-top:12px"><button id="closeWorkHoursUser" class="btn-primary">Ø¨Ø³ØªÙ†</button></div>`;
      modal.appendChild(content);
      document.body.appendChild(modal);
      document.getElementById('closeWorkHoursUser').onclick = () => modal.remove();
    } catch (e) {
      console.error('calculateWorkHours error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø³Ø§Ø¹Ø§Øª', '#e74c3c');
    }
  }
  window.calculateWorkHours = calculateWorkHours;

  /* ---------- Other UI functions (tar/port/colors) unchanged (omitted here for brevity in analysis) ---------- */

  function findTar12() {
    document.activeElement.blur();
    const tarNum = parseInt(document.getElementById('tarInput12')?.value);
    const info = document.getElementById('tarInfo12');
    if (!tarNum || tarNum < 1 || tarNum > 144) { showMessage('âš ï¸ Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± (1-144) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
    const loopNum = Math.ceil(tarNum / 12);
    const fiberInLoop = ((tarNum - 1) % 12) + 1;
    const tubeColor = colors[(loopNum - 1) % 12];
    const fiberColor = colors[fiberInLoop - 1];

    const textColor = fiberColor.code;
    const titleShadow = getContrast(textColor) === '#fff' ? 'text-shadow:0 0 2px rgba(0,0,0,0.35);' : 'text-shadow:0 0 2px rgba(255,255,255,0.35);';
    
    info.innerHTML = `
      <div class="content-card" style="text-align:center">
        <div class="tar-result-title" style="color:${textColor}; ${titleShadow}">ØªØ§Ø± ${tarNum}</div>
        <div class="tar-result-sub" style="justify-content:center">
          <div>ØªÛŒÙˆØ¨ <strong>${loopNum}</strong> â€” Ú©Ø± <strong>${fiberInLoop}</strong></div>
        </div>
        <div style="display:flex;justify-content:center;align-items:center;margin-top:20px">
          <div style="position:relative;width:120px;height:120px;border-radius:50%;background:${tubeColor.code};box-shadow:0 4px 15px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;border:4px solid rgba(255,255,255,0.4)">
            <div style="position:absolute;left:50%;width:120px;height:10px;background:${fiberColor.code};box-shadow:0 0 10px rgba(0,0,0,0.4);border-radius:0 5px 5px 0"></div>
          </div>
        </div>
        <div style="margin-top:15px;display:flex;justify-content:center;gap:10px">
          <span style="color:${tubeColor.code}; font-weight:800; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.8)">${escapeHtml(getColorNameByHex(tubeColor.code))}</span>
          <span style="color:${fiberColor.code}; font-weight:800; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.8)">${escapeHtml(getColorNameByHex(fiberColor.code))}</span>
        </div>
      </div>`;
  }
  window.findTar12 = findTar12;

  function findTar6() {
    document.activeElement.blur();
    const tarNum = parseInt(document.getElementById('tarInput6')?.value);
    const info = document.getElementById('tarInfo6');
    if (!tarNum || tarNum < 1 || tarNum > 72) { showMessage('âš ï¸ Ø´Ù…Ø§Ø±Ù‡ Ù…Ø¹ØªØ¨Ø± (1-72) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯', '#e74c3c'); return; }
    const tubeNum = Math.ceil(tarNum / 6);
    const core = ((tarNum - 1) % 6) + 1;
    const tubeColor = colors[(tubeNum - 1) % 12];
    const coreColor = colors[core - 1];

    const textColor = coreColor.code;
    const titleShadow = getContrast(textColor) === '#fff' ? 'text-shadow:0 0 2px rgba(0,0,0,0.35);' : 'text-shadow:0 0 2px rgba(255,255,255,0.35);';
    
    info.innerHTML = `
      <div class="content-card" style="text-align:center">
        <div class="tar-result-title" style="color:${textColor}; ${titleShadow}">ØªØ§Ø± ${tarNum}</div>
        <div class="tar-result-sub" style="justify-content:center">
          <div>ØªÛŒÙˆØ¨ <strong>${tubeNum}</strong> â€” Ú©Ø± <strong>${core}</strong></div>
        </div>
        <div style="display:flex;justify-content:center;align-items:center;margin-top:20px">
          <div style="position:relative;width:120px;height:120px;border-radius:50%;background:${tubeColor.code};box-shadow:0 4px 15px rgba(0,0,0,0.3);display:flex;justify-content:center;align-items:center;border:4px solid rgba(255,255,255,0.4)">
            <div style="position:absolute;left:50%;width:120px;height:10px;background:${coreColor.code};box-shadow:0 0 10px rgba(0,0,0,0.4);border-radius:0 5px 5px 0"></div>
          </div>
        </div>
        <div style="margin-top:15px;display:flex;justify-content:center;gap:10px">
          <span style="color:${tubeColor.code}; font-weight:800; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.8)">${escapeHtml(getColorNameByHex(tubeColor.code))}</span>
          <span style="color:${coreColor.code}; font-weight:800; padding:4px 8px; border-radius:6px; background:rgba(255,255,255,0.8)">${escapeHtml(getColorNameByHex(coreColor.code))}</span>
        </div>
      </div>`;
  }
  window.findTar6 = findTar6;

  function handleEnter(e, func) {
    if (e.key === 'Enter') {
      func();
    }
  }
  window.handleEnter = handleEnter;

  function displayCableColors() {
    const container = document.getElementById('cableContainer');
    if (!container) return;
    container.innerHTML = '';

    // ØªØ¹Ø±ÛŒÙ Ø³Ù‡ Ù…Ø¯Ù„ Ú©Ø§Ø¨Ù„
    const cableModels = [
        {
            name: 'ğŸŸ¦ Ù…Ø¯Ù„ Ø§ÙˆÙ„ â€” Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ ITU-T',
            colors: [
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ù‚Ø±Ù…Ø²', code: '#FF0000' },
                { name: 'Ø³Ø¨Ø²', code: '#00FF00' },
                { name: 'Ø¢Ø¨ÛŒ', code: '#0000FF' },
                { name: 'Ø²Ø±Ø¯', code: '#FFFF00' },
                { name: 'Ù…Ø´Ú©ÛŒ', code: '#000000' },
                { name: 'Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ', code: '#8B4513' },
                { name: 'Ø¨Ù†ÙØ´', code: '#800080' },
                { name: 'Ù†Ø§Ø±Ù†Ø¬ÛŒ', code: '#FFA500' },
                { name: 'ØµÙˆØ±ØªÛŒ', code: '#FFC0CB' },
                { name: 'Ø®Ø§Ú©Ø³ØªØ±ÛŒ', code: '#808080' },
                { name: 'ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ', code: '#00FFFF' }
            ]
        },
        {
            name: 'ğŸŸ¥ Ù…Ø¯Ù„ Ø¯ÙˆÙ… â€” Ø§Ù„Ú¯ÙˆÛŒ Ø¯ÙˆØªØ§ÛŒÛŒ (12 ØªØ§Ø±)',
            colors: [
                { name: 'Ù‚Ø±Ù…Ø²', code: '#FF0000' },
                { name: 'Ø¢Ø¨ÛŒ', code: '#0000FF' },
                { name: 'Ø²Ø±Ø¯', code: '#FFFF00' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' }
            ]
        },
        {
            name: 'ğŸŸ© Ù…Ø¯Ù„ Ø³ÙˆÙ… â€” Ø§Ù„Ú¯ÙˆÛŒ ÛŒÚ©ÛŒ (12 ØªØ§Ø±)',
            colors: [
                { name: 'Ù‚Ø±Ù…Ø²', code: '#FF0000' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' },
                { name: 'Ø³ÙÛŒØ¯', code: '#FFFFFF' }
            ]
        }
    ];

    // Ø§ÛŒØ¬Ø§Ø¯ wrapper Ø¨Ø±Ø§ÛŒ 3 Ø³ØªÙˆÙ† Ú©Ù†Ø§Ø± Ù‡Ù…
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'display:grid;grid-template-columns:repeat(3,1fr);gap:16px;width:100%';

    // Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ù…Ø¯Ù„ Ú©Ø§Ø¨Ù„
    cableModels.forEach((model, modelIdx) => {
        const modelCard = document.createElement('div');
        modelCard.style.cssText = 'background:linear-gradient(135deg,#667eea,#764ba2);padding:16px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)';

        // Ø¹Ù†ÙˆØ§Ù† Ù…Ø¯Ù„
        const modelTitle = document.createElement('div');
        modelTitle.style.cssText = 'color:#fff;font-weight:800;font-size:15px;margin-bottom:12px;text-align:center';
        modelTitle.textContent = model.name;
        modelCard.appendChild(modelTitle);

        // Ø³ØªÙˆÙ† Ø¨Ø±Ø§ÛŒ Ø±Ù†Ú¯â€ŒÙ‡Ø§ (ÛŒÚ©ÛŒ Ù¾Ø§ÛŒÛŒÙ† ÛŒÚ©ÛŒ)
        const colorColumn = document.createElement('div');
        colorColumn.style.cssText = 'display:flex;flex-direction:column;gap:6px';

        model.colors.forEach((color, idx) => {
            const colorBox = document.createElement('div');
            colorBox.style.cssText = `
                background:${color.code};
                color:${color.code.toUpperCase() === '#FFFFFF' || color.code.toUpperCase() === '#FFFF00' ? '#000' : '#fff'};
                padding:10px;
                border-radius:8px;
                text-align:center;
                font-weight:700;
                font-size:12px;
                box-shadow:0 2px 6px rgba(0,0,0,0.2);
                border:2px solid rgba(255,255,255,0.3);
                transition:transform 0.2s,box-shadow 0.2s;
                cursor:pointer;
                display:flex;
                align-items:center;
                justify-content:space-between;
                padding-left:8px;
                padding-right:8px;
            `;
            colorBox.innerHTML = `<span style="font-weight:800;font-size:13px">${idx + 1}</span><span style="flex:1;text-align:center">${color.name}</span>`;
            
            // Ø§ÙÚ©Øª hover
            colorBox.addEventListener('mouseenter', function(){
                this.style.transform = 'translateX(4px)';
                this.style.boxShadow = '0 4px 16px rgba(0,0,0,0.3)';
            });
            colorBox.addEventListener('mouseleave', function(){
                this.style.transform = 'translateX(0)';
                this.style.boxShadow = '0 2px 6px rgba(0,0,0,0.2)';
            });

            colorColumn.appendChild(colorBox);
        });

        modelCard.appendChild(colorColumn);

        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø¯Ù„
        const info = document.createElement('div');
        info.style.cssText = 'background:rgba(255,255,255,0.1);padding:10px;border-radius:8px;margin-top:12px;color:#fff;font-size:11px;text-align:center';
        info.textContent = `ğŸ“Œ Ù…Ø¬Ù…ÙˆØ¹ ØªØ§Ø±Ù‡Ø§: ${model.colors.length}`;
        modelCard.appendChild(info);

        wrapper.appendChild(modelCard);
    });

    container.appendChild(wrapper);
}
  window.displayCableColors = displayCableColors;

  function setupPorts() {
    const container = document.getElementById('panelContainer'); if (!container) return;
    container.innerHTML = '';
    for (let panel = 1; panel <= 3; panel++) {
      const panelDiv = document.createElement('div'); panelDiv.style.marginBottom = '12px';
      const title = document.createElement('div'); title.style.background = 'linear-gradient(90deg,#34495e,#2c3e50)'; title.style.color = '#fff'; title.style.padding = '8px'; title.style.borderRadius = '8px'; title.style.fontWeight = '700';
      const start = (panel - 1) * 48 + 1; const end = panel * 48;
      title.textContent = `Ù¾Ú† Ù¾Ù†Ù„ ${panel} (${start}-${end})`;
      panelDiv.appendChild(title);
      const ports = document.createElement('div'); ports.style.display = 'grid'; ports.style.gridTemplateColumns = 'repeat(24,1fr)'; ports.style.gap = '6px'; ports.style.padding = '8px'; ports.style.background = '#fff'; ports.style.borderRadius = '8px';
    ports.style.direction = 'ltr'; // Ensure left-to-right flow for grid items
      for (let col = 0; col < 24; col++) {
        const adapter = document.createElement('div'); adapter.style.display = 'flex'; adapter.style.flexDirection = 'column'; adapter.style.gap = '6px';
        const top = document.createElement('div'); const bottom = document.createElement('div');
        top.className = 'duplex-port'; bottom.className = 'duplex-port';
        // Correct port numbering: Odd bottom, Even top
        top.dataset.portNum = start + col * 2 + 1;
        bottom.dataset.portNum = start + col * 2;
        top.style.cursor = 'pointer'; bottom.style.cursor = 'pointer';
        adapter.appendChild(top); adapter.appendChild(bottom);
        // click handler
        top.addEventListener('click', () => { highlightPortByNum(parseInt(top.dataset.portNum)); });
        bottom.addEventListener('click', () => { highlightPortByNum(parseInt(bottom.dataset.portNum)); });
        ports.appendChild(adapter);
      }
      panelDiv.appendChild(ports); container.appendChild(panelDiv);
    }
  }
  window.setupPorts = setupPorts;

  function highlightPort() {
    document.activeElement.blur();
    const value = parseInt(document.getElementById('portInput')?.value);
    if (!value || value < 1 || value > 144) { document.getElementById('portInfo').innerHTML = '<span style="color:#e74c3c">âš ï¸ Ø´Ù…Ø§Ø±Ù‡ Ù¾ÙˆØ±Øª Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</span>'; return; }
    highlightPortByNum(value);
  }
  window.highlightPort = highlightPort;

  function highlightPortByNum(portNum) {
    try {
      document.querySelectorAll('.duplex-port').forEach(p => { p.style.background = '#ecf0f1'; p.style.boxShadow = 'none'; });
      const el = document.querySelector(`.duplex-port[data-port-num="${portNum}"]`);
      if (el) { el.style.background = '#e74c3c'; el.style.boxShadow = '0 0 14px rgba(231,76,60,0.9)'; el.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
      const loopNum = Math.ceil(portNum / 12);
      const fiberInLoop = ((portNum - 1) % 12) + 1;
      const tubeColor = colors[(loopNum - 1) % 12];
      const fiberColor = colors[fiberInLoop - 1];
      const panelNum = Math.ceil(portNum / 48);
      const portInPanel = ((portNum - 1) % 48) + 1;
      const infoEl = document.getElementById('portInfo');
      if (infoEl) infoEl.innerHTML = `<div><strong>âœ… Ù¾ÙˆØ±Øª ${portNum}</strong></div><div>Ù¾Ú† Ù¾Ù†Ù„ ${panelNum} - Ù¾ÙˆØ±Øª ${portInPanel}</div><div>ØªÛŒÙˆØ¨ ${loopNum} (<span style="color:${tubeColor.code};font-weight:800">${escapeHtml(tubeColor.name)}</span>) - Ú©Ø± ${fiberInLoop} (<span style="color:${fiberColor.code};font-weight:800">${escapeHtml(fiberColor.name)}</span>)</div>`;
    } catch (e) { console.error('highlightPortByNum error', e); }
  }
  /* ========== PROFESSIONAL Training System v3 ========== */

  // Training content with complete materials and image support
  const trainingContent = {
    levels: [
      {
        id: 1,
        title: "Ø³Ø·Ø­ 1 â€” Ù…Ù‚Ø¯Ù…Ø§ØªÛŒ",
        subtitle: "Ø´Ù†Ø§Ø®Øª Ùˆ Ù…Ø¨Ø§Ù†ÛŒ",
        target: "Ø¨Ø±Ø§ÛŒ Ø§ÙØ±Ø§Ø¯ ØªØ§Ø²Ù‡â€ŒÚ©Ø§Ø±",
        icon: "ğŸŒ±",
        chapters: [
          {
            id: 'ch-1-1',
            title: "Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ø¨Ù„ ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ",
            description: "Ø¢Ø´Ù†Ø§ÛŒÛŒ Ø¨Ø§ Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ÛŒ ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ Ùˆ ØªÙØ§ÙˆØª Ø¢Ù†Ù‡Ø§",
            duration: "15 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ù†ÙˆØ§Ø¹ Ø§ØµÙ„ÛŒ Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ÛŒ ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">1ï¸âƒ£ ÙÛŒØ¨Ø± ØªÚ©ÛŒ (Single Mode)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ Ø¨Ø±Ø§ÛŒ ÙÙˆØ§ØµÙ„ Ø¯ÙˆØ± Ùˆ Ø³Ø±Ø¹Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ø§Ù„Ø§</div>
                  <div style="font-size:13px;color:#666">â€¢ Ù‚Ø·Ø± Ù‡Ø³ØªÙ‡: Û¸ Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ±</div>
                  <div style="font-size:13px;color:#666">â€¢ Ø±Ù†Ú¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯: Ø²Ø±Ø¯</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">2ï¸âƒ£ ÙÛŒØ¨Ø± Ú†Ù†Ø¯ØªØ§ÛŒÛŒ (Multi Mode)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ Ø¨Ø±Ø§ÛŒ ÙÙˆØ§ØµÙ„ Ú©ÙˆØªØ§Ù‡â€ŒØªØ±</div>
                  <div style="font-size:13px;color:#666">â€¢ Ù‚Ø·Ø± Ù‡Ø³ØªÙ‡: Û¶Û²Ù«Ûµ ÛŒØ§ ÛµÛ° Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ±</div>
                  <div style="font-size:13px;color:#666">â€¢ Ø±Ù†Ú¯ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯: Ù†Ø§Ø±Ù†Ø¬ÛŒ ÛŒØ§ Ù‚Ø±Ù…Ø²</div>
                </div>
                <h4 style="margin-top:16px;color:#667eea">Ù…Ø´Ø®ØµØ§Øª Ú©Ù„ÛŒØ¯ÛŒ:</h4>
                <table style="width:100%;border-collapse:collapse;font-size:13px;margin-top:8px">
                  <tr style="background:#f0f2ff">
                    <th style="padding:8px;border:1px solid #ddd">ÙˆÛŒÚ˜Ú¯ÛŒ</th>
                    <th style="padding:8px;border:1px solid #ddd">Single Mode</th>
                    <th style="padding:8px;border:1px solid #ddd">Multi Mode</th>
                  </tr>
                  <tr>
                    <td style="padding:8px;border:1px solid #ddd">ÙØ§ØµÙ„Ù‡</td>
                    <td style="padding:8px;border:1px solid #ddd">Û´Û° Ú©ÛŒÙ„ÙˆÙ…ØªØ±+</td>
                    <td style="padding:8px;border:1px solid #ddd">Û² Ú©ÛŒÙ„ÙˆÙ…ØªØ±</td>
                  </tr>
                  <tr style="background:#f8f9fb">
                    <td style="padding:8px;border:1px solid #ddd">Ù‚ÛŒÙ…Øª</td>
                    <td style="padding:8px;border:1px solid #ddd">Ú¯Ø±Ø§Ù†ØªØ±</td>
                    <td style="padding:8px;border:1px solid #ddd">Ø§Ø±Ø²Ø§Ù†â€ŒØªØ±</td>
                  </tr>
                </table>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-1-2',
            title: "Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯",
            description: "ÛŒØ§Ø¯Ú¯ÛŒØ±ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø±Ù†Ú¯â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ØªØ§Ø±Ù‡Ø§",
            duration: "10 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">ØªØ±ØªÛŒØ¨ Ø±Ù†Ú¯â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ (12 Ø±Ù†Ú¯):</h4>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:8px">
                  <div style="background:#FFFFFF;border:2px solid #999;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û±. Ø³ÙÛŒØ¯</div>
                  <div style="background:#FF0000;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û². Ù‚Ø±Ù…Ø²</div>
                  <div style="background:#00FF00;color:#000;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û³. Ø³Ø¨Ø²</div>
                  <div style="background:#0000FF;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û´. Ø¢Ø¨ÛŒ</div>
                  <div style="background:#FFFF00;color:#000;padding:8px;border-radius:6px;text-align:center;font-weight:700">Ûµ. Ø²Ø±Ø¯</div>
                  <div style="background:#000000;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û¶. Ù…Ø´Ú©ÛŒ</div>
                  <div style="background:#8B4513;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û·. Ù‚Ù‡ÙˆÙ‡â€ŒØ§ÛŒ</div>
                  <div style="background:#800080;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û¸. Ø¨Ù†ÙØ´</div>
                  <div style="background:#FFA500;color:#000;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û¹. Ù†Ø§Ø±Ù†Ø¬ÛŒ</div>
                  <div style="background:#FFC0CB;color:#000;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û±Û°. ØµÙˆØ±ØªÛŒ</div>
                  <div style="background:#808080;color:#fff;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û±Û±. Ø®Ø§Ú©Ø³ØªØ±ÛŒ</div>
                  <div style="background:#00FFFF;color:#000;padding:8px;border-radius:6px;text-align:center;font-weight:700">Û±Û². ÙÛŒØ±ÙˆØ²Ù‡â€ŒØ§ÛŒ</div>
                </div>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #ffc107">
                  <strong>ğŸ’¡ Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…:</strong> Ù‡Ø± Û±Û² ØªØ§Ø± = ÛŒÚ© ØªÛŒÙˆØ¨. Ø±Ù†Ú¯ ØªÛŒÙˆØ¨ + Ø±Ù†Ú¯ ØªØ§Ø± = Ø´Ù…Ø§Ø±Ù‡ ÙÛŒØ²ÛŒÚ©ÛŒ
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-1-3',
            title: "Ø³Ø§Ø®ØªØ§Ø± ÙÛŒØ²ÛŒÚ©ÛŒ Ú©Ø§Ø¨Ù„",
            description: "Ø¯Ø±Ú© Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø§Ø®Ù„ÛŒ Ú©Ø§Ø¨Ù„ Ùˆ Ø§Ø¬Ø²Ø§ÛŒ ØªØ´Ú©ÛŒÙ„â€ŒØ¯Ù‡Ù†Ø¯Ù‡",
            duration: "12 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ø¬Ø²Ø§ÛŒ Ú©Ø§Ø¨Ù„ ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ¯ Ù‡Ø³ØªÙ‡ (Core)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">Ù‚Ø·Ø± Û¸ ÛŒØ§ Û¶Û²Ù«Ûµ Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ± - Ø¬Ø§ÛŒ Ø¹Ø¨ÙˆØ± Ù†ÙˆØ±</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ›¡ï¸ Ù¾ÙˆØ³ØªÙ‡ (Cladding)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">Ù‚Ø·Ø± Û±Û²Ûµ Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ± - Ù…Ø­Ø§ÙØ¸Øª Ø§Ø² Ù‡Ø³ØªÙ‡</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“¦ Ø¨Ø§ÙØ± (Buffer Coating)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">Ù‚Ø·Ø± Û²ÛµÛ° Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ± - Ø­ÙØ§Ø¸Øª Ø§Ø² Ø®Ø³Ø§Ø±Øª</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ ØºÙ„Ø§Ù Ø®Ø§Ø±Ø¬ÛŒ (Jacket)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">Ù‚Ø·Ø± Û¹Û°Û° Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ± - Ù…Ø­Ø§ÙØ¸Øª Ú©Ù„ÛŒ</div>
                </div>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #ffc107">
                  <strong>âš ï¸ ØªÙˆØ¬Ù‡:</strong> ØªØ§Ø± ØªÚ© Û¹Û°Û° Ù…ÛŒÚ©Ø±ÙˆÙ…ØªØ± Ø§Ø³ØªØŒ Ø§Ù…Ø§ ÙˆÙ‚ØªÛŒ Û±Û² ØªØ§Ø± Ú©Ù†Ø§Ø± Ù‡Ù… Ù‚Ø±Ø§Ø± Ú¯ÛŒØ±Ù†Ø¯ØŒ ØªÛŒÙˆØ¨ ØªØ´Ú©ÛŒÙ„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-1-4',
            title: "ØªØ¬Ù‡ÛŒØ²Ø§Øª Ù¾Ø§ÛŒÙ‡",
            description: "Ù…Ø¹Ø±ÙÛŒ ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø¶Ø±ÙˆØ±ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø± Ø¨Ø§ ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ",
            duration: "20 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">ØªØ¬Ù‡ÛŒØ²Ø§Øª Ø§Ø³Ø§Ø³ÛŒ ÙÛŒÙ„Ø¯:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ”§ Ø¯Ø³ØªÚ¯Ø§Ù‡ ÙÛŒÙˆÚ˜Ù† (Fusion Splicer)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ Ø§ØªØµØ§Ù„ Ø¯Ùˆ ØªØ§Ø± Ø¨ÙˆØ³ÛŒÙ„Ù‡ Ú¯Ø±Ù…Ø§</div>
                  <div style="font-size:13px;color:#666">â€¢ Ø¶Ø§ÛŒØ¹Ø§Øª Ú©Ù…ØªØ± Ø§Ø² Û°Ù«Û± Ø¯Ø³ÛŒâ€ŒØ¨Ù„</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“ Ø§Ø³Ú©Ø±ÛŒÙ¾Ø± (Striper)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ Ø¨Ø±Ø¯Ø§Ø´ØªÙ† ØºÙ„Ø§Ù Ùˆ Ø¨Ø§ÙØ±</div>
                  <div style="font-size:13px;color:#666">â€¢ Ø¯Ù‚Øª Û± Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸŒ¡ï¸ Ú©Ù„ÛŒÙˆØ± (Cleaver)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ Ø¨Ø±Ø´ ØµØ­ÛŒØ­ Ø§Ù†ØªÙ‡Ø§ÛŒ ØªØ§Ø±</div>
                  <div style="font-size:13px;color:#666">â€¢ Ø²Ø§ÙˆÛŒÙ‡ Û¹Û° Ø¯Ø±Ø¬Ù‡</div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“Š OTDR (Optical Time-Domain Reflectometer)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">â€¢ ØªØ³Øª Ú©ÛŒÙÛŒØª Ø®Ø·</div>
                  <div style="font-size:13px;color:#666">â€¢ ØªØ´Ø®ÛŒØµ Ù†Ù‚Ø§Ø· Ø¶Ø¹ÛŒÙ</div>
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-1-5',
            title: "Ø§ØµÙˆÙ„ Ø§Ù†ØªÙ‚Ø§Ù„ Ù†ÙˆØ±",
            description: "Ø§ØµÙˆÙ„ ÙÛŒØ²ÛŒÚ©ÛŒ Ø§Ù†ØªÙ‚Ø§Ù„ Ù†ÙˆØ± Ø¯Ø± ÙÛŒØ¨Ø± Ù†ÙˆØ±ÛŒ",
            duration: "18 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ú†Ú¯ÙˆÙ†Ù‡ Ù†ÙˆØ± Ø§Ø² ÙÛŒØ¨Ø± Ø¹Ø¨ÙˆØ± Ù…ÛŒâ€ŒÚ©Ù†Ø¯:</h4>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb">Û±. Ø§Ù†Ø¹Ú©Ø§Ø³ Ú©Ù„ÛŒ Ø¯Ø§Ø®Ù„ÛŒ (Total Internal Reflection)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    Ù†ÙˆØ± Ø¯Ø± Ù‡Ø³ØªÙ‡ (Ú©Ù‡ Ø´Ø§Ø®Øµ Ø§Ù†Ú©Ø³Ø§Ø±ÛŒ Ø¨ÛŒØ´ØªØ±ÛŒ Ø¯Ø§Ø±Ø¯) Ù…Ø­ØµÙˆØ± Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø¨Ù‡ Ø³Ù…Øªâ€ŒÙ‡Ø§ÛŒ Ú©Ù†Ø§Ø± Ù…Ù†Ø¹Ú©Ø³ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                  </div>
                </div>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb">Û². Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø­Ø±Ø§Ù†ÛŒ (Critical Angle)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    Ø§Ú¯Ø± Ù†ÙˆØ± Ø¯Ø± Ø²Ø§ÙˆÛŒÙ‡ Ú©Ù…ØªØ±ÛŒ Ø¨Ø±Ø®ÙˆØ±Ø¯ Ú©Ù†Ø¯ØŒ Ù…Ø³ØªÙ‚ÛŒÙ… Ø®Ø§Ø±Ø¬ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ø¨Ø±Ø§ÛŒ Single Mode: ~Û¸ Ø¯Ø±Ø¬Ù‡
                  </div>
                </div>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb">Û³. Ø·ÙˆÙ„ Ù…ÙˆØ¬ (Wavelength)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Û±Û³Û±Û° Ù†Ø§Ù†ÙˆÙ…ØªØ± - Single Mode
                    <br>â€¢ Û±ÛµÛµÛ° Ù†Ø§Ù†ÙˆÙ…ØªØ± - Long Distance
                    <br>â€¢ Û¸ÛµÛ° Ù†Ø§Ù†ÙˆÙ…ØªØ± - Multi Mode
                  </div>
                </div>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #ffc107">
                  <strong>ğŸ’¡ Ù†ØªÛŒØ¬Ù‡:</strong> Ù†ÙˆØ± Ø¯Ø± ÙÛŒØ¨Ø± "Ù¾Ø±ÛŒØ¯Ù‡" Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ Ú©ÛŒÙ„ÙˆÙ…ØªØ±Ù‡Ø§ Ø³ÙØ± Ú©Ù†Ø¯.
                </div>
              </div>
            `,
            images: []
          }
        ]
      },
      {
        id: 2,
        title: "Ø³Ø·Ø­ 2 â€” Ù…ØªÙˆØ³Ø·",
        subtitle: "Ø§Ø¬Ø±Ø§ Ùˆ Ø¹Ù…Ù„ÛŒØ§Øª",
        target: "Ø¨Ø±Ø§ÛŒ ØªÚ©Ù†Ø³ÛŒÙ†â€ŒÙ‡Ø§ÛŒ Ú©Ø§Ø±Ú¯Ø§Ù‡ÛŒ",
        icon: "âš™ï¸",
        chapters: [
          {
            id: 'ch-2-1',
            title: "ÙØ±Ø§ÛŒÙ†Ø¯ ÙÛŒÙˆÚ˜Ù† (Fusion Splicing)",
            description: "Ø¢Ù…ÙˆØ²Ø´ Ù…Ø±Ø­Ù„Ù‡â€ŒØ¨Ù‡â€ŒÙ…Ø±Ø­Ù„Ù‡ ÙØ±Ø§ÛŒÙ†Ø¯ ÙÛŒÙˆÚ˜Ù† Ùˆ Ù†Ú©Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ",
            duration: "25 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ù…Ø±Ø§Ø­Ù„ ÙÛŒÙˆÚ˜Ù†:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:16px">Ù…Ø±Ø­Ù„Ù‡ Û±: Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ ØªØ§Ø± Ø±Ø§ Ûµ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ø®Ø§Ø±Ø¬ Ø§Ø² Ú©ÛŒØ³Ù‡ Ú©Ø´ÛŒØ¯<br>
                    âœ“ ØºÙ„Ø§Ù Ø±Ø§ Û±Û° Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ù¾ÙˆØ³Øªâ€ŒÚ©Ù†ÛŒØ¯<br>
                    âœ“ Ø¨Ø§ÙØ± Ø±Ø§ Û²-Û³ Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ± Ø¨Ø²Ù†ÛŒØ¯<br>
                    âœ“ Ø¢Ù„Ú©Ù„ Ùˆ Ù¾Ø§Ø±Ú†Ù‡ Ø®Ø´Ú© Ø¨Ø§ Ù†Ø±Ù… Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:16px">Ù…Ø±Ø­Ù„Ù‡ Û²: Ø¨Ø±Ø´ (Cleaving)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ ØªØ§Ø± Ø±Ø§ Ø¯Ø± Ú©Ù„ÛŒÙˆØ± Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯<br>
                    âœ“ Ø²Ø§ÙˆÛŒÙ‡ Ø¨Ø±Ø´: Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Û¹Û° Ø¯Ø±Ø¬Ù‡<br>
                    âœ“ Ø¹Ù„Ø§Ù…Øª Ùˆ ØµØ¯Ø§ÛŒ Ú©Ø±ÛŒÚ© Ù…Ø·Ù…Ø¦Ù† Ú©Ù†ÛŒØ¯<br>
                    âœ“ Ø§Ù†ØªÙ‡Ø§ÛŒ ØµØ§Ù Ùˆ Ø¨Ø±Ø§Ù‚ Ø¨Ø§ÛŒØ¯ Ø¨Ø§Ø´Ø¯
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:16px">Ù…Ø±Ø­Ù„Ù‡ Û³: Ø¯Ø±Ø¬ Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø±Ø§ Ø±ÙˆØ´Ù† Ùˆ Ú¯Ø±Ù… Ú©Ù†ÛŒØ¯ (Û³ Ø¯Ù‚ÛŒÙ‚Ù‡)<br>
                    âœ“ Ù‡Ø± Ø¯Ùˆ ØªØ§Ø± Ø±Ø§ Ø¨Ø·ÙˆØ± Ù…ØªÙ‚Ø§Ø¨Ù„ Ø¯Ø± Ø³ÙˆÚ©Øª Ù‚Ø±Ø§Ø± Ø¯Ù‡ÛŒØ¯<br>
                    âœ“ ØªØ§Ø± Ø±Ø§ Ø¬Ù„Ùˆ Ø¨Ø¨Ø±ÛŒØ¯ ØªØ§ Ø§Ù„Ù…Ø³ Ø´ÙˆØ¯<br>
                    âœ“ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ø®ÙˆØ¯Ú©Ø§Ø± ÙØ§ØµÙ„Ù‡ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ù…ÛŒâ€ŒÚ©Ù†Ø¯
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:16px">Ù…Ø±Ø­Ù„Ù‡ Û´: ÙÛŒÙˆÚ˜Ù†</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ Ø¯Ø³ØªÚ¯Ø§Ù‡ Ù†ÙˆØ± Ù‚ÙˆÛŒ Ø§Ø·Ø±Ø§Ù ØªØ§Ø± Ø±Ø§ Ú¯Ø±Ù… Ù…ÛŒâ€ŒÚ©Ù†Ø¯<br>
                    âœ“ Ù…Ø¯Øª: Û±Û°-Û²Û° Ø«Ø§Ù†ÛŒÙ‡<br>
                    âœ“ Ù†Ù‚Ø·Ù‡ ÙÛŒÙˆÚ˜Ù† Ø¯Ø±Ø®Ø´Ø§Ù† Ù…ÛŒâ€ŒØ´ÙˆØ¯<br>
                    âœ“ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ ØªØ§ Ø®Ù†Ú© Ø´ÙˆØ¯
                  </div>
                </div>
                <div style="background:#e8f4f8;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #2d9cdb">
                  <strong>ğŸ“Š Ù…Ø¹ÛŒØ§Ø± Ù…ÙˆÙÙ‚ÛŒØª:</strong><br>
                  âœ“ Ø¶Ø§ÛŒØ¹Ø§Øª < Û°Ù«Û± dB<br>
                  âœ“ Ø¨Ø¯ÙˆÙ† Ø­Ø¨Ø§Ø¨ Ù‡ÙˆØ§<br>
                  âœ“ Ù†Ù‚Ø·Ù‡ ÙÛŒÙˆÚ˜Ù† Ø±ÙˆØ§Ù† Ùˆ ØªÚ©ÛŒ<br>
                  âœ“ Ø±Ù†Ú¯ Ø¯Ø±Ø®Ø´Ø§Ù† (Ù†Ù‡ Ø³ÛŒØ§Ù‡)
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-2-2',
            title: "Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙØµÙ„â€ŒÙ‡Ø§",
            description: "ØªÚ©Ù†ÛŒÚ©â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ù…ÙØµÙ„â€ŒØ¨Ù†Ø¯ÛŒ Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§ÙØ±",
            duration: "20 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ù†ÙˆØ§Ø¹ Ù…ÙØµÙ„â€ŒØ¨Ù†Ø¯ÛŒ:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û±ï¸âƒ£ Ù…ÙØµÙ„â€ŒÙ‡Ø§ÛŒ ØµØºÛŒØ± (Micro Joints)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ù…ÙØµÙ„ Ø¯Ùˆ ØªØ§Ø± ÙÛŒÙˆÚ˜ Ø´Ø¯Ù‡<br>
                    â€¢ Ø·ÙˆÙ„ Û±-Û² Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ±<br>
                    â€¢ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø­ÙØ§Ø¸Øª Ø¨ÙˆØ³ÛŒÙ„Ù‡ ØªØ±Ù…ÙˆÙ†Ø´ÛŒÙ†
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û²ï¸âƒ£ Ù…ÙØµÙ„â€ŒÙ‡Ø§ÛŒ Ø±Ø§Ø¨Ø·ÛŒ (Branch Joints)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§ØªØµØ§Ù„ Ø´Ø§Ø®Ù‡â€ŒØ§ÛŒ<br>
                    â€¢ Ù†ÛŒØ§Ø² Ø¨Ù‡ splitter Ø§Ø³ØªÙØ§Ø¯Ù‡<br>
                    â€¢ Ø¨ÛŒØ´ØªØ± Ø¯Ø± Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙˆØ²ÛŒØ¹
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û³ï¸âƒ£ Ù…ÙØµÙ„â€ŒÙ‡Ø§ÛŒ ØªØ±Ù…ÛŒÙ†Ø§Ù„ (Terminal Joints)</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§ØªØµØ§Ù„ Ø¨Ù‡ ØªØ¬Ù‡ÛŒØ²Ø§Øª<br>
                    â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ú©Ø§Ù†Ú©ØªÙˆØ±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù<br>
                    â€¢ LC, SC, ST, ST
                  </div>
                </div>
                <h4 style="margin-top:16px;color:#667eea">Ù‚ÙˆØ§Ø¹Ø¯ Ù…Ø¯ÛŒØ±ÛŒØª Ø¨Ø§ÙØ±:</h4>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin:8px 0">
                  âš ï¸ <strong>Ø§ØµÙ„ Ø§ØµÙ„ÛŒ:</strong> Ø¨Ø§ÙØ± Ø¨Ø§ÛŒØ¯ <strong>Ù…Ù†Ø­Ù†ÛŒ Ø¢Ø±Ø§Ù…</strong> Ø¨Ø§Ø´Ø¯<br>
                  âŒ Ù‡Ø±Ú¯Ø² Ø¨Ø§ÙØ± Ø±Ø§ <strong>ØªÛŒØ²</strong> Ù†Ú©Ù†ÛŒØ¯ (Ù…ÛŒâ€ŒØ´Ú©Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯)<br>
                  âœ“ Ø­Ø¯Ø§Ù‚Ù„ Ø´Ø¹Ø§ï¿½ï¿½ Ø§Ù†Ø­Ù†Ø§: Û³Û° Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±<br>
                  âœ“ Ø¯Ø± Ù…Ø­ÛŒØ· Ù‡Ø§ÛŒ Ø³Ø±Ø¯ØŒ Ø¨Ø§ÙØ± Ø±Ø§ Ø¢Ø±Ø§Ù… Ø­Ø±Ú©Øª Ø¯Ù‡ÛŒØ¯
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-2-3',
            title: "Ú©Ø§Ù†Ú©ØªÙˆØ±Ù‡Ø§ Ùˆ Ø¢Ø¯Ø§Ù¾ØªÙˆØ±Ù‡Ø§",
            description: "Ù†Ø­ÙˆÙ‡ ØµØ­ÛŒØ­ Ù†ØµØ¨ Ùˆ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ù¾Ú†â€ŒÙ¾Ù†Ù„",
            duration: "22 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ù†ÙˆØ§Ø¹ Ú©Ø§Ù†Ú©ØªÙˆØ±Ù‡Ø§:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:15px">ğŸŸ¦ SC Connector</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§Ø¨Ø¹Ø§Ø¯: Û±Û² Ã— Û¸ Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±<br>
                    â€¢ ØªØ¹Ø¯Ø§Ø¯ Ù¾ÙˆØ±Øªâ€ŒÙ‡Ø§ÛŒ Ø²ÛŒØ§Ø¯<br>
                    â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡: FTTH Ø³Ù†ØªÛŒ
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:15px">ğŸŸ§ LC Connector</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§Ø¨Ø¹Ø§Ø¯: Û¸ Ã— Û¶Ù«Û²Ûµ Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±<br>
                    â€¢ ÙØ´Ø±Ø¯Ù‡â€ŒØªØ± Ø§Ø² SC<br>
                    â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡: Ø³Ø±ÙˆØ±Ù‡Ø§ Ùˆ Ú©Ø§Ù†ØªØ±ÛŒÙ„
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:15px">ğŸŸ© ST Connector</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§Ø¨Ø¹Ø§Ø¯ Ú©ÙˆÚ†Ú©<br>
                    â€¢ Ù‚ÙÙ„ Ø­Ù„Ù‚Ù‡â€ŒØ§ÛŒ<br>
                    â€¢ Ø§Ø³ØªÙØ§Ø¯Ù‡: Ø´Ø¨Ú©Ù‡â€ŒÙ‡Ø§ÛŒ Ù‚Ø¯ÛŒÙ…ÛŒâ€ŒØªØ±
                  </div>
                </div>
                <h4 style="margin-top:16px;color:#667eea">Ù†ØµØ¨ Ú©Ø§Ù†Ú©ØªÙˆØ±:</h4>
                <div style="background:#e8f4f8;padding:12px;border-radius:8px;margin:8px 0">
                  <strong>Ù…Ø±Ø§Ø­Ù„:</strong><br>
                  Û±. ØªØ§Ø± Ø±Ø§ Ûµ Ø³Ø§Ù†ØªÛŒâ€ŒÙ…ØªØ± Ø®Ø§Ø±Ø¬ Ú©Ù†ÛŒØ¯<br>
                  Û². Ø¨Ø§ÙØ± Ø±Ø§ Ø¨Ø±Ø¯Ø§Ø´ØªÛŒØ¯ (Û² Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±)<br>
                  Û³. ØªØ§Ø± Ø±Ø§ Ø¯Ø±ÙˆÙ† Ferrule ÙÛŒØª Ú©Ù†ÛŒØ¯<br>
                  Û´. Ferrule Ø±Ø§ Ù¾Ø§Ù„ÛŒØ´ Ú©Ù†ÛŒØ¯<br>
                  Ûµ. Ø¯Ø± Ø¯Ø³ØªÚ¯Ø§Ù‡ ØªØ³Øª Ú©Ù†ÛŒØ¯ (IL < Û°Ù«Û² dB)
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-2-4',
            title: "Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ Ùˆ Ø­Ù„â€ŒØ¢Ù†Ù‡Ø§",
            description: "Ø´Ù†Ø§Ø®Øª Ùˆ Ø±ÙØ¹ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…ØªØ¯Ø§ÙˆÙ„ Ø¯Ø± ÙÛŒÙ„Ø¯",
            duration: "18 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ù…Ø´Ú©Ù„Ø§Øª Ùˆ Ø±Ø§Ù‡â€ŒØ­Ù„â€ŒÙ‡Ø§:</h4>
                <div style="background:#ffebee;padding:12px;border-radius:8px;margin:8px 0;border-right:4px solid #e74c3c">
                  <div style="font-weight:700;color:#c62828">âŒ Ù…Ø´Ú©Ù„: Ø¹Ø¯Ù… Ù…Ø·Ø§Ø¨Ù‚Øª Ù‡Ø³ØªÙ‡â€ŒÙ‡Ø§</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    <strong>Ø¹Ù„Ø§Ù…Øª:</strong> Ø¶Ø§ÛŒØ¹Ø§Øª > Û± dB<br>
                    <strong>Ø¯Ù„ÛŒÙ„:</strong> ØªØ§Ø± Single Mode + Multi Mode<br>
                    <strong>Ø±Ø§Ù‡â€ŒØ­Ù„:</strong> âœ“ Ø§Ø² Ø¯Ùˆ Ù†ÙˆØ¹ ÛŒÚ©Ø³Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯
                  </div>
                </div>
                <div style="background:#ffebee;padding:12px;border-radius:8px;margin:8px 0;border-right:4px solid #e74c3c">
                  <div style="font-weight:700;color:#c62828">âŒ Ù…Ø´Ú©Ù„: Ù†Ù‚Ø·Ù‡ ÙÛŒÙˆÚ˜Ù† ØªÛŒØ±Ù‡</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    <strong>Ø¹Ù„Ø§Ù…Øª:</strong> Ù†Ù‚Ø·Ù‡ Ø³ÛŒØ§Ù‡ Ø¯Ø± Ù…ÛŒØ§Ù†ÛŒ<br>
                    <strong>Ø¯Ù„ÛŒÙ„:</strong> Ø¹Ø¯Ù… Ù¾Ø§Ú©ÛŒâ€ŒØ²Ø¯Ú¯ÛŒ ÛŒØ§ Ø¢Ù„ÙˆØ¯Ú¯ÛŒ<br>
                    <strong>Ø±Ø§Ù‡â€ŒØ­Ù„:</strong> âœ“ ØªØ§Ø± Ø±Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØµØ§Ù Ú©Ù†ÛŒØ¯ Ùˆ Ù¾Ø§Ú© Ú©Ù†ÛŒØ¯
                  </div>
                </div>
                <div style="background:#ffebee;padding:12px;border-radius:8px;margin:8px 0;border-right:4px solid #e74c3c">
                  <div style="font-weight:700;color:#c62828">âŒ Ù…Ø´Ú©Ù„: Ø­Ø¨Ø§Ø¨ Ø¯Ø± Ù…ÙØµÙ„</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    <strong>Ø¹Ù„Ø§Ù…Øª:</strong> Ø­Ø¨Ø§Ø¨ÛŒ Ø¯Ø± Ù†Ù‚Ø·Ù‡ ÙÛŒÙˆÚ˜Ù†<br>
                    <strong>Ø¯Ù„ÛŒÙ„:</strong> Ø±Ø·ÙˆØ¨Øª ÛŒØ§ ØªØ§Ø± Ù†Ø§Ù¾Ø§Ú©<br>
                    <strong>Ø±Ø§Ù‡â€ŒØ­Ù„:</strong> âœ“ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯ + Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø¨Ø§Ø¯Ú©Ù†
                  </div>
                </div>
                <div style="background:#ffebee;padding:12px;border-radius:8px;margin:8px 0;border-right:4px solid #e74c3c">
                  <div style="font-weight:700;color:#c62828">âŒ Ù…Ø´Ú©Ù„: ØªØ§Ø± Ù…ÛŒâ€ŒØ´Ú©Ù†Ø¯</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    <strong>Ø¹Ù„Ø§Ù…Øª:</strong> ØªØ§Ø± Ø¯Ø± Ø¯ÙˆØ±Ø§Ù† Ø§Ù†Ø­Ù†Ø§ Ø´Ú©Ø³ØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯<br>
                    <strong>Ø¯Ù„ÛŒÙ„:</strong> Ø§Ù†Ø­Ù†Ø§ÛŒ ØªÙ†Ø¯ (< Û²Û° Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±)<br>
                    <strong>Ø±Ø§Ù‡â€ŒØ­Ù„:</strong> âœ“ Ø´Ø¹Ø§Ø¹ Ø§Ù†Ø­Ù†Ø§ Ø¨ÛŒØ´ØªØ± (Û³Û°-ÛµÛ° Ù…ÛŒÙ„ÛŒâ€ŒÙ…ØªØ±)
                  </div>
                </div>
              </div>
            `,
            images: []
          }
        ]
      },
      {
        id: 3,
        title: "Ø³Ø·Ø­ 3 â€” Ù¾ÛŒØ´Ø±ÙØªÙ‡",
        subtitle: "ØªØ³Øª Ùˆ Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ",
        target: "Ø¨Ø±Ø§ÛŒ Ù…ØªØ®ØµØµâ€ŒÙ‡Ø§",
        icon: "ğŸ”¬",
        chapters: [
          {
            id: 'ch-3-1',
            title: "Ø¢Ù…ÙˆØ²Ø´ ØªÙØµÛŒÙ„ÛŒ OTDR",
            description: "Ú©Ø§Ø± Ø¨Ø§ Ø¯Ø³ØªÚ¯Ø§Ù‡ OTDR Ùˆ ØªØ­Ù„ÛŒÙ„ Ù†ØªØ§ÛŒØ¬",
            duration: "30 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">OTDR Ú†ÛŒØ³ØªØŸ</h4>
                <p style="font-size:13px;color:#666">
                  Optical Time-Domain Reflectometer - Ø¯Ø³ØªÚ¯Ø§Ù‡ÛŒ Ú©Ù‡ Ù†ÙˆØ± Ù‚ÙˆÛŒ Ø¯Ø± ØªØ§Ø± ÙØ±Ø³ØªØ§Ø¯Ù‡ Ùˆ Ø¨Ø§Ø²Ú¯Ø´Øª Ø±Ø§ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯
                </p>
                <h4 style="margin-top:16px;color:#667eea">Ù…Ø±Ø§Ø­Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û±. ØªÙ†Ø¸ÛŒÙ… Ù¾Ø§ÛŒÙ‡â€ŒØ§ÛŒ</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ù†ÙˆØ¹ ØªØ§Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ (SM/MM)<br>
                    â€¢ Ø·ÙˆÙ„ Ù…ÙˆØ¬ Ø±Ø§ Ø³Øª Ú©Ù†ÛŒØ¯ (1310/1550 nm)<br>
                    â€¢ Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯<br>
                    â€¢ ÙØ§ØµÙ„Ù‡ ØªÙ‚Ø±ÛŒØ¨ÛŒ Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û². Run/Single ØªØ³Øª</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø¯Ú©Ù…Ù‡ "START" Ø±Ø§ ÙØ´Ø§Ø± Ø¯Ù‡ÛŒØ¯<br>
                    â€¢ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ (Û²Û°-Û¶Û° Ø«Ø§Ù†ÛŒÙ‡)<br>
                    â€¢ Ù†ØªØ§ÛŒØ¬ Ø®ÙˆØ¯Ú©Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û³. ØªØ­Ù„ÛŒÙ„ Ù†Ù…ÙˆØ¯Ø§Ø±</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ù…Ø­ÙˆØ± X: ÙØ§ØµÙ„Ù‡ (Ú©ÛŒÙ„ÙˆÙ…ØªØ±)<br>
                    â€¢ Ù…Ø­ÙˆØ± Y: Ù‚Ø¯Ø±Øª Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ (dB)<br>
                    â€¢ Ø´ÛŒØ¨: ØªØ¶Ø¹ÛŒÙ (Attenuation)<br>
                    â€¢ Ù‚Ù„Ù‡â€ŒÙ‡Ø§ÛŒ ØªÙ†Ø¯: Ù…ÙØµÙ„â€ŒÙ‡Ø§ ÛŒØ§ Ø®Ø±Ø§Ø¨ÛŒâ€ŒÙ‡Ø§
                  </div>
                </div>
                <div style="background:#e8f4f8;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #2d9cdb">
                  <strong>ğŸ’¡ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯:</strong><br>
                  âœ“ Single Mode 1310 nm: 0.35 dB/km<br>
                  âœ“ Single Mode 1550 nm: 0.20 dB/km<br>
                  âœ“ Multi Mode 850 nm: 2.5 dB/km
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-3-2',
            title: "ØªØ­Ù„ÛŒÙ„ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ OTDR",
            description: "Ø¯Ø±Ú© Ùˆ ØªÙØ³ÛŒØ± Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù ØªØ³Øª",
            duration: "25 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ù†ÙˆØ§Ø¹ Ù†Ù…ÙˆØ¯Ø§Ø±Ù‡Ø§:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:14px">âœ… Ù†Ù…ÙˆØ¯Ø§Ø± Ø³Ø§Ù„Ù…</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø®Ø· ØªÙ‚Ø±ÛŒØ¨Ø§Ù‹ ØµØ§Ù Ùˆ Ú©Ø§Ù‡Ø´ÛŒ<br>
                    â€¢ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±Ø§Øª Ø´Ø¯ÛŒØ¯<br>
                    â€¢ Ø¯Ø± Ø§Ù†ØªÙ‡Ø§: Ù‚Ø·Ø¹ Ù†Ø¸ÛŒÙ<br>
                    â€¢ Ù…Ø¹Ù†ÛŒ: Ø®Ø· Ø¨Ø¯ÙˆÙ† Ù…Ø´Ú©Ù„
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:740;color:#764ba2;font-size:14px">âš ï¸ Ù†Ù…ÙˆØ¯Ø§Ø± Ø¨Ø§ Ù…ÙØµÙ„</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ù‚Ù„Ù‡â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ¯Ø§ - reflection peak<br>
                    â€¢ Ù…ÛŒØ²Ø§Ù† Ù‚Ù„Ù‡: Ø¨Ø²Ø±Ú¯ÛŒ Ø­Ø¯ÙˆØ¯ loss<br>
                    â€¢ ÙØ§ØµÙ„Ù‡ Ù‚Ù„Ù‡: Ø¬Ø§ÛŒ Ù…ÙØµÙ„<br>
                    â€¢ Ù…Ø¹Ù†ÛŒ: Ù…ÙØµÙ„ ÙÛŒÙˆÚ˜ ÛŒØ§ Ú©Ø§Ù†Ú©ØªÙˆØ±
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:14px">âŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ú¯Ø³Ø³ØªÙ‡</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø®Ø· Ù†Ø§Ú¯Ù‡Ø§Ù† Ù…ØªÙˆÙ‚Ù<br>
                    â€¢ Ø¨Ø¯ÙˆÙ† reflection<br>
                    â€¢ Ù…Ø¹Ù†ÛŒ: <strong>Ø®Ø· Ù‚Ø·Ø¹ Ø´Ø¯Ù‡</strong>
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2;font-size:14px">ğŸ“‰ Ù†Ù…ÙˆØ¯Ø§Ø± Ø±Ø·ÙˆØ¨Øªâ€ŒØ¯Ø§Ø±</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø´ÛŒØ¨ ØªÙ†Ø¯ØªØ± Ø§Ø² Ù…Ø¹Ù…ÙˆÙ„<br>
                    â€¢ loss Ø¨ÛŒØ´â€ŒØªØ±<br>
                    â€¢ Ù…Ø¹Ù†ÛŒ: ØªØ§Ø± Ø®ÛŒØ³ Ø´Ø¯Ù‡ ÛŒØ§ Ú©Ø«ÛŒÙ
                  </div>
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-3-3',
            title: "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Power Meter",
            description: "Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù¾Ø§ÙˆØ±Ù…ØªØ± Ùˆ Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ Ø¯Ù‚ÛŒÙ‚",
            duration: "20 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Power Meter Ú†Ù‡ Ù…ÛŒâ€ŒØ³Ù†Ø¬Ø¯ØŸ</h4>
                <p style="font-size:13px;color:#666">
                  Ø³Ù†Ø¬Ø´ Ù…Ø³ØªÙ‚ÛŒÙ… Ù‚Ø¯Ø±Øª Ù†ÙˆØ±ÛŒ Ø¯Ø± Ù¾Ø§ÛŒØ§Ù† ØªØ§Ø± (dBm ÛŒØ§ mW)
                </p>
                <h4 style="margin-top:16px;color:#667eea">Ù…Ø¹Ø§Ø¯Ù„Ø§Øª Ú©Ù„ÛŒØ¯ÛŒ:</h4>
                <div style="background:#e8f4f8;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-size:13px;color:#2d9cdb;font-weight:700">Loss = Power Out - Power In (dB)</div>
                  <div style="font-size:12px;color:#666;margin-top:8px">Ù…Ø«Ø§Ù„: 5 dBm - 0 dBm = 5 dB loss</div>
                </div>
                <h4 style="margin-top:16px;color:#667eea">Ù…Ø±Ø§Ø­Ù„ ØªØ³Øª:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û±. Ú©Ø§Ù„ÛŒØ¨Ø±Ø§Ø³ÛŒÙˆÙ†</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ Ø§ØªØµØ§Ù„ Laser <br>
                    âœ“ Ø²Ø§ÙˆÛŒÙ‡ 1310 nm<br>
                    âœ“ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡: 0 dBm<br>
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">Û². Ø§Ù†Ø¯Ø§Ø²Ù‡â€ŒÚ¯ÛŒØ±ÛŒ</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    âœ“ Ú©Ø§Ù†Ú©ØªÙˆØ± Ø±Ø§ ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯<br>
                    âœ“ Ø®Ø±ÙˆØ¬ÛŒ ØªØ§Ø± Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯<br>
                    âœ“ Ù…Ù‚Ø¯Ø§Ø± Ù†Ù‡Ø§ÛŒÛŒ Ø±Ø§ Ø®ÙˆØ§Ù†ÛŒØ¯
                  </div>
                </div>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #ffc107">
                  <strong>Ù…Ø¹Ø§ÛŒØ¨ Ù‚Ø§Ø¨Ù„â€ŒÙ‚Ø¨ÙˆÙ„:</strong><br>
                  âœ“ Single Mode: < -20 dBm<br>
                  âœ“ Multi Mode: < -15 dBm
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-3-4',
            title: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ FTTH Ùˆ IEC",
            description: "Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ Ø¨ÛŒÙ†â€ŒØ§Ù„Ù…Ù„Ù„ÛŒ FTTH Ùˆ Ø±Ø¹Ø§ÛŒØª Ø¢Ù†Ù‡Ø§",
            duration: "28 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯Ù‡Ø§ÛŒ ISO Ùˆ IEC:</h4>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“‹ IEC 61315 - FTTH</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ø´Ø¨Ú©Ù‡ FTTH<br>
                    â€¢ Ø­Ø¯Ø§Ù‚Ù„ bandwidth: 100 Mbps<br>
                    â€¢ ÙØ§ØµÙ„Ù‡: ØªØ§ 20 Ú©ÛŒÙ„ÙˆÙ…ØªØ±
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“‹ IEC 61069 - Fiber Cable</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Ù…Ø´Ø®ØµØ§Øª Ú©Ø§Ø¨Ù„<br>
                    â€¢ Ø´Ø±Ø§ÛŒØ· Ù…Ø­ÛŒØ·ÛŒ<br>
                    â€¢ Ø­Ø¯Ø§Ù‚Ù„ insertion loss: 0.3 dB/km
                  </div>
                </div>
                <div style="background:#f8f9fb;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#764ba2">ğŸ“‹ ITU-T G.652</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    â€¢ Single Mode Fiber<br>
                    â€¢ Ø´Ø±Ø§ÛŒØ· Ø§Ø³ØªÙØ§Ø¯Ù‡ ØªØ§ 1625 nm<br>
                    â€¢ Ú©Ø´Ø´ Ù…Ø­Ø¯ÙˆØ¯: 150 kN
                  </div>
                </div>
                <div style="background:#e8f4f8;padding:12px;border-radius:8px;margin-top:16px;border-left:4px solid #2d9cdb">
                  <strong>Ù…Ø¹Ø§ÛŒØ± ØªØ³Øª Ù†Ù‡Ø§ÛŒÛŒ:</strong><br>
                  âœ“ Insertion Loss: < 0.1 dB<br>
                  âœ“ Return Loss: > 50 dB<br>
                  âœ“ OTDR: Ø®Ø· Ø³Ø§Ù„Ù…<br>
                  âœ“ Power: > -20 dBm
                </div>
              </div>
            `,
            images: []
          },
          {
            id: 'ch-3-5',
            title: "Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ ØªØ®ØµØµÛŒ Ùˆ Ø§ØµÙ„Ø§Ø­",
            description: "Ø±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø±Ø§ÛŒ ØªØ´Ø®ÛŒØµ Ùˆ Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª",
            duration: "35 Ø¯Ù‚ÛŒÙ‚Ù‡",
            content: `
              <div style="line-height:1.8;color:#333">
                <h4 style="margin-top:12px;color:#667eea">Ø¬Ø±ÛŒØ§Ù† Ø¹ÛŒØ¨â€ŒÛŒØ§Ø¨ÛŒ:</h4>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb;font-size:14px">Ú¯Ø§Ù… Û±: ØªØ³Øª Ø§ÙˆÙ„ÛŒÙ‡</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    Û±Û±. Power Meter Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø³Ø±ÛŒØ¹<br>
                    Û±Û². OTDR Ø¨Ø±Ø§ÛŒ ØªØ³Øª Ø¬Ø²Ø¦ÛŒ
                  </div>
                </div>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb;font-size:14px">Ú¯Ø§Ù… Û²: ØªØ´Ø®ÛŒØµ Ù…Ø´Ú©Ù„</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    Û²Û±. Ø¢ÛŒØ§ OTDR signal Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ØŸ â†’ Yes = Ù†Ù‚Øµ Ù…Ø­Ù„ÛŒ<br>
                    Û²Û². Ø¢ÛŒØ§ Power ØºÛŒØ±Ù…Ø¹Ù…ÙˆÙ„ Ø§Ø³ØªØŸ â†’ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÙØµÙ„â€ŒÙ‡Ø§<br>
                    Û²Û³. Ø¶Ø§ÛŒØ¹Ø§Øª Ø¨ÛŒØ´ Ø§Ø² Ù…Ø¹Ù…ÙˆÙ„ØŸ â†’ Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒÙ…Ø§ÛŒØ´
                  </div>
                </div>
                <div style="background:#f0f7ff;padding:12px;border-radius:8px;margin:8px 0">
                  <div style="font-weight:700;color:#2d9cdb;font-size:14px">Ú¯Ø§Ù… Û³: ØªØµØ­ÛŒØ­</div>
                  <div style="font-size:13px;color:#666;margin-top:4px">
                    Û³Û±. ØªØ¹ÙˆÛŒØ¶ Ú©Ø§Ù†Ú©ØªÙˆØ±<br>
                    Û³Û². ÙÛŒÙˆÚ˜ Ø¯ÙˆØ¨Ø§Ø±Ù‡<br>
                    Û³Û³. ØªØºÛŒÛŒØ± Ù…Ø³ÛŒØ± ÛŒØ§ Ú©Ø§Ø¨Ù„<br>
                    Û³Û´. ØªØ³Øª Ù…Ø¬Ø¯Ø¯
                  </div>
                </div>
                <h4 style="margin-top:16px;color:#667eea">Ø§Ø³ØªØ±Ø§ØªÚ˜ÛŒâ€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´Ø±ÙØªÙ‡:</h4>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin:8px 0;border-left:4px solid #ffc107">
                  <strong>ğŸ” Bidirectional Testing:</strong><br>
                  OTDR Ø±Ø§ Ø§Ø² Ù‡Ø± Ø¯Ùˆ Ø§Ù†ØªÙ‡Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯ ØªØ§ Ù†Ù‚Ø·Ù‡ Ø¯Ù‚ÛŒÙ‚ Ø®Ø±Ø§Ø¨ÛŒ Ø±Ø§ Ù¾ÛŒØ¯Ø§ Ú©Ù†ÛŒØ¯.
                </div>
                <div style="background:#fff3cd;padding:12px;border-radius:8px;margin:8px 0;border-left:4px solid #ffc107">
                  <strong>ğŸ“Š Splice Loss Analysis:</strong><br>
                  Ù…Ù‚Ø§ÛŒØ³Ù‡ Ø¶Ø§ÛŒØ¹Ø§Øª Ù‡Ø± Ù…ÙØµÙ„ - Ø§Ú¯Ø± ÛŒÚ©ÛŒ > 0.3 dBØŒ Ù†ÛŒØ§Ø²Ù…Ù†Ø¯ ØªØ¹ÙˆÛŒØ¶ Ø§Ø³Øª.
                </div>
              </div>
            `,
            images: []
          }
        ]
      }
    ]
  };

  // Load training unlock status from localStorage
  function loadTrainingUnlocks() {
    try {
      return JSON.parse(localStorage.getItem('fibotic_training_unlocks_v3') || '{}');
    } catch (e) {
      return {};
    }
  }

  // Save training unlock status
  function saveTrainingUnlocks(unlocks) {
    try {
      localStorage.setItem('fibotic_training_unlocks_v3', JSON.stringify(unlocks));
    } catch (e) {
      console.error('saveTrainingUnlocks error', e);
    }
  }

  // Check if user can access training
  function canAccessTraining() {
    const role = localStorage.getItem('fibotic_role') || '';
    if (role === 'admin') return true;
    
    const unlocks = loadTrainingUnlocks();
    const logged = localStorage.getItem('fibotic_logged_in') || '';
    return unlocks[logged] === true;
  }

  // Load chapter images from localStorage
  function getChapterImages(chapterId) {
    try {
      const stored = localStorage.getItem(`fibotic_chapter_images_${chapterId}`) || '[]';
      return JSON.parse(stored);
    } catch (e) {
      return [];
    }
  }

  // Save chapter images to localStorage
  function saveChapterImages(chapterId, images) {
    try {
      localStorage.setItem(`fibotic_chapter_images_${chapterId}`, JSON.stringify(images));
    } catch (e) {
      console.error('saveChapterImages error', e);
    }
  }

  // Render all training levels with professional UI
  function renderTrainingLevels() {
  try {
    const container = document.getElementById('trainingLevels');
    const adminSection = document.getElementById('trainingAdminSection');
    const role = localStorage.getItem('fibotic_role') || '';
    
    if (!container) return;

    if (adminSection) {
      adminSection.style.display = (role === 'admin') ? 'block' : 'none';
    }

    const unlocks = loadTrainingUnlocks();
    const logged = localStorage.getItem('fibotic_logged_in') || '';
    const canAccess = role === 'admin' || unlocks[logged];

    container.innerHTML = '';

    if (!canAccess) {
      container.innerHTML = `
        <div class="content-card" style="text-align:center;padding:24px">
          <div style="font-size:48px;margin-bottom:12px">ğŸ”</div>
          <h3 style="margin:0 0 12px 0;color:#e74c3c">Ø¯Ø³ØªØ±Ø³ÛŒ Ù…Ø­Ø¯ÙˆØ¯</h3>
          <p style="color:#666;margin:8px 0">Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø§ÛŒØ¯ ØªÙˆØ³Ø· Ù…Ø¯ÛŒØ± ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø´ÙˆÛŒØ¯.</p>
          <p class="muted" style="margin:12px 0">Ù„Ø·ÙØ§Ù‹ Ø¨Ø§ Ù…Ø¯ÛŒØ± ØªÙ…Ø§Ø³ Ø¨Ú¯ÛŒØ±ÛŒØ¯.</p>
        </div>
      `;
      return;
    }

    // Render each training level
    trainingContent.levels.forEach(level => {
      const levelCard = document.createElement('div');
      levelCard.className = 'content-card';
      levelCard.style.marginBottom = '16px';
      levelCard.style.borderLeft = '6px solid var(--accent)';

      const headerHtml = `
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px">
          <div style="flex:1">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
              <span style="font-size:24px">${level.icon}</span>
              <div>
                <h3 style="margin:0;color:#764ba2">${escapeHtml(level.title)}</h3>
                <div style="font-size:13px;color:#666">${escapeHtml(level.subtitle)}</div>
              </div>
            </div>
            <div class="muted" style="font-size:12px">${escapeHtml(level.target)}</div>
          </div>
          <button class="btn-primary" id="toggle-level-${level.id}" onclick="toggleTrainingLevel(${level.id})" style="white-space:nowrap">Ø¹Ø±Ø¶ ÙØµÙ„â€ŒÙ‡Ø§ â¬‡ï¸</button>
        </div>
      `;

      let chaptersHtml = `<div id="chapters-${level.id}" style="display:none;margin-top:12px;border-top:1px solid #eee;padding-top:12px">`;

      level.chapters.forEach((ch, idx) => {
        const images = getChapterImages(ch.id);
        
        chaptersHtml += `
          <div class="content-card" style="margin-bottom:12px;background:#f8f9fb">
            <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:8px;margin-bottom:8px">
              <div style="flex:1">
                <div style="font-weight:700;color:#2c3e50;font-size:14px">${idx + 1}. ${escapeHtml(ch.title)}</div>
                <div style="font-size:12px;color:#999;margin-top:2px">â±ï¸ ${escapeHtml(ch.duration)}</div>
              </div>
              <button class="smallBtn" onclick="toggleChapterContent('${ch.id}')" style="white-space:nowrap">Ù…Ø·Ø§Ù„Ø¨ ğŸ‘‡</button>
            </div>
            
            <div id="content-${ch.id}" style="display:none;margin-top:12px;padding:12px;background:#fff;border-radius:6px">
              ${ch.content}
            </div>
        `;

        // Images section - ALWAYS shown (for both admin and users)
        if (images && images.length > 0) {
          chaptersHtml += `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #ddd;background:#f0f7ff;padding:12px;border-radius:6px">
              <div style="font-weight:700;color:#2d9cdb;margin-bottom:8px">ğŸ“¸ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ (${images.length})</div>
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:8px">
          `;
          
          images.forEach((img, imgIdx) => {
            chaptersHtml += `
              <div style="position:relative;cursor:pointer;border-radius:6px;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,0.1);border:2px solid #ddd">
                <img src="${img}" 
                     style="width:100%;height:100px;object-fit:cover;cursor:pointer" 
                     onclick="viewImageFullScreen('${img}', '${escapeHtml(ch.title)}')"
                     alt="Ø¹Ú©Ø³ ${imgIdx + 1}"
                     title="Ú©Ù„ÛŒÚ© Ø¨Ø±Ø§ÛŒ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¨Ø²Ø±Ú¯â€ŒØªØ±">
              </div>
            `;
          });

          chaptersHtml += `
              </div>
            `;

          if (role === 'admin') {
            chaptersHtml += `
              <div style="display:flex;gap:8px;margin-top:8px">
                <button class="smallBtn" onclick="openImageUploadModal('${ch.id}', '${escapeHtml(ch.title)}')">â• Ø¹Ú©Ø³ Ø¨ÛŒØ´ØªØ±</button>
                <button class="smallBtn" style="background:#e74c3c;color:#fff" onclick="clearChapterImages('${ch.id}')">ğŸ—‘ï¸ Ø­Ø°Ù Ù‡Ù…Ù‡</button>
              </div>
            `;
          }

          chaptersHtml += `</div>`;
        } else if (role === 'admin') {
          // Only admin sees this when no images
          chaptersHtml += `
            <div style="margin-top:12px;padding-top:12px;border-top:1px solid #ddd">
              <button class="smallBtn" onclick="openImageUploadModal('${ch.id}', '${escapeHtml(ch.title)}')">ğŸ“¸ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³</button>
            </div>
          `;
        }

        chaptersHtml += `</div>`;
      });

      chaptersHtml += `
        <div style="background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;padding:12px;border-radius:8px;text-align:center;margin-top:12px;font-weight:700">
          Ù…Ø¬Ù…ÙˆØ¹ Ù…Ø¯Øª Ø§ÛŒÙ† Ø³Ø·Ø­: ${level.chapters.reduce((s, ch) => {
            const mins = parseInt(ch.duration);
            return s + (isNaN(mins) ? 0 : mins);
          }, 0)} Ø¯Ù‚ÛŒÙ‚Ù‡
        </div>
      </div>`;

      levelCard.innerHTML = headerHtml + chaptersHtml;
      container.appendChild(levelCard);
    });

    // Show completion status
    if (role !== 'admin') {
      const statusCard = document.createElement('div');
      statusCard.className = 'content-card';
      statusCard.style.background = '#f0f7ff';
      statusCard.style.borderLeft = '6px solid #27ae60';
      statusCard.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px">
          <span style="font-size:24px">âœ…</span>
          <div>
            <strong>Ø´Ù…Ø§ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø±ÛŒØ¯!</strong>
            <div class="muted" style="font-size:13px;margin-top:4px">Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ ØªÙ…Ø§Ù… Ù…Ø­ØªÙˆØ§ÛŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø±Ø§ Ù…Ø·Ø§Ù„Ø¹Ù‡ Ú©Ù†ÛŒØ¯.</div>
          </div>
        </div>
      `;
      container.appendChild(statusCard);
    }

  } catch (e) {
    console.error('renderTrainingLevels error', e);
    showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø³â€ŒÙ‡Ø§', '#e74c3c');
  }
}

// View image in full screen
function viewImageFullScreen(imageSrc, chapterTitle) {
  try {
    const modal = document.createElement('div');
    modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:15000;cursor:pointer;flex-direction:column;padding:20px';
    
    const imgEl = document.createElement('img');
    imgEl.src = imageSrc;
    imgEl.style.maxWidth = '90%';
    imgEl.style.maxHeight = '85%';
    imgEl.style.borderRadius = '8px';
    imgEl.style.boxShadow = '0 10px 40px rgba(0,0,0,0.5)';
    
    const titleEl = document.createElement('div');
    titleEl.style.cssText = 'color:#fff;margin-top:12px;font-weight:700;text-align:center;font-size:14px';
    titleEl.textContent = `ğŸ“¸ ${escapeHtml(chapterTitle)}`;
    
    modal.appendChild(imgEl);
    modal.appendChild(titleEl);
    
    modal.onclick = (e) => {
      if (e.target === modal) modal.remove();
    };
    
    // Press ESC to close
    const closeOnEsc = (e) => {
      if (e.key === 'Escape') {
        modal.remove();
        document.removeEventListener('keydown', closeOnEsc);
      }
    };
    document.addEventListener('keydown', closeOnEsc);
    
    document.body.appendChild(modal);
  } catch (e) {
    console.error('viewImageFullScreen error', e);
  }
}

  // Toggle chapter content visibility
  function toggleChapterContent(chapterId) {
    const contentDiv = document.getElementById(`content-${chapterId}`);
    if (!contentDiv) return;
    
    const isVisible = contentDiv.style.display !== 'none';
    contentDiv.style.display = isVisible ? 'none' : 'block';
    
    if (!isVisible) {
      contentDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

    // Toggle visibility of chapters
  function toggleTrainingLevel(levelId) {
    const chaptersDiv = document.getElementById(`chapters-${levelId}`);
    const btn = document.getElementById(`toggle-level-${levelId}`);
    
    if (!chaptersDiv) return;

    const isVisible = chaptersDiv.style.display !== 'none';
    
    if (isVisible) {
      chaptersDiv.style.display = 'none';
      if (btn) btn.textContent = 'Ø¹Ø±Ø¶ ÙØµÙ„â€ŒÙ‡Ø§ â¬‡ï¸';
    } else {
      chaptersDiv.style.display = 'block';
      if (btn) btn.textContent = 'Ù¾Ù†Ù‡Ø§Ù† Ú©Ø±Ø¯Ù† â¬†ï¸';
      chaptersDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  // Activate training for a user (admin only)
  function activateTraining() {
    try {
      const role = localStorage.getItem('fibotic_role') || '';
      if (role !== 'admin') {
        showMessage('âš ï¸ ÙÙ‚Ø· Ù…Ø¯ÛŒØ± Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ø¯ ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡Ø¯', '#e74c3c');
        return;
      }

      const code = (document.getElementById('activationCode')?.value || '').trim();
      const status = document.getElementById('activationStatus');
      
      if (!code) {
        status.innerHTML = '<span style="color:#e74c3c">âš ï¸ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</span>';
        return;
      }

      const validCode = 'FIBER2025';
      
      if (code === validCode) {
        showActivationUserModal();
      } else {
        status.innerHTML = '<span style="color:#e74c3c">âŒ Ú©Ø¯ Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª</span>';
      }
    } catch (e) {
      console.error('activateTraining error', e);
    }
  }

  // Show modal to select user for training activation
  function showActivationUserModal() {
    try {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:480px;width:92%';

      const users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
      const userList = Object.keys(users);

      let userOptions = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± --</option>';
      userList.forEach(u => {
        userOptions += `<option value="${escapeHtml(u)}">${escapeHtml(u)}</option>`;
      });

      content.innerHTML = `
        <h3 style="margin:0 0 12px 0">âœ… ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ</h3>
        <p style="font-size:14px;color:#666;margin-bottom:12px">Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Ø¯Ø³ØªØ±Ø³ÛŒ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯:</p>
        <select id="userSelectForTraining" class="input">
          ${userOptions}
        </select>
        <div style="height:12px"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelActivation" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
          <button id="confirmActivation" class="btn-primary">ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø±Ø¨Ø±</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      document.getElementById('cancelActivation').onclick = () => modal.remove();

      document.getElementById('confirmActivation').onclick = () => {
        const selectedUser = (document.getElementById('userSelectForTraining')?.value || '').trim();
        
        if (!selectedUser) {
          showMessage('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', '#e74c3c');
          return;
        }

        const unlocks = loadTrainingUnlocks();
        unlocks[selectedUser] = true;
        saveTrainingUnlocks(unlocks);

        modal.remove();
        showMessage(`âœ… Ù¾Ú©ÛŒØ¬ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¨Ø±Ø§ÛŒ "${selectedUser}" ÙØ¹Ø§Ù„ Ø´Ø¯`, '#27ae60');
        
        document.getElementById('activationCode').value = '';
        document.getElementById('activationStatus').innerHTML = '';
        renderTrainingLevels();
      };

    } catch (e) {
      console.error('showActivationUserModal error', e);
    }
  }

  // Initialize training system
  function initTrainingSystem() {
    try {
      const activateBtn = document.getElementById('btn-activate-training');
      if (activateBtn) {
        activateBtn.removeEventListener('click', activateTraining);
        activateBtn.addEventListener('click', activateTraining);
      }

      renderTrainingLevels();
    } catch (e) {
      console.error('initTrainingSystem error', e);
    }
  }

  // Open image upload modal for a chapter
  function openImageUploadModal(chapterId, chapterTitle) {
    try {
      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;z-index:10000';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:480px;width:92%';
      
      content.innerHTML = `
        <h3 style="margin:0 0 12px 0">ğŸ“¸ Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³ Ø¨Ø±Ø§ÛŒ "${escapeHtml(chapterTitle)}"</h3>
        <input id="chapterImageInput" type="file" accept="image/*" multiple class="input" style="padding:8px">
        <div style="height:12px"></div>
        <div style="display:flex;justify-content:flex-end;gap:8px">
          <button id="cancelImageUpload" class="modal-cancel">Ø§Ù†ØµØ±Ø§Ù</button>
          <button id="confirmImageUpload" class="btn-primary">Ø§ÙØ²ÙˆØ¯Ù† Ø¹Ú©Ø³â€ŒÙ‡Ø§</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      document.getElementById('cancelImageUpload').onclick = () => modal.remove();

      document.getElementById('confirmImageUpload').onclick = async () => {
        const files = document.getElementById('chapterImageInput').files;
        if (files.length === 0) {
          showMessage('âš ï¸ Ù„Ø·ÙØ§Ù‹ Ø¹Ú©Ø³ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯', '#e74c3c');
          return;
        }

        try {
          const images = await readFilesAsDataURLs(files);
          const existingImages = getChapterImages(chapterId);
          const allImages = [...existingImages, ...images];
          saveChapterImages(chapterId, allImages);
          
          showMessage(`âœ… ${images.length} Ø¹Ú©Ø³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`, '#27ae60');
          modal.remove();
          
          // Refresh training levels
          renderTrainingLevels();
        } catch (e) {
          console.error('Error uploading images', e);
          showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¹Ú©Ø³â€ŒÙ‡Ø§', '#e74c3c');
        }
      };
    } catch (e) {
      console.error('openImageUploadModal error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø² Ú©Ø±Ø¯Ù† Ù¾Ù†Ø¬Ø±Ù‡', '#e74c3c');
    }
  }

  // View chapter images
  function viewChapterImages(chapterId) {
    try {
      const images = getChapterImages(chapterId);
      if (!images || images.length === 0) {
        showMessage('âš ï¸ Ø§ÛŒÙ† ÙØµÙ„ Ø¹Ú©Ø³ÛŒ Ù†Ø¯Ø§Ø±Ø¯', '#e74c3c');
        return;
      }

      const modal = document.createElement('div');
      modal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);display:flex;align-items:center;justify-content:center;z-index:10000;overflow:auto;padding:20px';
      
      const content = document.createElement('div');
      content.style.cssText = 'background:#fff;padding:16px;border-radius:12px;max-width:800px;width:96%;max-height:90vh;overflow:auto';
      
      let imagesHtml = '<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:12px 0">';
      images.forEach((img, idx) => {
        imagesHtml += `
          <div style="position:relative;cursor:pointer;border-radius:8px;overflow:hidden;box-shadow:0 4px 8px rgba(0,0,0,0.2)">
            <img src="${img}" style="width:100%;height:150px;object-fit:cover" onclick="event.stopPropagation(); viewFullImage('${idx}')" alt="Ø¹Ú©Ø³ ${idx + 1}">
            <button onclick="deleteChapterImage('${chapterId}', ${idx})" style="position:absolute;top:4px;right:4px;background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:4px 8px;cursor:pointer;font-weight:700">Ø­Ø°Ù</button>
          </div>
        `;
      });
      imagesHtml += '</div>';

      content.innerHTML = `
        <h3 style="margin:0 0 12px 0">ğŸ“¸ Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ ÙØµÙ„</h3>
        ${imagesHtml}
        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button id="closeImagesModal" class="btn-primary">Ø¨Ø³ØªÙ†</button>
        </div>
      `;

      modal.appendChild(content);
      document.body.appendChild(modal);

      document.getElementById('closeImagesModal').onclick = () => modal.remove();

      // Store images globally for full view
      window.__currentChapterImages = images;
      window.viewFullImage = function(idx) {
        const fullModal = document.createElement('div');
        fullModal.style.cssText = 'position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);display:flex;align-items:center;justify-content:center;z-index:11000;cursor:pointer';
        
        const imgEl = document.createElement('img');
        imgEl.src = window.__currentChapterImages[idx];
        imgEl.style.maxWidth = '90%';
        imgEl.style.maxHeight = '90%';
        imgEl.style.borderRadius = '8px';
        
        fullModal.appendChild(imgEl);
        fullModal.onclick = () => fullModal.remove();
        document.body.appendChild(fullModal);
      };

    } catch (e) {
      console.error('viewChapterImages error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ù†Ù…Ø§ÛŒØ´ Ø¹Ú©Ø³â€ŒÙ‡Ø§', '#e74c3c');
    }
  }

  // Delete chapter image
  async function deleteChapterImage(chapterId, imageIdx) {
    try {
      const images = getChapterImages(chapterId);
      images.splice(imageIdx, 1);
      saveChapterImages(chapterId, images);
      showMessage('âœ… Ø¹Ú©Ø³ Ø­Ø°Ù Ø´Ø¯', '#27ae60');
      
      // Refresh
      renderTrainingLevels();
    } catch (e) {
      console.error('deleteChapterImage error', e);
      showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¹Ú©Ø³', '#e74c3c');
    }
  }

  // Clear all chapter images
  async function clearChapterImages(chapterId) {
    if (!confirm('Ø¢ÛŒØ§ ØªÙ…Ø§Ù… Ø¹Ú©Ø³â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† ÙØµÙ„ Ø­Ø°Ù Ø´ÙˆØ¯ØŸ')) return;
    
    try {
      saveChapterImages(chapterId, []);
      showMessage('âœ… ØªÙ…Ø§Ù… Ø¹Ú©Ø³â€ŒÙ‡Ø§ Ø­Ø°Ù Ø´Ø¯Ù†Ø¯', '#27ae60');
      renderTrainingLevels();
    } catch (e) {
      console.error('clearChapterImages error', e);
      showMessage('âŒ Ø®Ø·Ø§', '#e74c3c');
    }
  }

  // Expose functions to window
  window.renderTrainingLevels = renderTrainingLevels;
  window.toggleTrainingLevel = toggleTrainingLevel;
  window.toggleChapterContent = toggleChapterContent;
  window.activateTraining = activateTraining;
  window.initTrainingSystem = initTrainingSystem;
  window.loadTrainingUnlocks = loadTrainingUnlocks;
  window.saveTrainingUnlocks = saveTrainingUnlocks;
  window.canAccessTraining = canAccessTraining;
  window.getChapterImages = getChapterImages;
  window.saveChapterImages = saveChapterImages;
  window.openImageUploadModal = openImageUploadModal;
  window.viewChapterImages = viewChapterImages;
  window.deleteChapterImage = deleteChapterImage;
  window.clearChapterImages = clearChapterImages;

  // Auto-initialize when training page is opened
  if (typeof openPage === 'function') {
    const originalOpenPage = window.openPage;
    window.openPage = function(id) {
      originalOpenPage(id);
      if (id === 'training') {
        setTimeout(initTrainingSystem, 100);
      }
    };
  }

  /* ---------- Backup/restore ---------- */
  function backupData() { const blob = new Blob([JSON.stringify(allData || [], null, 2)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `fibotic-backup-${new Date().toISOString().split('T')[0]}.json`; a.click(); URL.revokeObjectURL(url); showMessage('âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù† Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´Ø¯', 'var(--accent)'); }
  function restoreData(e) { const f = e.target.files[0]; if (!f) return; const reader = new FileReader(); reader.onload = async ev => { try { const data = JSON.parse(ev.target.result); for (const item of data) { await safeCreate(item); } showMessage('âœ… Ø¨Ø§Ø²ÛŒØ§Ø¨ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', '#27ae60'); } catch (err) { console.error(err); showMessage('âŒ Ø®Ø·Ø§', '#e74c3c'); } }; reader.readAsText(f); }

  /* ---------- Init and bindings ---------- */
  function wireMenuCards() {
    document.querySelectorAll('.menu-card[data-page]').forEach(mc => {
      mc.addEventListener('click', function () {
        try { const p = mc.dataset.page; if (p) openPage(p); }
        catch (e) { console.error('menu-card click error', e); }
      });
    });
  }

  function initBindings() {
    // header buttons
    document.getElementById('settingsBtn').onclick = () => openPage('settings');
    // tar buttons
    document.getElementById('btn-find-tar12').addEventListener('click', findTar12);
    document.getElementById('btn-find-tar6').addEventListener('click', findTar6);
    // port
    document.getElementById('btn-highlight-port').addEventListener('click', highlightPort);
    // training - initialize training system
    if (typeof initTrainingSystem === 'function') {
      initTrainingSystem();
    }
    // attendance bindings
    // add-person removed â€” attendance uses personSelect populated from admin users
    document.getElementById('saveAttendanceBtn').addEventListener('click', recordAttendance);
    document.getElementById('btn-calc-hours').addEventListener('click', calculateWorkHours);
    // reports
    document.getElementById('btn-open-new-report').addEventListener('click', () => openNewReport());
    // daily log
    document.getElementById('saveTextBtn').addEventListener('click', saveText);
    // checklist
    document.getElementById('addChecklistBtn').addEventListener('click', addChecklistItem);
    // settings
    document.getElementById('btn-price').addEventListener('click', () => requireAdminPassword(showPriceForm));
    document.getElementById('btn-income').addEventListener('click', () => requireAdminPassword(openIncomeModal));
    document.getElementById('btn-backup').addEventListener('click', backupData);

    // Merge-restore: only wire the "open file chooser" here; actual merge handler is attached in merge-restore script
    const btnMerge = document.getElementById('btn-merge-restore');
    const mergeInput = document.getElementById('mergeRestoreFile');
    if (btnMerge && mergeInput) {
      btnMerge.addEventListener('click', () => mergeInput.click());
      // the 'change' handler for mergeRestoreFile will be attached by the merge-restore script (mergeRestoreFromFileEvent)
    }

    // accounting page buttons (admin only)
    const accPrice = document.getElementById('btn-account-price');
    if (accPrice) accPrice.addEventListener('click', showPriceForm);
    const accIncome = document.getElementById('btn-account-income');
    if (accIncome) accIncome.addEventListener('click', openIncomeModal);

    // ADD: salaries (payroll) button binding (admin only)
    const accSalaries = document.getElementById('btn-account-salaries');
    if (accSalaries) accSalaries.addEventListener('click', () => requireAdminPassword(showSalariesModal));

    // admin page create user button
    const adminCreateBtn = document.getElementById('adminCreateUserBtn');
    if (adminCreateBtn) {
      adminCreateBtn.addEventListener('click', () => {
        if (typeof window.adminCreateUser === 'function') window.adminCreateUser();
        else showMessage('âš ï¸ ØªØ§Ø¨Ø¹ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª', '#e74c3c');
      });
    }

    // admin calc hours button (may not exist if page not rendered yet)
    const adminCalcBtn = document.getElementById('btn-admin-calc-hours');
    if (adminCalcBtn) {
      adminCalcBtn.addEventListener('click', calculateWorkHours);
    }

    // Attach date auto-format to dateInput (Ø¯ÙØªØ±Ú†Ù‡)
    attachDateAutoFormat(document.getElementById('dateInput'));
  }

  function initApp() {
    try {
      initDataFromStorage();
      wireMenuCards();
      initBindings();
      updateTopbar(); // immediate update
      updateUserActions();
      // ensure person select is populated from users
      loadPersonList();
      showMessage('âœ… Ø¨Ø±Ù†Ø§Ù…Ù‡ v11 Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª', 'var(--accent)', 2000);
      // expose some handy functions
      window.setupPorts = setupPorts;
      window.findTar12 = findTar12;
      window.findTar6 = findTar6;
      window.highlightPort = highlightPort;
      window.openNewReport = openNewReport;
    } catch (e) {
      console.error('initApp error', e);
    }
  }

  // run init when DOM ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initApp);
  } else {
    setTimeout(initApp, 0);
  }

  // for debugging: expose internal state (only in dev)
  window.__fibotic_state = { dataKey: DATA_KEY };
  // ØªØ§Ø¨Ø¹ Ø¬Ø¯ÙˆÙ„ Ù…Ø§ØªØ±ÛŒØ³ ÙÛŒÙˆÚ˜Ù†
  function renderFusionMatrixFromDescription(desc) {
    try {
      if (!desc || !desc.includes('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]')) return '';
      
      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø®Ø·ÙˆØ· Ù…Ø§ØªØ±ÛŒØ³
      const lines = desc.split('\n');
      const matrixLines = lines.filter(l => l.includes('Ù…Ø§ØªØ±ÛŒØ³'));
      
      if (matrixLines.length === 0) return '';
      
      let tableHtml = `
        <table style="width:100%;border-collapse:collapse;font-size:12px;margin:8px 0;background:#fff">
          <thead>
            <tr style="background:linear-gradient(90deg,#667eea,#764ba2);color:#fff">
              <th style="padding:6px;border:1px solid #ddd;text-align:center">Ù…Ø§ØªØ±ÛŒØ³</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">Ú©Ø§Ø¨Ù„ Û±</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">ØªØ§Ø± Û±</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">Ú©Ø§Ø¨Ù„ Û²</th>
              <th style="padding:6px;border:1px solid #ddd;text-align:center">ØªØ§Ø± Û²</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      matrixLines.forEach((line, idx) => {
        // Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§: "Ù…Ø§ØªØ±ÛŒØ³ N: Ú©Ø§Ø¨Ù„â€ŒÙ‡Ø§ [C1, C2] | ØªØ§Ø±Ù‡Ø§ [T1, T2]"
        const match = line.match(/Ù…Ø§ØªØ±ÛŒØ³ (\d+).*?\[([^\],]*),\s*([^\]]*)\].*?\[([^\],]*),\s*([^\]]*)\]/);
        if (match) {
          const matNum = match[1];
          const c1 = (match[2] || '-').trim();
          const t1 = (match[4] || '-').trim();
          const c2 = (match[3] || '-').trim();
          const t2 = (match[5] || '-').trim();
          
          tableHtml += `
            <tr style="background:${idx % 2 === 0 ? '#f8f9fb' : '#fff'}">
              <td style="padding:6px;border:1px solid #ddd;text-align:center;font-weight:700">${idx + 1}</td>
              <td style="padding:6px;border:1px solid #ddd;text-align:center">${escapeHtml(c1)}</td>
              <td style="padding:6px;border:1px solid #ddd;text-align:center">${escapeHtml(t1)}</td>
              <td style="padding:6px;border:1px solid #ddd;text-align:center">${escapeHtml(c2)}</td>
              <td style="padding:6px;border:1px solid #ddd;text-align:center">${escapeHtml(t2)}</td>
            </tr>
          `;
        }
      });
      
      tableHtml += `</tbody></table>`;
      return tableHtml;
    } catch (e) {
      console.error('renderFusionMatrixFromDescription error', e);
      return '';
    }
  }

  // ØªØ§Ø¨Ø¹ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…ØªÙ† Ø³Ø§Ø¯Ù‡ (Ø¨Ø¯ÙˆÙ† Ù‚Ø³Ù…Øª Ù…Ø§ØªØ±ÛŒØ³)
  function extractPlainDescription(desc) {
    try {
      if (!desc) return '';
      const parts = desc.split('ğŸ“Œ [Ú¯Ø²Ø§Ø±Ø´ ÙÛŒÙˆÚ˜Ù†]');
      return parts[0].trim();
    } catch (e) {
      return desc;
    }
  }

  window.renderFusionMatrixFromDescription = renderFusionMatrixFromDescription;
  window.extractPlainDescription = extractPlainDescription;
    /* ---------- Search Attendance ---------- */
  function searchAttendance() {
    try {
      const searchInput = document.getElementById('searchAttendance');
      if (!searchInput) return;

      const searchTerm = searchInput.value.trim().toLowerCase();
      const attendanceItems = document.querySelectorAll('#attendanceList .content-card');

      if (!searchTerm) {
        // Ø§Ú¯Ø± ÙÛŒÙ„Ø¯ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù‡Ù…Ù‡ Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
        attendanceItems.forEach(item => {
          item.style.display = 'block';
          item.style.borderLeft = 'none';
          item.style.paddingLeft = '10px';
        });
        return;
      }

      let foundCount = 0;
      const foundItems = [];

      attendanceItems.forEach((item, index) => {
        const text = item.textContent.toLowerCase();
        
        if (text.includes(searchTerm)) {
          foundItems.push({ item, index });
          foundCount++;
        }
      });

      // Ø§Ø¨ØªØ¯Ø§ Ù‡Ù…Ù‡ Ø±Ø§ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†
      attendanceItems.forEach(item => {
        item.style.display = 'none';
      });

      // ÙÙ‚Ø· ÛŒØ§ÙØªÚ¯Ø§Ù† Ø±Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¨Ø¯Ù‡
      foundItems.forEach(({ item }) => {
        item.style.display = 'block';
        item.style.borderLeft = '4px solid #667eea';
        item.style.paddingLeft = '10px';
        item.style.backgroundColor = '#f0f2ff';
        item.style.transition = 'all 0.3s ease';
      });

      // Ø§Ú¯Ø± ÛŒØ§ÙØªÚ¯Ø§Ù† Ù‡Ø³ØªÙ†Ø¯ØŒ Ø§ÙˆÙ„ÛŒ Ø±Ø§ Ø¨Ø§Ù„Ø§ Ø¨ÛŒØ§ÙˆØ±
      if (foundItems.length > 0) {
        foundItems[0].item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }

      // Ù¾ÛŒØ§Ù… ØªØ¹Ø¯Ø§Ø¯ Ù†ØªØ§ÛŒØ¬
      if (foundCount === 0) {
        showMessage('âš ï¸ Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', '#e74c3c');
      }

    } catch (e) {
      console.error('searchAttendance error', e);
    }
  }

   /* ---------- Search Attendance (Fixed) ---------- */
  function searchAttendance() {
    try {
      const searchInput = document.getElementById('searchAttendance');
      if (!searchInput) return;

      const searchTerm = searchInput.value.trim().toLowerCase();
      const attendanceContainer = document.getElementById('attendanceList');
      
      if (!attendanceContainer) return;

      const allRecords = (allData || [])
        .filter(i => i.type === 'attendance')
        .sort((a, b) => b.timestamp - a.timestamp);

      const role = localStorage.getItem('fibotic_role') || '';
      const logged = localStorage.getItem('fibotic_logged_in') || '';

      // ÙÛŒÙ„ØªØ± Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¯Ø³ØªØ±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±
      let visibleRecords = [];
      
      if (role === 'admin') {
        visibleRecords = allRecords;
      } else {
        const owner = logged || '';
        visibleRecords = allRecords.filter(r => (r.owner === owner) || (r.person_name === owner));
      }

      if (!searchTerm) {
        // Ø§Ú¯Ø± Ø¬Ø³ØªØ¬Ùˆ Ø®Ø§Ù„ÛŒ Ø§Ø³ØªØŒ Ù‡Ù…Ù‡ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ø´ÙˆØ¯
        renderAttendanceFiltered(visibleRecords, []);
        return;
      }

      // ÙÛŒÙ„ØªØ± Ú©Ø±Ø¯Ù† Ø¨Ø± Ø§Ø³Ø§Ø³ Ø¬Ø³ØªØ¬Ùˆ
      const filteredRecords = visibleRecords.filter(r => {
        const text = `
          ${r.person_name || ''} 
          ${r.owner || ''} 
          ${r.project_name || ''} 
          ${r.date || ''} 
          ${r.entry_time || ''} 
          ${r.exit_time || ''} 
          ${r.work_hours || ''} 
          ${r.work_description || ''}
        `.toLowerCase();
        
        return text.includes(searchTerm);
      });

      if (filteredRecords.length === 0) {
        showMessage('âš ï¸ Ø³Ø§Ø¨Ù‚Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯', '#e74c3c');
        attendanceContainer.innerHTML = '<div class="content-card" style="text-align:center;color:#e74c3c">âŒ Ù†ØªÛŒØ¬Ù‡â€ŒØ§ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</div>';
        return;
      }

      renderAttendanceFiltered(visibleRecords, filteredRecords);
      showMessage(`âœ… ${filteredRecords.length} Ø³Ø§Ø¨Ù‚Ù‡ ÛŒØ§ÙØª Ø´Ø¯`, '#27ae60');

    } catch (e) {
      console.error('searchAttendance error', e);
      showMessage('ï¿½ï¿½ï¿½ Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ', '#e74c3c');
    }
  }

  // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø³ÙˆØ§Ø¨Ù‚ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡
    // ØªØ§Ø¨Ø¹ Ù†Ù…Ø§ÛŒØ´ Ø³ÙˆØ§Ø¨Ù‚ ÙÛŒÙ„ØªØ± Ø´Ø¯Ù‡ (Ø¨Ø§ Ù…Ø§ØªØ±ÛŒØ³ Ø¬Ø¯ÙˆÙ„)
  function renderAttendanceFiltered(allRecords, filteredRecords) {
    try {
      const c = document.getElementById('attendanceList');
      if (!c) return;

      const displayRecords = filteredRecords.length > 0 ? filteredRecords : allRecords;

      if (displayRecords.length === 0) {
        c.innerHTML = '<div class="content-card">â° Ù‡ÛŒÚ† Ø±Ú©ÙˆØ±Ø¯ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>';
        return;
      }

      const role = localStorage.getItem('fibotic_role') || '';
      const logged = localStorage.getItem('fibotic_logged_in') || '';

      const htmlParts = displayRecords.map(r => {
        const isApproved = !!r.sharedApproved;
        const outerClass = isApproved ? 'approved-record' : '';
        const editDisabledAttr = isApproved ? 'disabled' : '';
        const deleteDisabledAttr = isApproved ? 'disabled' : '';
        
        return `<div class="content-card ${outerClass}" style="opacity:${filteredRecords.includes(r) ? '1' : '0.5'};transition:all 0.3s">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(r.person_name || r.owner || '')} ${r.project_name ? `â€” ${escapeHtml(r.project_name)}` : ''}</div>
            <div style="display:flex;gap:8px">
              <button class="smallBtn" ${editDisabledAttr} onclick="editAttendance('${r.__backendId}')">âœï¸</button>
              <button class="smallBtn" ${deleteDisabledAttr} onclick="deleteAttendance('${r.__backendId}')">ğŸ—‘ï¸</button>
            </div>
          </div>
          <div style="margin-top:8px;background:#f8f9fb;padding:8px;border-radius:8px">
            <div>ğŸ“… ${r.date || ''}</div>
            <div style="display:flex;gap:12px;margin-top:6px"><div>ğŸŸ¢ ${r.entry_time || ''}</div><div>ğŸ”´ ${r.exit_time || ''}</div><div>â±ï¸ ${r.work_hours || ''}</div></div>
            ${r.work_description ? `
              <div style="margin-top:8px;border-top:1px solid #ddd;padding-top:8px">
                <div style="font-weight:700;color:#667eea;font-size:13px;margin-bottom:6px">ğŸ“‹ ØªÙˆØ¶ÛŒØ­Ø§Øª Ùˆ Ù…Ø§ØªØ±ÛŒØ³â€ŒÙ‡Ø§:</div>
                ${renderFusionMatrixFromDescription(r.work_description)}
                ${extractPlainDescription(r.work_description).trim() ? `
                  <div style="margin-top:8px;color:#556;font-size:13px;white-space:pre-wrap">${escapeHtml(extractPlainDescription(r.work_description))}</div>
                ` : ''}
              </div>
            ` : ''}
            ${r.shared ? `<div style="margin-top:8px;color:#996">ğŸ” Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø§Ø´ØªØ±Ø§Ú© Ø¨Ø§ Ù…Ø¯ÛŒØ± ${r.sharedApproved ? '(ØªØ£ÛŒÛŒØ¯ Ø´Ø¯Ù‡)' : '(Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯)'}</div>` : ''}
          </div>
        </div>`;
      });

      c.innerHTML = htmlParts.join('');
    } catch (e) {
      console.error('renderAttendanceFiltered error', e);
    }
  }

  function clearSearchAttendance() {
    try {
      const searchInput = document.getElementById('searchAttendance');
      if (searchInput) {
        searchInput.value = '';
        searchAttendance();
        showMessage('âœ… Ø¬Ø³ØªØ¬Ùˆ Ù¾Ø§Ú© Ø´Ø¯', 'var(--accent)');
      }
    } catch (e) {
      console.error('clearSearchAttendance error', e);
    }
  }

  window.searchAttendance = searchAttendance;
  window.clearSearchAttendance = clearSearchAttendance;
  window.renderAttendanceFiltered = renderAttendanceFiltered;
    // Handle Enter key in search
  function handleSearchEnter(event) {
    try {
      if (event.key === 'Enter') {
        event.preventDefault();
        event.target.blur(); // Ø¨Ø³ØªÙ† Ú©ÛŒØ¨ÙˆØ±Ø¯
        searchAttendance(); // Ø§Ø¬Ø±Ø§ÛŒ Ø¬Ø³ØªØ¬Ùˆ
      }
    } catch (e) {
      console.error('handleSearchEnter error', e);
    }
  }

  window.handleSearchEnter = handleSearchEnter;
  // Handle back button of mobile device
window.addEventListener('popstate', function() {
  const currentPage = document.querySelector('.inner-page.active');
  if (currentPage) {
    goHome();
  } else {
    // Ø§Ú¯Ø± Ø±ÙˆÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ Ù‡Ø³ØªÛŒØ¯ØŒ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯
    if (confirm('Ø¢ÛŒØ§ Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø±Ø§ Ø¨Ø¨Ù†Ø¯ÛŒØ¯ØŸ')) {
      // Ø§Ú¯Ø± Ù…ÛŒâ€ŒØ®ÙˆØ§Ù‡ÛŒØ¯ Ú©Ù„ Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø¨Ø³ØªÙ‡ Ø´ÙˆØ¯
      window.history.back();
    }
  }
});

// Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† history Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª
window.addEventListener('load', function() {
  window.history.pushState({page: 'home'}, null);
});

// Ø²Ù…Ø§Ù†ÛŒ Ú©Ù‡ ØµÙØ­Ù‡ Ø¹ÙˆØ¶ Ù…ÛŒâ€ŒØ´ÙˆØ¯
const originalOpenPage = window.openPage;
window.openPage = function(id) {
  window.history.pushState({page: id}, null);
  originalOpenPage(id);
};
})(); // end IIFE

// Û±. ØªØ¹Ø±ÛŒÙ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ (Ø­ØªÙ…Ø§ Ø¯Ø± Ø§Ø¨ØªØ¯Ø§ÛŒ Ø§Ø³Ú©Ø±ÛŒÙ¾Øª Ø¨Ø§Ø´Ø¯)
function getAdminCredentials() {
  try {
    const stored = JSON.parse(localStorage.getItem('fibotic_admin_creds') || '{}');
    return {
      user: stored.user || "admin",
      pass: stored.pass || "1234"
    };
  } catch (e) {
    return { user: "admin", pass: "1234" };
  }
}

function setAdminCredentials(user, pass) {
  try {
    localStorage.setItem('fibotic_admin_creds', JSON.stringify({ user: user, pass: pass }));
    return true;
  } catch (e) {
    console.error('setAdminCredentials error', e);
    return false;
  }
}

// Ø¨Ø±Ø§ÛŒ Ø³Ø§Ø²Ú¯Ø§Ø±ÛŒ Ø¨Ø§ Ú©Ø¯ Ù‚Ø¯ÛŒÙ…ÛŒ
Object.defineProperty(window, 'ADMIN_USER', {
  get: function() { return getAdminCredentials().user; }
});
Object.defineProperty(window, 'ADMIN_PASS', {
  get: function() { return getAdminCredentials().pass; }
});

// ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯
function login() {
    try {
        var u = document.getElementById('loginUser').value.trim();
        var p = document.getElementById('loginPass').value.trim();

        if (!u || !p) {
            alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }

        // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ±ÙˆØ¯ Ù…Ø¯ÛŒØ±
        if (u === ADMIN_USER && p === ADMIN_PASS) {
            localStorage.setItem('fibotic_logged_in', 'admin');
            localStorage.setItem('fibotic_role', 'admin');
            finishLogin();
            if (typeof showAdminTab === "function") showAdminTab(true);
            return;
        }

        // Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¹Ø§Ø¯ÛŒ
        var users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
        if (users[u] && users[u].password === p) {
            var now = Date.now();
            if (now > users[u].expiry) {
                alert('âŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø­Ø³Ø§Ø¨ Ø´Ù…Ø§ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.');
            } else {
                localStorage.setItem('fibotic_logged_in', u);
                localStorage.setItem('fibotic_role', 'user');
                finishLogin();
                if (typeof showAdminTab === "function") showAdminTab(false);
            }
        } else {
            alert('âŒ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ ÛŒØ§ Ø±Ù…Ø² Ø§Ø´ØªØ¨Ø§Ù‡ Ø§Ø³Øª.');
        }
    } catch (e) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± ØªØ§Ø¨Ø¹ ÙˆØ±ÙˆØ¯:", e);
        alert("Ù…Ø´Ú©Ù„ÛŒ Ø¯Ø± Ø§Ø¬Ø±Ø§ÛŒ Ú©Ø¯ Ù¾ÛŒØ´ Ø¢Ù…Ø¯. Ú©Ù†Ø³ÙˆÙ„ Ù…Ø±ÙˆØ±Ú¯Ø± Ø±Ø§ Ú†Ú© Ú©Ù†ÛŒØ¯.");
    }
}

// Û³. ØªØ§Ø¨Ø¹ Ø¨Ø³ØªÙ† ØµÙØ­Ù‡ ÙˆØ±ÙˆØ¯
function finishLogin() {
    var loginPage = document.getElementById('loginPage');
    if (loginPage) {
        loginPage.style.display = 'none';
    }
    // show/hide admin menu depending on role
    var role = localStorage.getItem('fibotic_role');
    var adminMenu = document.getElementById('adminMenuCard');
    if (adminMenu) adminMenu.style.display = (role === 'admin') ? 'flex' : 'none';
    var accMenu = document.getElementById('accountingMenuCard');
    if (accMenu) accMenu.style.display = (role === 'admin') ? 'flex' : 'none';
    // show home
    try { document.getElementById('homePage').style.display = 'block'; } catch (e) {}
    // update topbar actions
    if (typeof updateUserActions === 'function') updateUserActions();
    // refresh person select so new users appear immediately
    if (typeof loadPersonList === 'function') loadPersonList();
}

// Û´. Ù…Ø¯ÛŒØ±ÛŒØª Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª
function showAdminTab(show) {
    var adminMenu = document.getElementById('adminMenuCard');
    if (adminMenu) {
        adminMenu.style.display = show ? 'flex' : 'none';
    }
    var accMenu = document.getElementById('accountingMenuCard');
    if (accMenu) {
        accMenu.style.display = show ? 'flex' : 'none';
    }
    if (show) {
      setTimeout(function(){ openPage('admin'); }, 120);
      refreshUserList();
    }
}

// ØªØ§Ø¨Ø¹ Ø±ÙØ±Ø´ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
function refreshUserList() {
    try {
        var users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
        var tbody = document.getElementById('userTableBody');
        if (!tbody) return;
        tbody.innerHTML = '';
        Object.keys(users).forEach(function(user){
            var tr = document.createElement('tr');
            tr.innerHTML = '<td style="padding:8px;border:1px solid #ddd;">'+ escapeHtml(user) +'</td>'
                         + '<td style="padding:8px;border:1px solid #ddd;">'+ 'â€¢'.repeat(6) +'</td>'
                         + '<td style="padding:8px;border:1px solid #ddd;">'+ (new Date(users[user].expiry)).toLocaleDateString('fa-IR') +'</td>'
                         + '<td style="padding:8px;border:1px solid #ddd;"><button class="smallBtn" data-user="'+ encodeURIComponent(user) +'">Ø­Ø°Ù</button></td>';
            tbody.appendChild(tr);
        });
        // attach delete handlers
        tbody.querySelectorAll('button[data-user]').forEach(function(btn){
            btn.addEventListener('click', function(){
                var u = decodeURIComponent(btn.dataset.user);
                if (!confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø± ' + u + ' Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) return;
                deleteUser(u);
            });
        });
    } catch (e) {
        console.error('refreshUserList error', e);
    }
}

// create user from admin panel
function adminCreateUser() {
    try {
        var username = (document.getElementById('newUserName')?.value || '').trim();
        var password = (document.getElementById('newUserPass')?.value || '').trim();
        var days = parseInt(document.getElementById('newUserDays')?.value || '0', 10);
        if (!username || !password || !days || days <= 0) {
            alert('Ù„Ø·ÙØ§Ù‹ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒØŒ Ø±Ù…Ø² Ùˆ ØªØ¹Ø¯Ø§Ø¯ Ø±ÙˆØ² Ø§Ø¹ØªØ¨Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
            return;
        }
        var users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
        if (users[username]) {
            alert('Ø§ÛŒÙ† Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù‚Ø¨Ù„Ø§Ù‹ ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯');
            return;
        }
        var expiry = Date.now() + (days * 24 * 3600 * 1000);
        users[username] = { password: password, expiry: expiry };
        localStorage.setItem('fibotic_users_v2', JSON.stringify(users));
        // refresh UI
        refreshUserList();
        // clear inputs
        document.getElementById('newUserName').value = '';
        document.getElementById('newUserPass').value = '';
        document.getElementById('newUserDays').value = '';
        // refresh person select for everyone
        if (typeof loadPersonList === 'function') loadPersonList();
        // feedback
        if (typeof showMessage === 'function') showMessage('âœ… Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙØ¹Ø§Ù„ Ø´Ø¯', '#27ae60');
        else alert('Ú©Ø§Ø±Ø¨Ø± Ø§ÛŒØ¬Ø§Ø¯ Ùˆ ÙØ¹Ø§Ù„ Ø´Ø¯');
    } catch (e) {
        console.error('adminCreateUser error', e);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± - Ú©Ù†Ø³ÙˆÙ„ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯');
    }
}
window.adminCreateUser = adminCreateUser;

// delete user helper
function deleteUser(username) {
    try {
        var users = JSON.parse(localStorage.getItem('fibotic_users_v2') || '{}');
        if (users[username]) {
            delete users[username];
            localStorage.setItem('fibotic_users_v2', JSON.stringify(users));
            refreshUserList();
            if (typeof loadPersonList === 'function') loadPersonList();
            if (typeof showMessage === 'function') showMessage('âœ… Ú©Ø§Ø±Ø¨Ø± Ø­Ø°Ù Ø´Ø¯', '#27ae60');
        }
    } catch (e) {
        console.error('deleteUser error', e);
        alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ú©Ø§Ø±Ø¨Ø±');
    }
}

// ADD: toggle password visibility + Enter-to-login binding
function togglePassword() {
  try {
    var p = document.getElementById('loginPass');
    var btn = document.getElementById('togglePassBtn');
    if (!p || !btn) return;
    if (p.type === 'password') {
      p.type = 'text';
      btn.textContent = 'ğŸ™ˆ Ù¾Ù†Ù‡Ø§Ù† Ú©Ù†';
    } else {
      p.type = 'password';
      btn.textContent = 'ğŸ‘ï¸ Ù†Ù…Ø§ÛŒØ´/Ù…Ø®ÙÛŒ Ú©Ø±Ø¯Ù† Ø±Ù…Ø²';
    }
  } catch (e) {
    console.error('togglePassword error', e);
  }
}

// bind Enter key in password field to call login()
(function bindLoginEnter() {
  try {
    var pw = document.getElementById('loginPass');
    if (!pw) return;
    pw.addEventListener('keydown', function (e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (typeof login === 'function') login();
      }
    });
  } catch (e) {
    console.error('bindLoginEnter error', e);
  }
})();


// on load: if already logged in, hide login overlay and show admin menu if needed
(function resumeLoginState() {
  try {
    var role = localStorage.getItem('fibotic_role');
    var logged = localStorage.getItem('fibotic_logged_in');
    var loginPage = document.getElementById('loginPage');
    if (role) {
      if (loginPage) loginPage.style.display = 'none';
      var adminMenu = document.getElementById('adminMenuCard');
      if (adminMenu) adminMenu.style.display = (role === 'admin') ? 'flex' : 'none';
      var accMenu = document.getElementById('accountingMenuCard');
      if (accMenu) accMenu.style.display = (role === 'admin') ? 'flex' : 'none';
      if (role === 'admin') {
        setTimeout(refreshUserList, 200);
      }
    }
    // update topbar actions on resume
    if (typeof updateUserActions === 'function') updateUserActions();
    // ensure person select is populated
    if (typeof loadPersonList === 'function') loadPersonList();
  } catch (e) {}
})();
</script>

<!-- ========================= -->
<!-- NEW: Merge (non-destructive) Restore Implementation & UI wiring -->
<!-- This script adds a "Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ (Ø§Ø¯ØºØ§Ù…ÛŒ Ø¨Ø¯ÙˆÙ† Ø­Ø°Ù)" option in settings and a merge restore handler.
     It does NOT delete existing data â€” it only adds missing items and merges keys non-destructively.
-->
<script>
(function(){
  'use strict';

  const APP_DATA_KEY = 'fibotic_app_v11';

  function isObject(v){ return v && typeof v === 'object' && !Array.isArray(v); }

  // Merge objects without deleting existing properties. Existing values take precedence.
  function mergeObjectsNoDelete(target, src){
    if (!isObject(src)) return target;
    if (!isObject(target)) target = {};
    Object.keys(src).forEach(k => {
      if (isObject(src[k])){
        target[k] = mergeObjectsNoDelete(target[k] || {}, src[k]);
      } else if (Array.isArray(src[k])){
        if (!Array.isArray(target[k])) target[k] = [];
        const seen = new Set(target[k].map(it => JSON.stringify(it)));
        src[k].forEach(it => { const s = JSON.stringify(it); if (!seen.has(s)){ target[k].push(it); seen.add(s); }});
      } else {
        // primitive: only set if not present or empty
        if (typeof target[k] === 'undefined' || target[k] === null || target[k] === '') {
          target[k] = src[k];
        }
      }
    });
    return target;
  }

  // Merge main app array by __backendId; don't overwrite existing items.
  function mergeMainArray(existingArr, backupArr){
    existingArr = Array.isArray(existingArr) ? existingArr.slice() : [];
    const ids = new Set(existingArr.filter(it => it && it.__backendId).map(it => it.__backendId));
    for (const item of (backupArr || [])){
      if (!item || typeof item !== 'object') continue;
      if (item.__backendId){
        if (!ids.has(item.__backendId)){
          existingArr.push(item);
          ids.add(item.__backendId);
        } else {
          // id exists: do not overwrite. Optionally merge fields here (skipped to remain non-destructive).
        }
      } else {
        // assign new local id and push
        item.__backendId = 'local-restore-' + Date.now() + '-' + Math.random().toString(36).slice(2,8);
        existingArr.push(item);
      }
    }
    return existingArr;
  }

  // Generic merge for other localStorage keys
  function mergeLocalKey(existingVal, backupVal){
    try {
      if (Array.isArray(existingVal) && Array.isArray(backupVal)){
        const seen = new Set(existingVal.map(it => JSON.stringify(it)));
        const out = existingVal.slice();
        backupVal.forEach(it => { const s = JSON.stringify(it); if (!seen.has(s)){ out.push(it); seen.add(s); }});
        return out;
      }
      if (isObject(existingVal) && isObject(backupVal)){
        return mergeObjectsNoDelete(existingVal, backupVal);
      }
      return (typeof existingVal === 'undefined' || existingVal === null || existingVal === '') ? backupVal : existingVal;
    } catch (e) { return existingVal; }
  }

  // Read file and return parsed JSON or throw
  function readFileAsJson(file){
    return new Promise((res, rej) => {
      const fr = new FileReader();
      fr.onload = () => {
        try { res(JSON.parse(fr.result)); } catch (e) { rej(e); }
      };
      fr.onerror = () => rej(fr.error || new Error('read error'));
      fr.readAsText(file, 'utf-8');
    });
  }

  // The merge restore handler (attached to the settings restore input)
  async function mergeRestoreFromFileEvent(ev){
    try {
      const file = ev && ev.target && ev.target.files && ev.target.files[0];
      if (!file){
        if (typeof showMessage === 'function') showMessage('âš ï¸ ÙØ§ÛŒÙ„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡', '#e74c3c');
        return;
      }
      let parsed;
      try { parsed = await readFileAsJson(file); } catch (e) {
        console.error('parse error', e);
        if (typeof showMessage === 'function') showMessage('âŒ ÙØ±Ù…Øª ÙØ§ÛŒÙ„ Ù†Ø§Ù…Ø¹ØªØ¨Ø± Ø§Ø³Øª', '#e74c3c');
        ev.target.value = '';
        return;
      }

      // confirm with user explaining non-destructive behavior
      if (!confirm('Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø¯ØºØ§Ù…ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒâ€ŒØ´ÙˆØ¯Ø› Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ¹Ù„ÛŒ Ø­Ø°Ù Ù†Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ Ùˆ Ø±Ú©ÙˆØ±Ø¯Ù‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø§Ø² ÙØ§ÛŒÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯. Ø§Ø¯Ø§Ù…Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡ÛŒØ¯ØŸ')) {
        ev.target.value = '';
        return;
      }

      // start merging
      if (Array.isArray(parsed)){
        // treat as main data array
        const existing = JSON.parse(localStorage.getItem(APP_DATA_KEY) || '[]');
        const merged = mergeMainArray(existing, parsed);
        localStorage.setItem(APP_DATA_KEY, JSON.stringify(merged));
      } else if (isObject(parsed) && parsed.keys){
        // exportObj.keys structure
        for (const k of Object.keys(parsed.keys)){
          try {
            const backupVal = parsed.keys[k];
            const existingRaw = localStorage.getItem(k);
            let existingVal;
            try { existingVal = existingRaw ? JSON.parse(existingRaw) : undefined; } catch (e){ existingVal = existingRaw; }
            if (k === APP_DATA_KEY){
              const merged = mergeMainArray(existingVal || [], Array.isArray(backupVal) ? backupVal : []);
              localStorage.setItem(k, JSON.stringify(merged));
              continue;
            }
            const mergedVal = mergeLocalKey(existingVal, backupVal);
            try { localStorage.setItem(k, JSON.stringify(mergedVal)); } catch (e) { localStorage.setItem(k, mergedVal); }
          } catch (inner) { console.warn('merge key error', k, inner); }
        }
      } else {
        // fallback: if parsed contains APP_DATA_KEY array
        if (parsed[APP_DATA_KEY] && Array.isArray(parsed[APP_DATA_KEY])){
          const existing = JSON.parse(localStorage.getItem(APP_DATA_KEY) || '[]');
          const merged = mergeMainArray(existing, parsed[APP_DATA_KEY]);
          localStorage.setItem(APP_DATA_KEY, JSON.stringify(merged));
        } else {
          // merge top-level keys into localStorage
          Object.keys(parsed).forEach(k => {
            try {
              const backupVal = parsed[k];
              const existingRaw = localStorage.getItem(k);
              let existingVal;
              try { existingVal = existingRaw ? JSON.parse(existingRaw) : undefined; } catch (e){ existingVal = existingRaw; }
              const mergedVal = mergeLocalKey(existingVal, backupVal);
              try { localStorage.setItem(k, JSON.stringify(mergedVal)); } catch (e) { localStorage.setItem(k, mergedVal); }
            } catch (er) { console.warn('fallback merge key', k, er); }
          });
        }
      }

      // refresh in-memory data
      if (typeof initDataFromStorage === 'function'){
        try { initDataFromStorage(); } catch (e) { console.warn('initDataFromStorage failed', e); }
      } else if (typeof dataHandler !== 'undefined' && dataHandler && typeof dataHandler.onDataChanged === 'function'){
        try { dataHandler.onDataChanged(JSON.parse(localStorage.getItem(APP_DATA_KEY) || '[]')); } catch (e) { console.warn(e); }
      }

      if (typeof showMessage === 'function') showMessage('âœ… Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ Ø§Ø¯ØºØ§Ù…ÛŒ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', '#27ae60');
      try { ev.target.value = ''; } catch (e){}
      // if there is an admin backup info UI, update it (fn exists in original file)
      try { if (typeof updateAdminBackupInfo === 'function') updateAdminBackupInfo(); } catch(e){}
    } catch (err) {
      console.error('mergeRestoreFromFileEvent error', err);
      if (typeof showMessage === 'function') showMessage('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ', '#e74c3c');
      try { ev.target.value = ''; } catch (e){}
    }
  }

  // Wire UI: show merge restore button for admin, and hook file input
  function wireMergeRestoreUI(){
    const mergeBtn =   document.getElementById('btn-price').onclick = () => showPriceForm();
  document.getElementById('btn-income').onclick = () => openIncomeModal();
  document.getElementById('btn-backup').onclick = () => downloadBackup();
  document.getElementById('btn-merge-restore').onclick = () => {
    document.getElementById('btn-merge-restore');
    const mergeInput = document.getElementById('mergeRestoreFile');
    if (!mergeBtn || !mergeInput) return;

    // Make the restore button visible to everyone (same style as backup)
    mergeBtn.style.display = '';

    // Open file chooser when clicking the visible restore button
    mergeBtn.onclick = function () {
      try { mergeInput.click(); } catch (e) { console.error('mergeBtn click error', e); }
    };

    // Attach the merge-restore handler (non-destructive)
    // ensure we don't attach multiple listeners if function called more than once
    mergeInput.removeEventListener('change', mergeRestoreFromFileEvent);
    mergeInput.addEventListener('change', mergeRestoreFromFileEvent);
  }

  // Observe storage changes (login/logout) to toggle visibility of merge restore button
  function observeAuthForMergeUI(){
    wireMergeRestoreUI();
    window.addEventListener('storage', () => {
      try { wireMergeRestoreUI(); } catch (e){}
    });
    document.addEventListener('DOMContentLoaded', () => {
      try { wireMergeRestoreUI(); } catch(e){}
    });
    // also run shortly after load in case role set after init
    setTimeout(() => { try { wireMergeRestoreUI(); } catch(e){} }, 300);
  }

  // initialize
  observeAuthForMergeUI();

  // Expose function on window for manual calls if needed
  window.mergeRestoreFromFileEvent = mergeRestoreFromFileEvent;

// Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡
(function wireAdminCredsButton() {
  try {
    const btn = document.getElementById('btn-change-admin-creds');
    if (btn) {
      btn.removeEventListener('click', changeAdminCredentials);
      btn.addEventListener('click', changeAdminCredentials);
    }
  } catch (e) { console.error('wireAdminCredsButton error', e); }
})();

window.addEventListener('popstate', function() {
    goHome();
})();

// ===== ØªØºÛŒÛŒØ± Ø±Ù…Ø² Ù…Ø¯ÛŒØ±ÛŒØª - Ú©Ø¯ ØªØµØ­ÛŒØ­ Ø´Ø¯Ù‡ =====

function changeAdminCredentials() {
  try {
    const newUser = (document.getElementById('newAdminUser')?.value || '').trim();
    const newPass = (document.getElementById('newAdminPass')?.value || '').trim();
    const statusEl = document.getElementById('adminCredsStatus');
    
    console.log('ğŸ” ØªØ§Ø¨Ø¹ changeAdminCredentials Ø§Ø¬Ø±Ø§ Ø´Ø¯'); // Ø¨Ø±Ø§ÛŒ Ø¨Ø±Ø±Ø³ÛŒ
    
    if (!statusEl) {
      console.error('âŒ adminCredsStatus element not found');
      alert('âŒ Ø¹Ù†ØµØ± ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
      return;
    }
    
    // Ø¨Ø±Ø±Ø³ÛŒ Ø®Ø§Ù„ÛŒ Ø¨ÙˆØ¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
    if (!newUser || !newPass) {
      statusEl.innerHTML = '<span style="color:#fff">âš ï¸ Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ùˆ Ø±Ù…Ø² Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</span>';
      console.warn('âš ï¸ ÙÛŒÙ„Ø¯Ù‡Ø§ Ø®Ø§Ù„ÛŒ Ù‡Ø³ØªÙ†Ø¯');
      return;
    }

    // Ø¨Ø±Ø±Ø³ÛŒ Ø·ÙˆÙ„ Ø±Ù…Ø²
    if (newPass.length < 4) {
      statusEl.innerHTML = '<span style="color:#fff">âš ï¸ Ø±Ù…Ø² Ø¨Ø§ÛŒØ¯ Ø­Ø¯Ø§Ù‚Ù„ 4 Ú©Ø§Ø±Ø§Ú©ØªØ± Ø¨Ø§Ø´Ø¯</span>';
      return;
    }

    // Ø¨Ø±Ø±Ø³ÛŒ ØªØ£ÛŒÛŒØ¯
    const confirmMsg = `Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ\n\nÙ†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø¬Ø¯ÛŒØ¯: ${newUser}\nØ±Ù…Ø² Ø¬Ø¯ÛŒØ¯: ${newPass}\n\nâš ï¸ Ø¨Ø¹Ø¯ Ø§Ø² Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø¨Ø§ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯!`;
    if (!confirm(confirmMsg)) {
      console.log('âŒ Ú©Ø§Ø±Ø¨Ø± Ø§Ù†ØµØ±Ø§Ù Ø¯Ø§Ø¯');
      return;
    }

    // Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯
    console.log('ğŸ’¾ Ø°Ø®ÛŒØ±Ù‡ Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯...');
    if (setAdminCredentials(newUser, newPass)) {
      console.log('âœ… Ø±Ù…Ø² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯');
      statusEl.innerHTML = '<span style="color:#fff;font-weight:700">âœ… Ø±Ù…Ø² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª ØªØºÛŒÛŒØ± Ú©Ø±Ø¯! Ù„Ø·ÙØ§Ù‹ ØµÙØ­Ù‡ Ø±Ø§ ØªØ§Ø²Ù‡ Ú©Ù†ÛŒØ¯</span>';
      
      // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙÛŒÙ„Ø¯Ù‡Ø§
      document.getElementById('newAdminUser').value = '';
      document.getElementById('newAdminPass').value = '';

      // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
      if (typeof showMessage === 'function') {
        showMessage('âœ… Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯', '#27ae60');
      }

      // Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡ØŒ ØµÙØ­Ù‡ Ø±Ø§ ØªØ§Ø²Ù‡ Ú©Ù†
      setTimeout(() => {
        console.log('ğŸ”„ ØµÙØ­Ù‡ ØªØ§Ø²Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...');
        location.reload();
      }, 3000);
    } else {
      console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± setAdminCredentials');
      statusEl.innerHTML = '<span style="color:#fff">âŒ Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡</span>';
    }
  } catch (e) {
    console.error('âŒ changeAdminCredentials error:', e);
    const statusEl = document.getElementById('adminCredsStatus');
    if (statusEl) {
      statusEl.innerHTML = '<span style="color:#fff">âŒ Ø®Ø·Ø§: ' + e.message + '</span>';
    }
  }
}

// Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ - Ø±ÙˆØ´ Ø¨Ù‡Ø¨ÙˆØ¯ Ø´Ø¯Ù‡
function wireAdminCredsBtn() {
  console.log('ğŸ”— Ø³Ø¹ÛŒ Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡...');
  const btn = document.getElementById('btn-change-admin-creds');
  
  if (!btn) {
    console.warn('âš ï¸ Ø¯Ú©Ù…Ù‡ btn-change-admin-creds Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    return;
  }

  // Ø­Ø°Ù ØªÙ…Ø§Ù… listeners Ù‚Ø¯ÛŒÙ…ÛŒ
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);

  // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† listener Ø¬Ø¯ÛŒØ¯
  newBtn.addEventListener('click', function(e) {
    e.preventDefault();
    console.log('ğŸ–±ï¸ Ø¯Ú©Ù…Ù‡ Ú©Ù„ÛŒÚ© Ø´Ø¯');
    changeAdminCredentials();
  });

  console.log('âœ… Ø¯Ú©Ù…Ù‡ Ø§ØªØµØ§Ù„ ÛŒØ§ÙØª Ùˆ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª');
}

// Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡ Ø¯Ø± Ø²Ù…Ø§Ù†â€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', wireAdminCredsBtn);
} else {
  wireAdminCredsBtn();
}

// Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯ Ø¨Ø¹Ø¯ Ø§Ø² 1 Ø«Ø§Ù†ÛŒÙ‡
setTimeout(wireAdminCredsBtn, 1000);

// Expose Ø±ÙˆÛŒ window Ø¨Ø±Ø§ÛŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø§Ø² Ú©Ù†Ø³ÙˆÙ„
window.changeAdminCredentials = changeAdminCredentials;
window.wireAdminCredsBtn = wireAdminCredsBtn;
</script>

<!-- End of added merge-restore script -->
<!-- ========================= -->

<!-- existing additional scripts were present in your file; they remain unchanged.
     The new merge-restore handler is wired to:
     - settings button with id="btn-merge-restore" (visible to admin logged in)
     - hidden input id="mergeRestoreFile"
     You can click the "ğŸ“‚ Ø¨Ø§Ø²Ú¯Ø±Ø¯Ø§Ù†ÛŒ (Ø§Ø¯ØºØ§Ù…ÛŒ)" button in settings,
     choose a JSON backup file and confirm to perform a non-destructive merge restore.
-->

<script>
// ===== ØªØºÛŒÛŒØ± Ø±Ù…Ø² - Ú©Ø¯ Ø³Ø§Ø¯Ù‡ =====

function changeAdminCredentials() {
  const newUser = document.getElementById('newAdminUser').value.trim();
  const newPass = document.getElementById('newAdminPass').value.trim();
  const statusEl = document.getElementById('adminCredsStatus');
  
  if (!newUser || !newPass) {
    statusEl.innerHTML = '<span style="color:#fff">âš ï¸ Ù‡Ø± Ø¯Ùˆ ÙÛŒÙ„Ø¯ Ø§Ù„Ø²Ø§Ù…ÛŒ Ø§Ø³Øª</span>';
    return;
  }

  if (!confirm('Ø±Ù…Ø² Ø¬Ø¯ÛŒØ¯: ' + newUser + ' / ' + newPass + '\n\nØªØ£ÛŒÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯ØŸ')) {
    return;
  }

  // Ø°Ø®ÛŒØ±Ù‡
  localStorage.setItem('fibotic_admin_creds', JSON.stringify({
    user: newUser,
    pass: newPass
  }));

  statusEl.innerHTML = '<span style="color:#fff;font-weight:bold;">âœ… Ø±Ù…Ø² Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯!</span>';
  document.getElementById('newAdminUser').value = '';
  document.getElementById('newAdminPass').value = '';

  alert('âœ… Ø±Ù…Ø² ØªØºÛŒÛŒØ± Ú©Ø±Ø¯!\n\nÙ„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ÙˆØ§Ø±Ø¯ Ø´ÙˆÛŒØ¯.');
  
  setTimeout(() => {
    location.reload();
  }, 2000);
}

// Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡
document.addEventListener('DOMContentLoaded', function() {
  const btn = document.getElementById('btn-change-admin-creds');
  if (btn) {
    btn.onclick = function(e) {
      e.preventDefault();
      changeAdminCredentials();
    };
  }
});

// Ø§ØªØµØ§Ù„ Ù…Ø¬Ø¯Ø¯
setTimeout(() => {
  const btn = document.getElementById('btn-change-admin-creds');
  if (btn) {
    btn.onclick = changeAdminCredentials;
  }
}, 500);

</script>
</body>
</html>